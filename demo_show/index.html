<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MeetMind · 视界 - 会议认知同频平台</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Outfit:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Aurora 主题 - 深邃夜空 */
      --bg-deep: #0a0e1a;
      --bg-primary: #0f1629;
      --bg-secondary: #151d35;
      --bg-card: rgba(22, 32, 60, 0.6);
      --bg-card-solid: #16203c;
      --bg-elevated: rgba(30, 45, 80, 0.5);
      --bg-glass: rgba(255, 255, 255, 0.03);
      
      /* 文字色 */
      --text-primary: #f0f4ff;
      --text-secondary: #8b9cc7;
      --text-muted: #4a5578;
      
      /* 极光色彩 */
      --aurora-cyan: #00d4ff;
      --aurora-mint: #00ffc8;
      --aurora-purple: #a855f7;
      --aurora-pink: #ff6b9d;
      --aurora-blue: #3b82f6;
      
      /* 功能色 */
      --color-recording: #ff4d6a;
      --color-recording-glow: rgba(255, 77, 106, 0.3);
      --color-success: #00ffc8;
      --color-warning: #fbbf24;
      --color-info: #00d4ff;
      --color-error: #ff4d6a;
      
      /* 洞察类型色 */
      --color-inner-os: #00d4ff;
      --color-brainstorm: #fbbf24;
      --color-stop-talking: #ff6b9d;
      --color-auto-analysis: #00ffc8;
      
      /* 高亮 */
      --highlight-glow: rgba(0, 212, 255, 0.15);
      --highlight-text: #00d4ff;
      
      /* 边框 */
      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-medium: rgba(255, 255, 255, 0.1);
      --border-glow: rgba(0, 212, 255, 0.3);
      
      /* 阴影 */
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.6);
      --shadow-glow: 0 0 60px rgba(0, 212, 255, 0.15);
      --shadow-glow-pink: 0 0 40px rgba(255, 107, 157, 0.1);
      
      /* 圆角 */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;
      
      /* 动画 */
      --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
      --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
      --duration-fast: 150ms;
      --duration-normal: 300ms;
      --duration-slow: 500ms;
      
      /* 字体 */
      --font-display: 'Space Grotesk', system-ui, sans-serif;
      --font-body: 'Outfit', system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    
    body {
      font-family: var(--font-body);
      background: var(--bg-deep);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
      min-height: 100vh;
    }

    /* 极光背景效果 */
    .aurora-bg {
      position: fixed;
      inset: 0;
      overflow: hidden;
      z-index: 0;
      background: 
        radial-gradient(ellipse 80% 50% at 20% 40%, rgba(0, 212, 255, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse 60% 40% at 80% 20%, rgba(168, 85, 247, 0.06) 0%, transparent 50%),
        radial-gradient(ellipse 50% 30% at 60% 80%, rgba(255, 107, 157, 0.05) 0%, transparent 50%),
        linear-gradient(180deg, var(--bg-deep) 0%, var(--bg-primary) 50%, var(--bg-secondary) 100%);
    }

    .aurora-bg::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: 
        radial-gradient(circle at 30% 30%, rgba(0, 255, 200, 0.03) 0%, transparent 30%),
        radial-gradient(circle at 70% 60%, rgba(0, 212, 255, 0.04) 0%, transparent 25%);
      animation: auroraMove 30s ease-in-out infinite;
    }

    @keyframes auroraMove {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      33% { transform: translate(2%, 1%) rotate(1deg); }
      66% { transform: translate(-1%, 2%) rotate(-1deg); }
    }

    /* 网格纹理 */
    .grid-pattern {
      position: fixed;
      inset: 0;
      background-image: 
        linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
      background-size: 60px 60px;
      z-index: 0;
      opacity: 0.5;
    }

    .container { 
      position: relative; 
      z-index: 1; 
      max-width: 1600px; 
      margin: 0 auto; 
      padding: 0 24px; 
    }

    /* ========== 导航栏 ========== */
    .nav { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      z-index: 100; 
      padding: 16px 0;
      background: transparent;
      transition: all var(--duration-normal) var(--ease-out);
    }
    
    .nav.scrolled { 
      padding: 10px 0;
      background: rgba(10, 14, 26, 0.85);
      backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 1px solid var(--border-subtle);
    }
    
    .nav-inner { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      max-width: 1600px; 
      margin: 0 auto; 
      padding: 0 24px; 
    }
    
    .logo { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      font-family: var(--font-display);
      font-size: 1.25rem; 
      font-weight: 600; 
      color: var(--text-primary);
      letter-spacing: -0.02em;
    }
    
    .logo-svg {
      filter: drop-shadow(0 4px 12px rgba(168, 85, 247, 0.4));
    }

    .logo-text {
      background: linear-gradient(135deg, #c084fc, #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    
    .nav-status { 
      display: flex; 
      align-items: center; 
      gap: 10px;
      padding: 8px 16px;
      background: var(--bg-glass);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    
    .status-dot { 
      width: 8px; 
      height: 8px; 
      border-radius: 50%; 
      background: var(--text-muted);
      transition: all var(--duration-normal) var(--ease-out);
    }
    
    .status-dot.connected { 
      background: var(--color-success); 
      box-shadow: 0 0 12px var(--color-success);
      animation: pulse-glow 2s ease-in-out infinite;
    }
    
    .status-dot.error { 
      background: var(--color-error);
      box-shadow: 0 0 8px var(--color-error);
    }

    @keyframes pulse-glow {
      0%, 100% { opacity: 1; box-shadow: 0 0 12px var(--color-success); }
      50% { opacity: 0.7; box-shadow: 0 0 20px var(--color-success); }
    }

    /* ========== Hero 区域 ========== */
    .hero { 
      min-height: 45vh; 
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
      text-align: center; 
      padding: 120px 24px 60px;
      position: relative;
    }
    
    .hero-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-glass);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      color: var(--aurora-cyan);
      margin-bottom: 24px;
      animation: fadeInDown 0.6s var(--ease-out);
    }

    .hero-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      background: var(--aurora-cyan);
      border-radius: 50%;
      animation: pulse-glow 2s ease-in-out infinite;
    }
    
    .hero-title { 
      font-family: var(--font-display);
      font-size: clamp(2.5rem, 6vw, 4rem); 
      font-weight: 700; 
      line-height: 1.1;
      letter-spacing: -0.03em;
      margin-bottom: 20px;
      animation: fadeInUp 0.6s var(--ease-out) 0.1s backwards;
    }
    
    .hero-title-gradient { 
      background: linear-gradient(135deg, var(--aurora-cyan), var(--aurora-mint), var(--aurora-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .hero-subtitle { 
      font-size: clamp(1rem, 2vw, 1.15rem); 
      color: var(--text-secondary); 
      max-width: 480px;
      font-weight: 400;
      animation: fadeInUp 0.6s var(--ease-out) 0.2s backwards;
    }
    
    @keyframes fadeInUp { 
      from { opacity: 0; transform: translateY(24px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    @keyframes fadeInDown { 
      from { opacity: 0; transform: translateY(-12px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    /* ========== 警告横幅 ========== */
    .alert-banner { 
      background: rgba(255, 77, 106, 0.08);
      border: 1px solid rgba(255, 77, 106, 0.2);
      border-radius: var(--radius-lg);
      padding: 20px 24px;
      margin-bottom: 24px;
      display: none;
      backdrop-filter: blur(10px);
    }
    
    .alert-banner.show { 
      display: block; 
      animation: fadeInUp 0.4s var(--ease-out); 
    }
    
    .alert-banner-title { 
      font-family: var(--font-display);
      font-weight: 600; 
      color: var(--color-error); 
      margin-bottom: 8px; 
      display: flex; 
      align-items: center; 
      gap: 10px;
      font-size: 0.95rem;
    }
    
    .alert-banner-content { 
      color: var(--text-secondary); 
      font-size: 0.85rem; 
      line-height: 1.7; 
    }
    
    .alert-banner-content code { 
      background: rgba(0, 0, 0, 0.3); 
      padding: 3px 8px; 
      border-radius: var(--radius-sm); 
      font-family: var(--font-mono); 
      font-size: 0.8rem;
      color: var(--aurora-cyan);
    }

    /* ========== 录制控制栏 ========== */
    .recording-bar {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 20px;
      background: var(--bg-card);
      backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-xl);
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
    }

    .recording-bar__status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
      background: var(--bg-glass);
      border-radius: var(--radius-full);
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-muted);
      min-width: 100px;
      transition: all var(--duration-normal) var(--ease-out);
    }

    .recording-bar__status.recording {
      background: var(--color-recording-glow);
      color: var(--color-recording);
      border: 1px solid rgba(255, 77, 106, 0.3);
    }

    .recording-bar__status.paused {
      background: rgba(251, 191, 36, 0.15);
      color: var(--color-warning);
      border: 1px solid rgba(251, 191, 36, 0.3);
    }

    .recording-bar__status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
      transition: all var(--duration-normal) var(--ease-out);
    }

    .recording-bar__status.recording .recording-bar__status-dot {
      animation: recording-pulse 1.2s ease-in-out infinite;
    }

    @keyframes recording-pulse { 
      0%, 100% { transform: scale(1); opacity: 1; } 
      50% { transform: scale(1.3); opacity: 0.6; } 
    }

    .recording-bar__timer {
      font-family: var(--font-mono);
      font-size: 1.75rem;
      font-weight: 500;
      color: var(--text-primary);
      min-width: 80px;
      letter-spacing: 0.02em;
    }

    .recording-bar__waveform {
      flex: 1;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
      background: var(--bg-glass);
      border-radius: var(--radius-md);
      overflow: hidden;
      padding: 0 16px;
      border: 1px solid var(--border-subtle);
    }

    .waveform-bar {
      width: 3px;
      background: linear-gradient(180deg, var(--aurora-cyan), var(--aurora-mint));
      border-radius: 2px;
      transition: height 0.08s ease;
      opacity: 0.8;
    }

    .recording-bar__controls {
      display: flex;
      gap: 10px;
    }

    .btn-control {
      padding: 12px 24px;
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-md);
      background: var(--bg-glass);
      color: var(--text-secondary);
      font-family: var(--font-body);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-control:hover:not(:disabled) {
      background: var(--bg-elevated);
      border-color: var(--border-glow);
      color: var(--text-primary);
      transform: translateY(-1px);
    }

    .btn-control:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-control.primary {
      background: linear-gradient(135deg, var(--aurora-cyan), var(--aurora-blue));
      border: none;
      color: var(--bg-deep);
      font-weight: 600;
      box-shadow: 0 4px 20px rgba(0, 212, 255, 0.25);
    }

    .btn-control.primary:hover:not(:disabled) {
      box-shadow: 0 6px 30px rgba(0, 212, 255, 0.4);
      transform: translateY(-2px);
    }

    .btn-control.primary.recording {
      background: linear-gradient(135deg, var(--color-recording), #ff3366);
      box-shadow: 0 4px 20px rgba(255, 77, 106, 0.3);
    }

    .btn-upload {
      padding: 12px 20px;
      background: transparent;
      border: 1px dashed var(--border-medium);
      border-radius: var(--radius-md);
      color: var(--text-muted);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-upload:hover {
      border-color: var(--aurora-cyan);
      color: var(--aurora-cyan);
      background: rgba(0, 212, 255, 0.05);
    }

    /* ========== 左侧边栏 ========== */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 280px;
      background: var(--bg-primary);
      border-right: 1px solid var(--border-subtle);
      z-index: 90;
      display: flex;
      flex-direction: column;
      transform: translateX(-100%);
      transition: transform var(--duration-normal) var(--ease-out);
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-title {
      font-family: var(--font-display);
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .sidebar-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.25rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      transition: all var(--duration-fast);
    }

    .sidebar-close:hover {
      background: var(--bg-elevated);
      color: var(--text-primary);
    }

    .new-meeting-btn {
      margin: 16px;
      padding: 12px 16px;
      background: linear-gradient(135deg, var(--aurora-purple), var(--aurora-blue));
      border: none;
      border-radius: var(--radius-md);
      color: white;
      font-family: var(--font-body);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all var(--duration-fast);
    }

    .new-meeting-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4);
    }

    .new-meeting-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .sidebar-section-title {
      padding: 12px 20px 8px;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .meeting-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 8px;
    }

    .meeting-list::-webkit-scrollbar {
      width: 4px;
    }

    .meeting-list::-webkit-scrollbar-thumb {
      background: var(--border-medium);
      border-radius: 2px;
    }

    .meeting-list-item {
      padding: 12px;
      margin: 4px 0;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--duration-fast);
      border: 1px solid transparent;
    }

    .meeting-list-item:hover {
      background: var(--bg-elevated);
    }

    .meeting-list-item.active {
      background: rgba(168, 85, 247, 0.15);
      border-color: var(--aurora-purple);
    }

    .meeting-list-item.recording {
      background: rgba(255, 77, 106, 0.1);
      border-color: var(--color-recording);
    }

    .meeting-list-item__title {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .meeting-list-item__meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .meeting-list-item__status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      font-size: 0.65rem;
      font-weight: 500;
    }

    .meeting-list-item__status.recording {
      background: rgba(255, 77, 106, 0.2);
      color: var(--color-recording);
    }

    .meeting-list-item__status.completed {
      background: rgba(0, 255, 200, 0.1);
      color: var(--color-success);
    }

    .meeting-list-empty {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .meeting-list-empty-icon {
      font-size: 2rem;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    /* 侧边栏触发按钮 */
    .sidebar-toggle {
      position: fixed;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 89;
      width: 40px;
      height: 40px;
      background: var(--bg-card-solid);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--duration-fast);
      box-shadow: var(--shadow-sm);
    }

    .sidebar-toggle:hover {
      background: var(--bg-elevated);
      color: var(--aurora-cyan);
      border-color: var(--aurora-cyan);
    }

    .sidebar-toggle.hidden {
      opacity: 0;
      pointer-events: none;
    }

    /* 侧边栏打开时的遮罩 */
    .sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 85;
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--duration-normal);
    }

    .sidebar-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    /* ========== 主内容区 ========== */
    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto;
      gap: 20px;
      margin-bottom: 24px;
    }

    /* 工具栏横向布局 */
    .toolbar-row {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: 1fr 1fr 1.2fr;
      gap: 20px;
      align-items: stretch;
    }

    @media (max-width: 1200px) {
      .toolbar-row {
        grid-template-columns: 1fr 1fr;
      }
      .toolbar-row .qa-section-wrapper {
        grid-column: 1 / -1;
      }
    }

    @media (max-width: 768px) {
      .main-content { grid-template-columns: 1fr; }
      .toolbar-row { grid-template-columns: 1fr; }
    }

    /* ========== 面板通用样式 ========== */
    .panel {
      background: var(--bg-card);
      backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-xl);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      height: 480px;
      box-shadow: var(--shadow-md);
    }

    .panel__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 24px;
      border-bottom: 1px solid var(--border-subtle);
      background: var(--bg-glass);
      flex-shrink: 0;
    }

    /* 面板大小调整手柄 */
    .panel__resize-handle {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 8px;
      cursor: ns-resize;
      background: transparent;
      transition: background var(--duration-fast);
    }

    .panel__resize-handle:hover {
      background: var(--aurora-cyan);
      opacity: 0.3;
    }

    .panel.resizable {
      position: relative;
      min-height: 300px;
      max-height: 800px;
      height: auto;
    }

    .panel__title {
      font-family: var(--font-display);
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: -0.01em;
    }

    .panel__title-icon {
      width: 28px;
      height: 28px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
    }

    .transcript-panel .panel__title-icon {
      background: linear-gradient(135deg, var(--aurora-cyan), var(--aurora-blue));
    }

    .insight-panel .panel__title-icon {
      background: linear-gradient(135deg, var(--aurora-purple), var(--aurora-pink));
    }

    .panel__count {
      font-family: var(--font-mono);
      font-size: 0.7rem;
      padding: 4px 10px;
      background: var(--bg-glass);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      color: var(--text-muted);
    }

    .panel__actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* 下载按钮下拉菜单 */
    .download-dropdown {
      position: relative;
    }

    .download-btn {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      background: var(--bg-glass);
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      transition: all var(--duration-fast) var(--ease-out);
    }

    .download-btn:hover {
      background: var(--bg-elevated);
      border-color: var(--aurora-cyan);
      color: var(--aurora-cyan);
      transform: scale(1.05);
    }

    .download-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: var(--bg-card-solid);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all var(--duration-fast) var(--ease-out);
      z-index: 100;
      min-width: 140px;
    }

    .download-menu.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .download-menu-item {
      width: 100%;
      padding: 10px 14px;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-family: var(--font-body);
      font-size: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all var(--duration-fast);
      text-align: left;
    }

    .download-menu-item:hover {
      background: var(--bg-elevated);
      color: var(--aurora-cyan);
    }

    .download-menu-item span {
      font-size: 1rem;
    }

    .panel__content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      scroll-behavior: smooth;
    }

    /* 自动滚动到底部按钮 */
    .panel__scroll-bottom {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 36px;
      height: 36px;
      background: var(--aurora-cyan);
      border: none;
      border-radius: 50%;
      color: var(--bg-deep);
      font-size: 1rem;
      cursor: pointer;
      opacity: 0;
      transform: translateY(10px);
      transition: all var(--duration-fast) var(--ease-out);
      box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
      z-index: 10;
    }

    .panel__scroll-bottom.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .panel__scroll-bottom:hover {
      transform: scale(1.1);
    }

    /* ========== 转写面板 ========== */
    .transcript-item {
      padding: 10px 14px;
      background: var(--bg-glass);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      margin-bottom: 6px;
      transition: all var(--duration-fast) var(--ease-out);
      position: relative;
      overflow: hidden;
    }

    .transcript-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(180deg, var(--aurora-cyan), var(--aurora-mint));
      border-radius: 0 2px 2px 0;
    }

    .transcript-item:hover {
      border-color: var(--border-glow);
      background: rgba(0, 212, 255, 0.03);
    }

    .transcript-time {
      font-family: var(--font-mono);
      font-size: 0.65rem;
      color: var(--aurora-cyan);
      margin-bottom: 4px;
      opacity: 0.8;
    }

    .transcript-text {
      font-size: 0.85rem;
      color: var(--text-primary);
      line-height: 1.6;
    }

    /* ========== 洞察面板 ========== */
    .insight-card {
      background: var(--bg-glass);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 18px;
      margin-bottom: 14px;
      transition: all var(--duration-fast) var(--ease-out);
      position: relative;
    }

    .insight-card:hover {
      border-color: var(--border-glow);
      transform: translateY(-2px);
      box-shadow: var(--shadow-glow);
    }

    .insight-card[data-type="inner_os"] { border-left: 3px solid var(--color-inner-os); }
    .insight-card[data-type="brainstorm"] { border-left: 3px solid var(--color-brainstorm); }
    .insight-card[data-type="stop_talking"] { border-left: 3px solid var(--color-stop-talking); }
    .insight-card[data-type="auto_analysis"] { border-left: 3px solid var(--color-auto-analysis); }

    .insight-card__header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
    }

    .insight-card__icon {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    .insight-card[data-type="inner_os"] .insight-card__icon { background: rgba(0, 212, 255, 0.15); }
    .insight-card[data-type="brainstorm"] .insight-card__icon { background: rgba(251, 191, 36, 0.15); }
    .insight-card[data-type="stop_talking"] .insight-card__icon { background: rgba(255, 107, 157, 0.15); }
    .insight-card[data-type="auto_analysis"] .insight-card__icon { background: rgba(0, 255, 200, 0.15); }

    .insight-card__title {
      font-family: var(--font-display);
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
      flex: 1;
    }

    .insight-card__time {
      font-family: var(--font-mono);
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .insight-card__content {
      font-size: 0.88rem;
      color: var(--text-secondary);
      line-height: 1.75;
    }

    /* 荧光高亮效果 */
    .highlight {
      background: linear-gradient(120deg, rgba(0, 212, 255, 0.2) 0%, rgba(0, 255, 200, 0.15) 100%);
      color: var(--aurora-cyan);
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }

    /* 引用样式 */
    .insight-card__quote {
      margin-top: 12px;
      padding: 12px 16px;
      background: rgba(0, 212, 255, 0.05);
      border-left: 3px solid var(--aurora-cyan);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      font-style: italic;
      color: var(--text-primary);
    }

    /* 情绪标签 */
    .insight-emotion-tag {
      display: inline-block;
      padding: 4px 12px;
      background: linear-gradient(135deg, var(--aurora-purple), var(--aurora-pink));
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      color: white;
      margin-top: 8px;
    }

    /* ========== 洞察卡片内容样式 ========== */
    
    /* 纠偏提醒样式 */
    .insight-stop-talking {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .insight-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: var(--radius-full);
      font-size: 0.8rem;
      font-weight: 600;
      width: fit-content;
    }

    .insight-status-badge.warning {
      background: rgba(255, 107, 157, 0.15);
      color: var(--color-stop-talking);
      border: 1px solid rgba(255, 107, 157, 0.3);
    }

    .insight-status-badge.success {
      background: rgba(0, 255, 200, 0.1);
      color: var(--color-success);
      border: 1px solid rgba(0, 255, 200, 0.3);
    }

    .insight-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .insight-field-icon {
      font-size: 0.9rem;
    }

    .insight-field-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .insight-field-value {
      font-size: 0.85rem;
      color: var(--text-primary);
      line-height: 1.6;
      margin: 0;
    }

    .insight-field-value.highlight-box {
      background: rgba(0, 212, 255, 0.08);
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--aurora-cyan);
    }

    .insight-reminder {
      display: flex;
      gap: 10px;
      padding: 12px;
      background: rgba(0, 212, 255, 0.05);
      border-radius: var(--radius-md);
      border: 1px solid rgba(0, 212, 255, 0.15);
    }

    .insight-reminder span {
      font-size: 1rem;
      flex-shrink: 0;
    }

    .insight-reminder p {
      margin: 0;
      font-size: 0.85rem;
      color: var(--text-primary);
      line-height: 1.6;
    }

    /* 自动分析样式 */
    .insight-auto-analysis {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .insight-phase-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      background: linear-gradient(135deg, var(--aurora-cyan), var(--aurora-blue));
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--bg-deep);
      width: fit-content;
    }

    .insight-section {
      padding: 10px 12px;
      background: var(--bg-glass);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-subtle);
    }

    .insight-section.warning {
      background: rgba(255, 107, 157, 0.05);
      border-color: rgba(255, 107, 157, 0.2);
    }

    .insight-section.advice {
      background: rgba(0, 255, 200, 0.05);
      border-color: rgba(0, 255, 200, 0.2);
    }

    .insight-section-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .insight-section.warning .insight-section-title {
      color: var(--color-stop-talking);
    }

    .insight-section.advice .insight-section-title {
      color: var(--color-success);
    }

    .insight-section-content {
      margin: 0;
      font-size: 0.85rem;
      color: var(--text-primary);
      line-height: 1.6;
    }

    .insight-inner-os {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 10px 12px;
      background: rgba(168, 85, 247, 0.08);
      border-radius: var(--radius-md);
      border: 1px dashed rgba(168, 85, 247, 0.3);
    }

    .insight-inner-os span {
      font-size: 1rem;
      flex-shrink: 0;
    }

    .insight-inner-os em {
      font-size: 0.85rem;
      color: var(--aurora-purple);
      font-style: italic;
      line-height: 1.5;
    }

    /* 默认字段行 */
    .insight-field-row {
      padding: 6px 0;
      font-size: 0.85rem;
      line-height: 1.6;
      border-bottom: 1px solid var(--border-subtle);
    }

    .insight-field-row:last-child {
      border-bottom: none;
    }

    /* 空状态 */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      min-height: 240px;
      color: var(--text-muted);
      text-align: center;
      padding: 40px;
    }

    .empty-state__icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.4;
    }

    .empty-state__text {
      font-size: 0.9rem;
      max-width: 200px;
    }

    /* ========== 工具栏面板 ========== */
    .toolbar-panel {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .toolbar-section {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 18px;
      display: flex;
      flex-direction: column;
    }

    .toolbar-section__title {
      font-family: var(--font-display);
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 14px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* 问答区域 - 独立样式 */
    .qa-section-wrapper {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 18px;
      display: flex;
      flex-direction: column;
      min-height: 200px;
    }

    .qa-section-wrapper .toolbar-section__title {
      margin-bottom: 12px;
    }

    /* AI 技能按钮组 */
    .skills-row {
      display: flex;
      gap: 10px;
    }

    .skill-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 14px 10px;
      background: var(--bg-glass);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
    }

    .skill-btn:hover:not(:disabled) {
      background: var(--bg-elevated);
      border-color: var(--border-glow);
      transform: translateY(-2px);
      box-shadow: var(--shadow-glow);
    }

    .skill-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .skill-btn.loading {
      border-color: var(--aurora-cyan);
      animation: loading-pulse 1.5s ease-in-out infinite;
    }

    @keyframes loading-pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(0, 212, 255, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(0, 212, 255, 0); }
    }

    .skill-btn__icon {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }

    .skill-btn__icon.inner-os { background: linear-gradient(135deg, var(--aurora-cyan), var(--aurora-blue)); }
    .skill-btn__icon.brainstorm { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
    .skill-btn__icon.stop-talking { background: linear-gradient(135deg, var(--aurora-pink), #ff3366); }

    .skill-btn__name {
      font-size: 0.7rem;
      font-weight: 500;
      color: var(--text-secondary);
      text-align: center;
    }

    .skill-status {
      font-size: 0.7rem;
      min-height: 16px;
    }

    /* 自动推送开关 */
    .auto-push-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      margin-top: 8px;
      border-top: 1px solid var(--border-subtle);
    }

    .auto-push-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .toggle-switch {
      position: relative;
      width: 48px;
      height: 26px;
      background: var(--bg-glass);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
    }

    .toggle-switch.active {
      background: linear-gradient(135deg, var(--aurora-cyan), var(--aurora-mint));
      border-color: transparent;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      transition: transform var(--duration-fast) var(--ease-spring);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch.active::after {
      transform: translateX(22px);
    }

    /* 视觉化区域 */
    .vis-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 1;
    }

    .vis-type-row {
      display: flex;
      gap: 8px;
    }

    .vis-type-btn {
      flex: 1;
      padding: 10px 8px;
      background: var(--bg-glass);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
    }

    .vis-type-btn:hover {
      border-color: var(--border-medium);
      color: var(--text-secondary);
    }

    .vis-type-btn.active {
      background: linear-gradient(135deg, var(--aurora-cyan), var(--aurora-blue));
      border-color: transparent;
      color: var(--bg-deep);
    }

    .vis-generate-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, var(--aurora-purple), var(--aurora-pink));
      border: none;
      border-radius: var(--radius-md);
      color: white;
      font-family: var(--font-body);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
      box-shadow: 0 4px 20px rgba(168, 85, 247, 0.25);
    }

    .vis-generate-btn:hover:not(:disabled) {
      box-shadow: 0 6px 30px rgba(168, 85, 247, 0.4);
      transform: translateY(-2px);
    }

    .vis-generate-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .vis-preview {
      margin-top: 12px;
    }

    .vis-preview img {
      width: 100%;
      border-radius: var(--radius-md);
      cursor: pointer;
      border: 1px solid var(--border-subtle);
      transition: all var(--duration-fast) var(--ease-out);
    }

    .vis-preview img:hover {
      border-color: var(--border-glow);
      box-shadow: var(--shadow-glow);
    }

    /* 问答区域 */
    .qa-section {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .qa-messages {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 120px;
      max-height: 280px;
    }

    .qa-message {
      max-width: 90%;
      padding: 10px 14px;
      border-radius: var(--radius-md);
      font-size: 0.8rem;
      line-height: 1.6;
    }

    .qa-message.user {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--aurora-cyan), var(--aurora-blue));
      color: var(--bg-deep);
      border-bottom-right-radius: 4px;
    }

    .qa-message.assistant {
      align-self: flex-start;
      background: var(--bg-glass);
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      border-bottom-left-radius: 4px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .qa-input-row {
      display: flex;
      gap: 10px;
      margin-top: auto;
      padding-top: 10px;
    }

    .qa-input {
      flex: 1;
      padding: 12px 14px;
      background: var(--bg-glass);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-family: var(--font-body);
      font-size: 0.85rem;
      outline: none;
      transition: all var(--duration-fast) var(--ease-out);
    }

    .qa-input:focus {
      border-color: var(--aurora-cyan);
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }

    .qa-input::placeholder {
      color: var(--text-muted);
    }

    .qa-send-btn {
      padding: 12px 18px;
      background: linear-gradient(135deg, var(--aurora-cyan), var(--aurora-blue));
      border: none;
      border-radius: var(--radius-md);
      color: var(--bg-deep);
      font-family: var(--font-body);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
    }

    .qa-send-btn:hover:not(:disabled) {
      box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
    }

    .qa-send-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* ========== Footer ========== */
    .footer {
      padding: 40px 0;
      border-top: 1px solid var(--border-subtle);
      text-align: center;
    }

    .footer-text {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .footer-text a {
      color: var(--aurora-cyan);
      text-decoration: none;
      transition: color var(--duration-fast);
    }

    .footer-text a:hover {
      color: var(--aurora-mint);
    }

    /* ========== Toast ========== */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      padding: 14px 20px;
      background: var(--bg-card-solid);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: toastSlideIn 0.4s var(--ease-spring);
      max-width: 380px;
      font-size: 0.85rem;
    }

    .toast.success { border-left: 3px solid var(--color-success); }
    .toast.error { border-left: 3px solid var(--color-error); }
    .toast.info { border-left: 3px solid var(--color-info); }
    .toast.warning { border-left: 3px solid var(--color-warning); }

    @keyframes toastSlideIn { 
      from { opacity: 0; transform: translateX(60px) scale(0.95); } 
      to { opacity: 1; transform: translateX(0) scale(1); } 
    }

    /* ========== 认证弹窗 ========== */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 2000;
      background: rgba(10, 14, 26, 0.9);
      backdrop-filter: blur(10px);
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.show { display: flex; }
    
    .modal-content {
      background: var(--bg-card-solid);
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-xl);
      padding: 32px;
      max-width: 400px;
      width: 90%;
      position: relative;
      box-shadow: var(--shadow-lg);
    }
    
    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      transition: all var(--duration-fast);
    }
    .modal-close:hover { color: var(--text-primary); background: var(--bg-glass); }
    
    .modal-title {
      font-family: var(--font-display);
      font-size: 1.25rem;
      margin-bottom: 24px;
      text-align: center;
    }
    
    .auth-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }
    .auth-tab {
      flex: 1;
      padding: 12px;
      background: var(--bg-glass);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all var(--duration-fast);
    }
    .auth-tab.active {
      background: var(--aurora-cyan);
      color: var(--bg-deep);
      border-color: var(--aurora-cyan);
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    .form-group input {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 0.9rem;
      transition: all var(--duration-fast);
    }
    .form-group input:focus {
      outline: none;
      border-color: var(--aurora-cyan);
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }
    
    .auth-submit {
      width: 100%;
      padding: 14px;
      margin-top: 8px;
    }
    
    .auth-hint {
      text-align: center;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 16px;
    }

    /* 设置弹窗 */
    .settings-modal {
      max-width: 500px;
    }
    .settings-info {
      background: var(--bg-secondary);
      padding: 16px;
      border-radius: var(--radius-md);
      margin-bottom: 20px;
    }
    .settings-info p {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .settings-info code {
      display: block;
      font-family: var(--font-mono);
      font-size: 0.9rem;
      color: var(--aurora-cyan);
      word-break: break-all;
    }
    .form-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 12px;
      line-height: 1.8;
    }
    .form-hint code {
      background: var(--bg-secondary);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 0.7rem;
    }
    .form-hint strong {
      color: var(--text-secondary);
    }
    .settings-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    .settings-actions .btn {
      flex: 1;
    }
    .settings-icon {
      margin-left: 6px;
      font-size: 0.8rem;
      opacity: 0.7;
    }
    .nav-status:hover .settings-icon {
      opacity: 1;
    }
    
    /* 个人中心弹窗 */
    .profile-info {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-subtle);
    }
    .profile-avatar {
      width: 48px;
      height: 48px;
      background: var(--bg-secondary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .profile-name {
      font-size: 1.1rem;
      font-weight: 500;
    }
    
    .quota-section h4 {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }
    .quota-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 0.9rem;
    }
    .quota-item:last-child { border-bottom: none; }
    
    /* 语言设置 */
    .language-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border-subtle);
    }
    .language-section h4 {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }
    .language-switcher {
      display: flex;
      gap: 10px;
    }
    .lang-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--bg-glass);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 0.9rem;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
    }
    .lang-btn:hover {
      background: var(--bg-elevated);
      border-color: var(--border-medium);
    }
    .lang-btn.active {
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(139, 92, 246, 0.2));
      border-color: var(--aurora-purple);
      color: var(--text-primary);
    }
    
    /* 会议历史 */
    .meetings-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border-subtle);
    }
    .meetings-section h4 {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }
    .meetings-list {
      max-height: 200px;
      overflow-y: auto;
    }
    .meetings-empty {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.85rem;
      padding: 16px;
    }
    .meeting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: var(--bg-glass);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      cursor: pointer;
      transition: all var(--duration-fast);
    }
    .meeting-item:hover {
      background: var(--bg-elevated);
      border-color: var(--aurora-cyan);
    }
    .meeting-item-title {
      font-size: 0.9rem;
      color: var(--text-primary);
    }
    .meeting-item-date {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    
    /* 会议详情弹窗 */
    .meeting-detail-modal {
      max-width: 800px;
      width: 95%;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .meeting-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-subtle);
    }
    .meeting-detail-title {
      font-family: var(--font-display);
      font-size: 1.25rem;
      margin-bottom: 8px;
    }
    .meeting-detail-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .meeting-detail-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .meeting-detail-tab {
      padding: 8px 16px;
      background: var(--bg-glass);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.85rem;
      transition: all var(--duration-fast);
    }
    .meeting-detail-tab.active {
      background: var(--aurora-cyan);
      color: var(--bg-deep);
      border-color: var(--aurora-cyan);
    }
    .meeting-detail-content {
      flex: 1;
      overflow-y: auto;
      padding-right: 8px;
    }
    .meeting-detail-section {
      display: none;
    }
    .meeting-detail-section.active {
      display: block;
    }
    .transcript-item-detail {
      padding: 12px 16px;
      background: var(--bg-glass);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
      border-left: 3px solid var(--aurora-cyan);
    }
    .transcript-item-detail .time {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .transcript-item-detail .text {
      font-size: 0.9rem;
      color: var(--text-primary);
      line-height: 1.5;
    }
    .insight-item-detail {
      padding: 16px;
      background: var(--bg-glass);
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      border-left: 3px solid var(--aurora-purple);
    }
    .insight-item-detail .type {
      font-size: 0.75rem;
      color: var(--aurora-purple);
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    .insight-item-detail .content {
      font-size: 0.9rem;
      color: var(--text-primary);
      line-height: 1.6;
      white-space: pre-wrap;
    }
    .vis-item-detail {
      padding: 16px;
      background: var(--bg-glass);
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      text-align: center;
    }
    .vis-item-detail img {
      max-width: 100%;
      max-height: 300px;
      border-radius: var(--radius-md);
      margin-bottom: 8px;
    }
    .vis-item-detail .type {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .detail-empty {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
      padding: 40px 20px;
    }
    .detail-loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }
    .btn-delete-meeting {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid var(--color-error);
      border-radius: var(--radius-md);
      color: var(--color-error);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all var(--duration-fast);
    }
    .btn-delete-meeting:hover {
      background: var(--color-error);
      color: white;
    }
    
    /* 用户按钮 */
    .user-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-glass);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.85rem;
      transition: all var(--duration-fast);
    }
    .user-btn:hover {
      border-color: var(--aurora-cyan);
      color: var(--text-primary);
    }

    /* ========== 模态框 ========== */
    .vis-modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(10, 14, 26, 0.95);
      backdrop-filter: blur(20px);
      align-items: center;
      justify-content: center;
      padding: 40px;
    }

    .vis-modal.show { display: flex; }

    .vis-modal-content {
      max-width: 90vw;
      max-height: 90vh;
      position: relative;
    }

    .vis-modal-image {
      width: 100%;
      height: auto;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
    }

    .vis-modal-close {
      position: absolute;
      top: -48px;
      right: 0;
      padding: 10px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-family: var(--font-body);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
    }

    .vis-modal-close:hover {
      background: var(--bg-elevated);
      border-color: var(--border-glow);
    }

    /* ========== 工具类 ========== */
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-top-color: var(--aurora-cyan);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    #uploadInput { display: none; }

    .chart-type-select {
      width: 100%;
      padding: 12px 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-family: var(--font-body);
      font-size: 0.85rem;
      margin-bottom: 12px;
      display: none;
      outline: none;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238b9cc7' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .chart-type-select:hover {
      border-color: var(--aurora-cyan);
      background-color: var(--bg-elevated);
    }

    .chart-type-select:focus {
      border-color: var(--aurora-cyan);
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.15);
    }

    .chart-type-select option {
      background: var(--bg-card-solid);
      color: var(--text-primary);
      padding: 12px;
    }

    .chart-type-select option:hover,
    .chart-type-select option:checked {
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 255, 200, 0.1));
    }

    .vis-status {
      margin-top: 10px;
      padding: 10px 14px;
      background: rgba(0, 212, 255, 0.08);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      color: var(--aurora-cyan);
      display: none;
    }

    .vis-status.error {
      background: rgba(255, 77, 106, 0.08);
      border-color: rgba(255, 77, 106, 0.2);
      color: var(--color-error);
    }

    /* 滚动条 */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { 
      background: rgba(255, 255, 255, 0.1); 
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover { 
      background: rgba(255, 255, 255, 0.2); 
    }

    /* 选择文本 */
    ::selection {
      background: rgba(0, 212, 255, 0.3);
      color: white;
    }

    /* ========== V3 Agent 联动样式 ========== */

    /* Agent 开关提示 */
    .agent-hint {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 4px;
      padding-left: 4px;
    }

    /* 转写项关联标记 */
    .transcript-item.has-insight {
      border-left: 3px solid var(--aurora-purple);
      cursor: pointer;
      position: relative;
    }

    .transcript-item.has-insight::before {
      display: none;
    }

    .transcript-item.has-insight:hover {
      background: rgba(168, 85, 247, 0.1);
    }

    .transcript-link-badge {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.9rem;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .transcript-item.has-insight:hover .transcript-link-badge {
      opacity: 1;
    }

    /* 洞察来源引用 */
    .insight-card__source {
      padding: 8px 12px;
      background: rgba(168, 85, 247, 0.1);
      border-radius: var(--radius-sm);
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .insight-card__source:hover {
      background: rgba(168, 85, 247, 0.2);
    }

    .source-label {
      font-size: 0.75rem;
      color: var(--aurora-purple);
      font-weight: 500;
    }

    .source-text {
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-style: italic;
    }

    /* 自动洞察徽章 */
    .insight-card__badge {
      font-size: 0.65rem;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      margin-left: 8px;
    }

    .insight-card__badge.auto {
      background: linear-gradient(135deg, var(--aurora-purple), var(--aurora-pink));
      color: white;
    }

    /* 新洞察入场动画 */
    @keyframes insightSlideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .insight-card.auto-insight {
      animation: insightSlideIn 0.4s var(--ease-spring);
    }

    /* 高亮闪烁效果 */
    @keyframes highlightPulse {
      0%, 100% { background: transparent; }
      50% { background: rgba(168, 85, 247, 0.2); }
    }

    .highlight-pulse {
      animation: highlightPulse 1s ease-in-out 2;
    }

    /* Agent 洞察类型样式 */
    .insight-card[data-type="data_chart"] { border-left: 3px solid var(--aurora-cyan); }
    .insight-card[data-type="chart_generated"] { border-left: 3px solid var(--aurora-cyan); }
    .insight-card[data-type="skill_result"] { border-left: 3px solid var(--aurora-purple); }
    .insight-card[data-type="visualization_generated"] { border-left: 3px solid var(--aurora-pink); }
    .insight-card[data-type="focus_reminder"] { border-left: 3px solid var(--aurora-pink); }
    .insight-card[data-type="redundancy_hint"] { border-left: 3px solid var(--color-warning); }
    .insight-card[data-type="decision_record"] { border-left: 3px solid var(--color-success); }
    .insight-card[data-type="periodic_summary"] { border-left: 3px solid var(--aurora-purple); }

    .insight-card[data-type="data_chart"] .insight-card__icon { background: rgba(0, 212, 255, 0.15); }
    .insight-card[data-type="chart_generated"] .insight-card__icon { background: rgba(0, 212, 255, 0.15); }
    .insight-card[data-type="skill_result"] .insight-card__icon { background: rgba(139, 92, 246, 0.15); }
    .insight-card[data-type="visualization_generated"] .insight-card__icon { background: rgba(255, 107, 157, 0.15); }
    .insight-card[data-type="focus_reminder"] .insight-card__icon { background: rgba(255, 107, 157, 0.15); }
    .insight-card[data-type="redundancy_hint"] .insight-card__icon { background: rgba(251, 191, 36, 0.15); }
    .insight-card[data-type="decision_record"] .insight-card__icon { background: rgba(0, 255, 200, 0.15); }
    .insight-card[data-type="periodic_summary"] .insight-card__icon { background: rgba(168, 85, 247, 0.15); }

    /* 数据点样式 */
    .data-points {
      font-size: 0.8rem;
      color: var(--aurora-cyan);
      padding: 6px 10px;
      background: rgba(0, 212, 255, 0.1);
      border-radius: var(--radius-sm);
      margin: 8px 0;
    }

    .suggestion {
      font-size: 0.85rem;
      color: var(--color-success);
      font-style: italic;
    }

    /* 洞察卡片内的可视化图片 */
    .insight-card__visualization {
      margin-top: 12px;
    }

    .insight-card__visualization img {
      width: 100%;
      border-radius: var(--radius-md);
      cursor: pointer;
      border: 1px solid var(--border-subtle);
      transition: all var(--duration-fast) var(--ease-out);
    }

    .insight-card__visualization img:hover {
      border-color: var(--border-glow);
      box-shadow: var(--shadow-glow);
    }
  </style>
</head>
<body>
  <div class="aurora-bg"></div>
  <div class="grid-pattern"></div>

  <!-- 左侧边栏 -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <span class="sidebar-title">会议记录</span>
      <button class="sidebar-close" onclick="closeSidebar()">✕</button>
    </div>
    <button class="new-meeting-btn" id="newMeetingBtn" onclick="startNewMeeting()">
      <span>➕</span>
      <span>新建会议</span>
    </button>
    <div class="sidebar-section-title">进行中</div>
    <div class="meeting-list" id="activeMeetingList">
      <!-- 当前进行中的会议 -->
    </div>
    <div class="sidebar-section-title">历史会议</div>
    <div class="meeting-list" id="historyMeetingList">
      <div class="meeting-list-empty">
        <div class="meeting-list-empty-icon">📂</div>
        <div>登录后查看历史会议</div>
      </div>
    </div>
  </aside>
  <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">☰</button>

  <!-- 导航栏 -->
  <nav class="nav" id="nav">
    <div class="nav-inner">
      <div class="logo">
        <svg class="logo-svg" width="36" height="36" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
          <!-- M 字母主体 -->
          <path d="M15 85V30C15 22 20 15 28 15H35L50 45L65 15H72C80 15 85 22 85 30V85" fill="url(#logoGradMain)"/>
          <!-- 左侧竖条 -->
          <rect x="15" y="15" width="16" height="70" rx="4" fill="url(#logoGradLeft)"/>
          <!-- 右侧竖条 -->
          <rect x="69" y="15" width="16" height="70" rx="4" fill="url(#logoGradRight)"/>
          <!-- 中间V形 -->
          <path d="M31 15L50 55L69 15" fill="url(#logoGradCenter)"/>
          <!-- 顶部高亮 -->
          <path d="M50 45L38 20H62L50 45Z" fill="url(#logoGradHighlight)" opacity="0.6"/>
          <defs>
            <linearGradient id="logoGradMain" x1="15" y1="15" x2="85" y2="85" gradientUnits="userSpaceOnUse">
              <stop stop-color="#a855f7"/>
              <stop offset="1" stop-color="#7c3aed"/>
            </linearGradient>
            <linearGradient id="logoGradLeft" x1="15" y1="15" x2="31" y2="85" gradientUnits="userSpaceOnUse">
              <stop stop-color="#c084fc"/>
              <stop offset="1" stop-color="#9333ea"/>
            </linearGradient>
            <linearGradient id="logoGradRight" x1="69" y1="15" x2="85" y2="85" gradientUnits="userSpaceOnUse">
              <stop stop-color="#a855f7"/>
              <stop offset="1" stop-color="#7c3aed"/>
            </linearGradient>
            <linearGradient id="logoGradCenter" x1="50" y1="15" x2="50" y2="55" gradientUnits="userSpaceOnUse">
              <stop stop-color="#e9d5ff"/>
              <stop offset="1" stop-color="#c084fc"/>
            </linearGradient>
            <linearGradient id="logoGradHighlight" x1="50" y1="20" x2="50" y2="45" gradientUnits="userSpaceOnUse">
              <stop stop-color="#f5d0fe"/>
              <stop offset="1" stop-color="#d8b4fe"/>
            </linearGradient>
          </defs>
        </svg>
        <span class="logo-text">MeetMind</span>
      </div>
      <div class="nav-status" onclick="openSettingsModal()" style="cursor: pointer;" title="点击设置后端地址">
        <div class="status-dot" id="connectionStatus"></div>
        <span id="connectionText">检测中...</span>
        <span class="settings-icon">⚙️</span>
      </div>
      <button class="user-btn" id="userBtn" onclick="handleUserClick()">
        <span id="userBtnText">登录</span>
      </button>
    </div>
  </nav>

  <!-- Hero 区域 -->
  <section class="hero">
    <div class="hero-badge">
      <span>您的数字参会者 · Digital Participant</span>
    </div>
    <h1 class="hero-title">
      MeetMind · 视界<br>
      <span class="hero-title-gradient">不只是记录，而是真正参与</span>
    </h1>
    <p class="hero-subtitle">
      全程在场、深度理解、主动洞察 — 您会议中最懂行的那位
    </p>
  </section>

  <!-- 主内容区 -->
  <div class="container">
    <!-- 警告横幅 -->
    <div class="alert-banner" id="alertBanner">
      <div class="alert-banner-title">
        <span>⚠️</span>
        <span id="alertTitle">需要启动后端服务</span>
      </div>
      <div class="alert-banner-content" id="alertContent">
        请先启动后端服务：<code>cd backend && npm run start:dev</code>
      </div>
    </div>

    <!-- 录制控制栏 -->
    <div class="recording-bar">
      <div class="recording-bar__status" id="recordingStatus">
        <span class="recording-bar__status-dot"></span>
        <span id="recordingStatusText">准备就绪</span>
      </div>
      
      <div class="recording-bar__timer" id="recordingTimer">00:00</div>
      
      <div class="recording-bar__waveform" id="waveform"></div>
      
      <div class="recording-bar__controls">
        <button class="btn-control" id="pauseBtn" disabled>暂停</button>
        <button class="btn-control primary" id="recordBtn" disabled>
          <span>🎙️</span>
          <span id="recordBtnText">开始录音</span>
        </button>
      </div>
      
      <input type="file" id="uploadInput" accept="audio/*">
      <button class="btn-upload" id="uploadBtn" onclick="document.getElementById('uploadInput').click()">
        <span>📁</span>
        <span>上传音频</span>
      </button>
    </div>

    <!-- 双栏布局 -->
    <div class="main-content">
      <!-- 左栏：全息记录 -->
      <div class="panel transcript-panel resizable">
        <div class="panel__header">
          <div class="panel__title">
            <div class="panel__title-icon">📝</div>
            全息记录
            <span class="panel__count" id="transcriptCount">0</span>
          </div>
          <div class="panel__actions">
            <div class="download-dropdown" id="downloadDropdown" style="display: none;">
              <button class="download-btn" id="downloadBtn" onclick="toggleDownloadMenu()" title="下载转写内容">
                <span>⬇️</span>
              </button>
              <div class="download-menu" id="downloadMenu">
                <button class="download-menu-item" onclick="downloadTranscript('word')">
                  <span>📄</span> Word 文档
                </button>
                <button class="download-menu-item" onclick="downloadTranscript('pdf')">
                  <span>📑</span> PDF 文档
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="panel__content" id="transcriptionList">
          <div class="empty-state" id="transcriptEmptyState">
            <div class="empty-state__icon">🎤</div>
            <p class="empty-state__text">开始录音后，转写内容将实时显示</p>
          </div>
        </div>
        <button class="panel__scroll-bottom" id="transcriptScrollBtn" onclick="scrollToBottom('transcriptionList')" title="滚动到底部">↓</button>
      </div>

      <!-- 右栏：会议洞察 -->
      <div class="panel insight-panel resizable">
        <div class="panel__header">
          <div class="panel__title">
            <div class="panel__title-icon">✨</div>
            认知同频
            <span class="panel__count" id="insightCount">0</span>
          </div>
        </div>
        <div class="panel__content" id="summaryList">
          <div class="empty-state" id="insightEmptyState">
            <div class="empty-state__icon">💡</div>
            <p class="empty-state__text">触发 AI 技能后，洞察将显示在这里</p>
          </div>
          <div id="visualizationList"></div>
        </div>
        <button class="panel__scroll-bottom" id="insightScrollBtn" onclick="scrollToBottom('summaryList')" title="滚动到底部">↓</button>
      </div>

      <!-- 工具栏横向布局 -->
      <div class="toolbar-row">
        <!-- AI 技能 -->
        <div class="toolbar-section">
          <div class="toolbar-section__title" data-i18n="toolbar.cognitiveSkills">认知技能</div>
          <div class="skills-row">
            <button class="skill-btn" id="skillInnerOS" onclick="triggerSkill('inner_os')" disabled>
              <div class="skill-btn__icon inner-os">🔮</div>
              <span class="skill-btn__name" data-i18n="toolbar.cognitiveTranslate">认知转译</span>
              <span class="skill-status" id="skillInnerOSStatus"></span>
            </button>
            <button class="skill-btn" id="skillBrainstorm" onclick="triggerSkill('brainstorm')" disabled>
              <div class="skill-btn__icon brainstorm">⚡</div>
              <span class="skill-btn__name" data-i18n="toolbar.breakInspiration">破局灵感</span>
              <span class="skill-status" id="skillBrainstormStatus"></span>
            </button>
            <button class="skill-btn" id="skillStopTalking" onclick="triggerSkill('stop_talking')" disabled>
              <div class="skill-btn__icon stop-talking">🎯</div>
              <span class="skill-btn__name" data-i18n="toolbar.agendaGuard">议程守护</span>
              <span class="skill-status" id="skillStopTalkingStatus"></span>
            </button>
          </div>
          
          <div class="auto-push-row">
            <span class="auto-push-label" data-i18n="toolbar.agentLinkage">🤖 AI 智能分析</span>
            <div class="toggle-switch active" id="agentToggle" onclick="toggleAgent()"></div>
          </div>
          <div class="agent-hint" data-i18n="toolbar.agentHint">自动检测数据/跑题，智能生成洞察和图表</div>
        </div>

        <!-- 视觉化 -->
        <div class="toolbar-section">
          <div class="toolbar-section__title" data-i18n="toolbar.mindVisualization">思维显影</div>
          <div class="vis-section">
            <div class="vis-type-row">
              <button class="vis-type-btn active" data-type="chart" onclick="selectVisualizationType('chart')" data-i18n="toolbar.dataChart">📊 数据图表</button>
              <button class="vis-type-btn" data-type="creative" onclick="selectVisualizationType('creative')" data-i18n="toolbar.creativeImage">🎨 创意图像</button>
              <button class="vis-type-btn" data-type="poster" onclick="selectVisualizationType('poster')" data-i18n="toolbar.logicPoster">📋 逻辑海报</button>
            </div>
            <select class="chart-type-select" id="chartTypeSelect">
              <option value="radar" data-i18n="toolbar.radarChart">雷达图</option>
              <option value="flowchart" data-i18n="toolbar.flowChart">流程图</option>
              <option value="architecture" data-i18n="toolbar.archChart">架构图</option>
              <option value="bar" data-i18n="toolbar.barChart">柱状图</option>
            </select>
            <button class="vis-generate-btn" id="visGenerateBtn" onclick="generateVisualization()" disabled data-i18n="toolbar.generateVis">
              ✨ 生成视觉化
            </button>
            <div class="vis-status" id="visStatus"></div>
            <div class="vis-preview" id="visPreview" style="display: none;">
              <img id="visPreviewImage" src="" alt="预览" onclick="viewVisualizationFromPreview()">
            </div>
          </div>
        </div>

        <!-- 问答 -->
        <div class="qa-section-wrapper">
          <div class="toolbar-section__title" data-i18n="toolbar.meetingQA">会议问答</div>
          <div class="qa-section">
            <div class="qa-messages" id="qaMessages">
              <div class="qa-message assistant" data-i18n="toolbar.qaWelcome">👋 有问题随时问我，我会基于会议内容为你解答</div>
            </div>
            <div class="qa-input-row">
              <input type="text" class="qa-input" id="qaInput" data-i18n-placeholder="toolbar.inputQuestion" placeholder="输入问题..." onkeypress="handleQAKeypress(event)">
              <button class="qa-send-btn" id="qaSendBtn" onclick="askQuestion()" disabled data-i18n="toolbar.send">发送</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <p class="footer-text">
      Built with ❤️ using <a href="#">通义听悟</a> + <a href="#">Qwen3-Max</a>
    </p>
  </footer>


  <div class="toast-container" id="toastContainer"></div>

  <!-- 后端设置弹窗 -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal-content settings-modal">
      <h3 class="modal-title">🔧 后端服务设置</h3>
      <div class="settings-info">
        <p>当前后端地址：</p>
        <code id="currentApiUrl">-</code>
      </div>
      <div class="form-group">
        <label>后端服务地址</label>
        <input type="text" id="apiUrlInput" placeholder="http://47.112.160.134:4000">
        <p class="form-hint">
          💡 <strong>服务器地址说明：</strong><br>
          默认后端地址：<code>http://47.112.160.134:4000</code><br>
          如需修改，请确保服务器防火墙/安全组已开放对应端口。
        </p>
      </div>
      <div class="settings-actions">
        <button class="btn btn-secondary" onclick="resetApiUrl()">重置为默认</button>
        <button class="btn btn-primary" onclick="saveApiUrl()">保存并测试</button>
      </div>
      <button class="modal-close" onclick="closeSettingsModal()">×</button>
    </div>
  </div>

  <!-- 登录/注册弹窗 -->
  <div class="modal-overlay" id="authModal">
    <div class="modal-content auth-modal">
      <div class="auth-tabs">
        <button class="auth-tab active" data-tab="login" onclick="switchAuthTab('login')">登录</button>
        <button class="auth-tab" data-tab="register" onclick="switchAuthTab('register')">注册</button>
      </div>
      <form id="authForm" onsubmit="handleAuth(event)">
        <div class="form-group">
          <label>用户名</label>
          <input type="text" id="authUsername" placeholder="请输入用户名" required minlength="3">
        </div>
        <div class="form-group">
          <label>密码</label>
          <input type="password" id="authPassword" placeholder="请输入密码" required minlength="6">
        </div>
        <div class="form-group" id="confirmPasswordGroup" style="display:none;">
          <label>确认密码</label>
          <input type="password" id="authConfirmPassword" placeholder="请再次输入密码">
        </div>
        <button type="submit" class="btn btn-primary auth-submit" id="authSubmitBtn">登录</button>
        <p class="auth-hint">内测版本，注册后即可使用</p>
      </form>
      <button class="modal-close" onclick="closeAuthModal()">×</button>
    </div>
  </div>

  <!-- 个人中心弹窗 -->
  <div class="modal-overlay" id="profileModal">
    <div class="modal-content profile-modal">
      <h3 class="modal-title" data-i18n="profile.title">个人中心</h3>
      <div class="profile-info">
        <div class="profile-avatar">👤</div>
        <div class="profile-name" id="profileUsername">-</div>
      </div>
      <div class="quota-section">
        <h4 data-i18n="profile.quota">配额使用情况</h4>
        <div class="quota-item">
          <span data-i18n="profile.aiInsight">AI 洞察</span>
          <span id="quotaInsight">-/-</span>
        </div>
        <div class="quota-item">
          <span data-i18n="profile.meetingQa">会议问答</span>
          <span id="quotaQa">-/-</span>
        </div>
        <div class="quota-item">
          <span data-i18n="profile.imageGen">图片生成</span>
          <span id="quotaImage">-/-</span>
        </div>
      </div>
      <div class="language-section">
        <h4 data-i18n="profile.language">语言设置</h4>
        <div class="language-switcher">
          <button class="lang-btn" data-lang="zh" onclick="switchLanguage('zh')">
            <span>🇨🇳</span>
            <span>简体中文</span>
          </button>
          <button class="lang-btn" data-lang="en" onclick="switchLanguage('en')">
            <span>🇺🇸</span>
            <span>English</span>
          </button>
        </div>
      </div>
      <div class="meetings-section">
        <h4 data-i18n="profile.meetingHistory">会议历史</h4>
        <div class="meetings-list" id="meetingsList">
          <div class="meetings-empty" data-i18n="profile.noMeetings">暂无会议记录</div>
        </div>
      </div>
      <button class="btn btn-secondary" onclick="logout()" style="width:100%;margin-top:16px;" data-i18n="profile.logout">退出登录</button>
      <button class="modal-close" onclick="closeProfileModal()">×</button>
    </div>
  </div>

  <!-- 会议详情弹窗 -->
  <div class="modal-overlay" id="meetingDetailModal">
    <div class="modal-content meeting-detail-modal">
      <div class="meeting-detail-header">
        <div>
          <h3 class="meeting-detail-title" id="meetingDetailTitle">会议详情</h3>
          <div class="meeting-detail-meta" id="meetingDetailMeta">-</div>
        </div>
        <button class="btn-delete-meeting" id="deleteMeetingBtn" onclick="deleteMeeting()">删除会议</button>
      </div>
      <div class="meeting-detail-tabs">
        <button class="meeting-detail-tab active" data-tab="transcripts" onclick="switchMeetingTab('transcripts')">转写内容</button>
        <button class="meeting-detail-tab" data-tab="insights" onclick="switchMeetingTab('insights')">AI 洞察</button>
        <button class="meeting-detail-tab" data-tab="visualizations" onclick="switchMeetingTab('visualizations')">可视化</button>
      </div>
      <div class="meeting-detail-content">
        <div class="meeting-detail-section active" id="meetingTranscripts">
          <div class="detail-loading">加载中...</div>
        </div>
        <div class="meeting-detail-section" id="meetingInsights">
          <div class="detail-loading">加载中...</div>
        </div>
        <div class="meeting-detail-section" id="meetingVisualizations">
          <div class="detail-loading">加载中...</div>
        </div>
      </div>
      <button class="modal-close" onclick="closeMeetingDetailModal()">×</button>
    </div>
  </div>

  <script>
    // ========== 国际化配置 (i18n) ==========
    const i18n = {
      zh: {
        // 导航栏
        nav: {
          detecting: '检测中...',
          connected: '已连接',
          disconnected: '未连接',
          login: '登录',
        },
        // Hero区域
        hero: {
          badge: '您的数字参会者 · Digital Participant',
          title: 'MeetMind · 视界',
          subtitle: '不只是记录，而是真正参与',
          desc: '全程在场、深度理解、主动洞察 — 您会议中最懂行的那位',
        },
        // 录音控制
        recording: {
          ready: '准备就绪',
          recording: '录制中',
          paused: '已暂停',
          start: '开始录音',
          stop: '停止录音',
          pause: '暂停',
          resume: '继续',
          upload: '上传音频',
        },
        // 面板
        panel: {
          transcript: '全息记录',
          insight: '认知同频',
          emptyTranscript: '开始录音后，转写内容将实时显示',
          emptyInsight: '触发 AI 技能后，洞察将显示在这里',
        },
        // 侧边栏
        sidebar: {
          title: '会议记录',
          newMeeting: '新建会议',
          inProgress: '进行中',
          history: '历史会议',
          loginHint: '登录后查看历史会议',
          noMeetings: '暂无会议记录',
          noActiveMeetings: '暂无进行中的会议',
          noHistoryMeetings: '暂无历史会议',
          untitledMeeting: '未命名会议',
          recording: '● 录音中',
          paused: '⏸ 已暂停',
          completed: '✓ 已完成',
          loadMeetingContinue: '已加载会议，点击录音按钮继续',
          loadMeetingHistory: '已加载历史会议',
          loadMeetingFailed: '加载会议失败',
          switchMeetingConfirm: '当前正在录音，切换会议将停止录音。是否继续？',
          newMeetingConfirm: '当前正在录音，新建会议将停止当前录音。是否继续？',
        },
        // 认证
        auth: {
          login: '登录',
          register: '注册',
          username: '用户名',
          password: '密码',
          usernamePlaceholder: '请输入用户名',
          passwordPlaceholder: '请输入密码',
          hint: '内测版本，注册后即可使用',
          loginSuccess: '登录成功！',
          registerSuccess: '注册成功！',
          logoutSuccess: '已退出登录',
          operationFailed: '操作失败',
        },
        // 个人中心
        profile: {
          title: '个人中心',
          quota: '配额使用情况',
          aiInsight: 'AI 洞察',
          meetingQa: '会议问答',
          imageGen: '图片生成',
          meetingHistory: '会议历史',
          noMeetings: '暂无会议记录',
          logout: '退出登录',
          language: '语言设置',
          langZh: '简体中文',
          langEn: 'English',
        },
        // 会议详情
        meetingDetail: {
          title: '会议详情',
          transcripts: '转写内容',
          insights: 'AI 洞察',
          visualizations: '可视化',
          delete: '删除会议',
          deleteConfirm: '确定要删除这个会议吗？此操作不可恢复。',
          deleteSuccess: '会议已删除',
          deleteFailed: '删除失败',
          loading: '加载中...',
          noTranscripts: '暂无转写内容',
          noInsights: '暂无 AI 洞察',
          noVisualizations: '暂无可视化内容',
        },
        // 技能和工具栏
        skills: {
          innerOs: '潜台词',
          brainstorm: '灵感',
          stopTalking: '聚焦',
          autoAnalysis: '洞察',
          chart: '科研图表',
          creative: '创意图像',
          poster: '逻辑海报',
          visualization: '思维显影',
        },
        toolbar: {
          cognitiveSkills: '认知技能',
          cognitiveTranslate: '认知转译',
          breakInspiration: '破局灵感',
          agendaGuard: '议程守护',
          agentLinkage: '🤖 AI 智能分析',
          agentHint: '自动检测数据/跑题，智能生成洞察和图表',
          mindVisualization: '思维显影',
          dataChart: '📊 数据图表',
          creativeImage: '🎨 创意图像',
          logicPoster: '📋 逻辑海报',
          radarChart: '雷达图',
          flowChart: '流程图',
          archChart: '架构图',
          barChart: '柱状图',
          generateVis: '✨ 生成视觉化',
          meetingQA: '会议问答',
          qaWelcome: '👋 有问题随时问我，我会基于会议内容为你解答',
          inputQuestion: '输入问题...',
          send: '发送',
        },
        // 提示消息
        toast: {
          connectionSuccess: '后端服务连接成功',
          connectionFailed: '无法连接到后端服务',
          connectBackendFirst: '请先连接后端服务',
          envNotSupportMic: '当前环境不支持麦克风访问',
          creatingSession: '正在创建会话...',
          recordingStarted: '🎙️ 录音已开始',
          micPermissionDenied: '麦克风权限被拒绝',
          micNotFound: '未找到麦克风设备',
          recordingStartFailed: '录音启动失败',
          recordingStopped: '录音已停止',
          uploadSuccess: '上传成功',
          uploadFailed: '上传失败',
          processingAudio: '正在处理音频...',
          audioProcessFailed: '音频处理失败',
          needMicPermission: '需要麦克风权限',
          micPermissionHint: '请点击浏览器地址栏左侧的锁图标，允许访问麦克风后重试。',
          startBackend: '需要启动后端服务',
          startBackendHint: '请先启动后端服务',
          startRecordFirst: '请先开始录音',
          analysisDone: '分析完成',
          analysisFailed: '分析失败',
          agentOn: '🤖 AI 智能分析已开启',
          agentOff: 'AI 智能分析已关闭',
          uploadingFile: '上传中...',
          fileUploadSuccess: '文件上传成功，已开始转写',
          visualGenSuccess: '视觉化生成成功！',
          visualGenFailed: '生成失败',
          noTranscriptToDownload: '没有可下载的转写内容',
          wordDownloadSuccess: 'Word 文档下载成功',
          selectPdfSave: '请在打印对话框中选择"保存为 PDF"',
        },
        // 下载
        download: {
          word: 'Word 文档',
          pdf: 'PDF 文档',
        },
        // 其他
        misc: {
          clickToStop: '点击将停止当前录音',
          today: '今天',
          yesterday: '昨天',
        },
      },
      en: {
        // Navigation
        nav: {
          detecting: 'Detecting...',
          connected: 'Connected',
          disconnected: 'Disconnected',
          login: 'Login',
        },
        // Hero section
        hero: {
          badge: 'Your Digital Participant',
          title: 'MeetMind · Vision',
          subtitle: 'Not just recording, but truly participating',
          desc: 'Always present, deeply understanding, proactively insightful — the most knowledgeable one in your meeting',
        },
        // Recording controls
        recording: {
          ready: 'Ready',
          recording: 'Recording',
          paused: 'Paused',
          start: 'Start Recording',
          stop: 'Stop Recording',
          pause: 'Pause',
          resume: 'Resume',
          upload: 'Upload Audio',
        },
        // Panels
        panel: {
          transcript: 'Transcript',
          insight: 'Cognitive Sync',
          emptyTranscript: 'Transcription will appear here after recording starts',
          emptyInsight: 'Insights will appear here after triggering AI skills',
        },
        // Sidebar
        sidebar: {
          title: 'Meetings',
          newMeeting: 'New Meeting',
          inProgress: 'In Progress',
          history: 'History',
          loginHint: 'Login to view meeting history',
          noMeetings: 'No meetings yet',
          noActiveMeetings: 'No active meetings',
          noHistoryMeetings: 'No meeting history',
          untitledMeeting: 'Untitled Meeting',
          recording: '● Recording',
          paused: '⏸ Paused',
          completed: '✓ Completed',
          loadMeetingContinue: 'Meeting loaded, click record to continue',
          loadMeetingHistory: 'Historical meeting loaded',
          loadMeetingFailed: 'Failed to load meeting',
          switchMeetingConfirm: 'Currently recording. Switching will stop the recording. Continue?',
          newMeetingConfirm: 'Currently recording. Creating new meeting will stop recording. Continue?',
        },
        // Authentication
        auth: {
          login: 'Login',
          register: 'Register',
          username: 'Username',
          password: 'Password',
          usernamePlaceholder: 'Enter username',
          passwordPlaceholder: 'Enter password',
          hint: 'Beta version, register to start using',
          loginSuccess: 'Login successful!',
          registerSuccess: 'Registration successful!',
          logoutSuccess: 'Logged out',
          operationFailed: 'Operation failed',
        },
        // Profile
        profile: {
          title: 'Profile',
          quota: 'Quota Usage',
          aiInsight: 'AI Insights',
          meetingQa: 'Meeting Q&A',
          imageGen: 'Image Generation',
          meetingHistory: 'Meeting History',
          noMeetings: 'No meetings yet',
          logout: 'Logout',
          language: 'Language',
          langZh: '简体中文',
          langEn: 'English',
        },
        // Meeting details
        meetingDetail: {
          title: 'Meeting Details',
          transcripts: 'Transcripts',
          insights: 'AI Insights',
          visualizations: 'Visualizations',
          delete: 'Delete Meeting',
          deleteConfirm: 'Are you sure you want to delete this meeting? This cannot be undone.',
          deleteSuccess: 'Meeting deleted',
          deleteFailed: 'Delete failed',
          loading: 'Loading...',
          noTranscripts: 'No transcripts yet',
          noInsights: 'No AI insights yet',
          noVisualizations: 'No visualizations yet',
        },
        // Skills
        skills: {
          innerOs: 'Subtext',
          brainstorm: 'Brainstorm',
          stopTalking: 'Focus',
          autoAnalysis: 'Insight',
          chart: 'Research Chart',
          creative: 'Creative Image',
          poster: 'Logic Poster',
          visualization: 'Mind Visualization',
        },
        toolbar: {
          cognitiveSkills: 'AI Skills',
          cognitiveTranslate: 'Mind Reader',
          breakInspiration: 'Brainstorm',
          agendaGuard: 'Focus Guard',
          agentLinkage: '🤖 AI Analysis',
          agentHint: 'Auto-detect data/off-topic, generate insights and charts',
          mindVisualization: 'Visualization',
          dataChart: '📊 Data Chart',
          creativeImage: '🎨 Creative',
          logicPoster: '📋 Poster',
          radarChart: 'Radar',
          flowChart: 'Flowchart',
          archChart: 'Architecture',
          barChart: 'Bar Chart',
          generateVis: '✨ Generate',
          meetingQA: 'Meeting Q&A',
          qaWelcome: '👋 Ask me anything about the meeting',
          inputQuestion: 'Ask a question...',
          send: 'Send',
        },
        // Toast messages
        toast: {
          connectionSuccess: 'Backend connected successfully',
          connectionFailed: 'Cannot connect to backend',
          connectBackendFirst: 'Please connect to backend first',
          envNotSupportMic: 'Microphone not supported in this environment',
          creatingSession: 'Creating session...',
          recordingStarted: '🎙️ Recording started',
          micPermissionDenied: 'Microphone permission denied',
          micNotFound: 'Microphone not found',
          recordingStartFailed: 'Failed to start recording',
          recordingStopped: 'Recording stopped',
          uploadSuccess: 'Upload successful',
          uploadFailed: 'Upload failed',
          processingAudio: 'Processing audio...',
          audioProcessFailed: 'Audio processing failed',
          needMicPermission: 'Microphone permission required',
          micPermissionHint: 'Click the lock icon in browser address bar to allow microphone access.',
          startBackend: 'Backend service required',
          startBackendHint: 'Please start the backend service first',
          startRecordFirst: 'Please start recording first',
          analysisDone: 'Analysis completed',
          analysisFailed: 'Analysis failed',
          agentOn: '🤖 AI Analysis enabled',
          agentOff: 'AI Analysis disabled',
          uploadingFile: 'Uploading...',
          fileUploadSuccess: 'File uploaded, transcription started',
          visualGenSuccess: 'Visualization generated!',
          visualGenFailed: 'Generation failed',
          noTranscriptToDownload: 'No transcript to download',
          wordDownloadSuccess: 'Word document downloaded',
          selectPdfSave: 'Please select "Save as PDF" in print dialog',
        },
        // Download
        download: {
          word: 'Word Document',
          pdf: 'PDF Document',
        },
        // Misc
        misc: {
          clickToStop: 'Click to stop current recording',
          today: 'Today',
          yesterday: 'Yesterday',
        },
      },
    };

    // 获取翻译文本
    function t(key) {
      const lang = state.language || 'zh';
      const keys = key.split('.');
      let value = i18n[lang];
      for (const k of keys) {
        if (value && value[k] !== undefined) {
          value = value[k];
        } else {
          // 回退到中文
          value = i18n.zh;
          for (const k2 of keys) {
            value = value?.[k2];
          }
          break;
        }
      }
      return value || key;
    }

    // ========== State ==========
    const state = {
      sessionId: null,
      taskId: null,
      meetingId: null, // 当前会议ID
      isRecording: false,
      isPaused: false,
      isConnected: false,
      recordingStartTime: null,
      transcription: [],
      summaries: [],
      // 暂停前保存的转写内容（用于恢复时合并）
      savedTranscriptionBeforePause: [],
      savedSummariesBeforePause: [],
      savedAgentInsightsBeforePause: [],
      autoPushInterval: null, // 保留以兼容旧代码
      mediaRecorder: null,
      mediaStream: null, // 保存 MediaStream 以便暂停后恢复
      // 网络模式：自动检测当前访问的主机地址，支持局域网访问
      apiBaseUrl: localStorage.getItem('apiBaseUrl') || getDefaultApiUrl(),
      currentVisualizationType: 'chart',
      currentChartType: 'radar',
      // V3 Agent 状态
      agentEnabled: true,
      agentPollingInterval: null,
      agentInsights: [],
      lastInsightId: null,
      transcriptInsightMap: {}, // 转写ID -> 洞察ID 映射
      // 用户认证状态
      user: JSON.parse(localStorage.getItem('user') || 'null'),
      token: localStorage.getItem('token') || null,
      quota: null,
      authMode: 'login', // 'login' | 'register'
      currentMeetingId: null, // 当前查看的会议ID
      // 侧边栏状态
      sidebarOpen: false,
      meetings: [], // 会议列表缓存
      // 语言设置
      language: localStorage.getItem('language') || 'zh',
    };

    // ========== 网络模式配置 ==========
    // 自动检测后端地址
    function getDefaultApiUrl() {
      const hostname = window.location.hostname;
      // 如果是 localhost 或 127.0.0.1 或本地文件，使用本地后端
      if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '') {
        return 'http://localhost:4000';
      }
      // 如果是局域网 IP (192.168.x.x, 10.x.x.x, 172.16-31.x.x)，使用相同主机的后端
      if (/^(192\.168\.|10\.|172\.(1[6-9]|2[0-9]|3[01])\.)/.test(hostname)) {
        return `${window.location.protocol}//${window.location.host}`;
      }
      // 外网部署时，默认使用阿里云服务器地址
      return 'http://localhost:4000';
    }

    // 检查是否需要配置后端地址
    function checkBackendConfig() {
      if (!state.apiBaseUrl) {
        setTimeout(() => {
          showToast('请点击右上角设置后端地址', 'warning');
          openSettingsModal();
        }, 1000);
        return false;
      }
      return true;
    }

    // ========== DOM Elements ==========
    const $ = id => document.getElementById(id);
    const elements = {
      nav: $('nav'),
      connectionStatus: $('connectionStatus'),
      connectionText: $('connectionText'),
      recordingStatus: $('recordingStatus'),
      recordingStatusText: $('recordingStatusText'),
      recordingTimer: $('recordingTimer'),
      waveform: $('waveform'),
      recordBtn: $('recordBtn'),
      recordBtnText: $('recordBtnText'),
      pauseBtn: $('pauseBtn'),
      transcriptionList: $('transcriptionList'),
      summaryList: $('summaryList'),
      transcriptEmptyState: $('transcriptEmptyState'),
      insightEmptyState: $('insightEmptyState'),
      transcriptCount: $('transcriptCount'),
      insightCount: $('insightCount'),
      qaMessages: $('qaMessages'),
      qaInput: $('qaInput'),
      qaSendBtn: $('qaSendBtn'),
      toastContainer: $('toastContainer'),
      alertBanner: $('alertBanner'),
      alertTitle: $('alertTitle'),
      alertContent: $('alertContent'),
      uploadInput: $('uploadInput'),
      uploadBtn: $('uploadBtn'),
      visGenerateBtn: $('visGenerateBtn'),
      visStatus: $('visStatus'),
      chartTypeSelect: $('chartTypeSelect'),
      visualizationList: $('visualizationList'),
      downloadDropdown: $('downloadDropdown'),
      // V3 Agent 元素
      agentToggle: $('agentToggle'),
      // 用户认证元素
      userBtn: $('userBtn'),
      userBtnText: $('userBtnText'),
    };

    // ========== Initialize ==========
    function init() {
      setupNavScroll();
      setupWaveform();
      setupUpload();
      setupScrollListeners();
      initAuth(); // 初始化认证状态
      initSidebar(); // 初始化侧边栏
      initLanguage(); // 初始化语言设置
      
      // 检查后端配置
      if (checkBackendConfig()) {
        testConnection();
      }
    }

    // ========== Sidebar Functions ==========
    function initSidebar() {
      // 如果已登录，加载会议列表
      if (state.token) {
        loadSidebarMeetings();
      }
    }

    function toggleSidebar() {
      state.sidebarOpen = !state.sidebarOpen;
      updateSidebarUI();
    }

    function openSidebar() {
      state.sidebarOpen = true;
      updateSidebarUI();
      if (state.token) {
        loadSidebarMeetings();
      }
    }

    function closeSidebar() {
      state.sidebarOpen = false;
      updateSidebarUI();
    }

    function updateSidebarUI() {
      const sidebar = $('sidebar');
      const overlay = $('sidebarOverlay');
      const toggle = $('sidebarToggle');
      
      if (state.sidebarOpen) {
        sidebar.classList.add('open');
        overlay.classList.add('show');
        toggle.classList.add('hidden');
      } else {
        sidebar.classList.remove('open');
        overlay.classList.remove('show');
        toggle.classList.remove('hidden');
      }
    }

    async function loadSidebarMeetings() {
      if (!state.token) {
        $('historyMeetingList').innerHTML = `
          <div class="meeting-list-empty">
            <div class="meeting-list-empty-icon">🔐</div>
            <div>${t('sidebar.loginHint')}</div>
          </div>
        `;
        return;
      }

      try {
        const response = await fetch(`${state.apiBaseUrl}/users/me/meetings`, {
          headers: { 'Authorization': `Bearer ${state.token}`, ...getNgrokHeaders() },
        });
        const data = await response.json();
        
        if (data.success && data.meetings) {
          state.meetings = data.meetings;
          renderSidebarMeetings(data.meetings);
        }
      } catch (error) {
        console.error('Failed to load meetings:', error);
      }
    }

    function renderSidebarMeetings(meetings) {
      const activeList = $('activeMeetingList');
      const historyList = $('historyMeetingList');
      
      // 分离进行中和已完成的会议
      const activeMeetings = meetings.filter(m => m.status === 'recording' || m.status === 'paused');
      const completedMeetings = meetings.filter(m => m.status === 'completed' || !m.status);
      
      // 渲染进行中的会议
      if (activeMeetings.length > 0 || state.isRecording) {
        let activeHtml = '';
        const untitledText = t('sidebar.untitledMeeting');
        
        // 如果当前正在录音但不在列表中，显示当前会议
        if (state.isRecording && state.meetingId) {
          const currentInList = activeMeetings.find(m => m.id === state.meetingId);
          if (!currentInList) {
            activeHtml += `
              <div class="meeting-list-item active recording" onclick="selectMeeting('${state.meetingId}')">
                <div class="meeting-list-item__title">${state.language === 'zh' ? '当前会议' : 'Current Meeting'}</div>
                <div class="meeting-list-item__meta">
                  <span class="meeting-list-item__status recording">
                    <span style="animation: pulse-glow 1s infinite;">●</span> ${state.language === 'zh' ? '录音中' : 'Recording'}
                  </span>
                </div>
              </div>
            `;
          }
        }
        
        activeHtml += activeMeetings.map(m => `
          <div class="meeting-list-item ${m.id === state.meetingId ? 'active' : ''} ${m.status === 'recording' ? 'recording' : ''}" 
               onclick="selectMeeting('${m.id}')">
            <div class="meeting-list-item__title">${escapeHtml(m.title || untitledText)}</div>
            <div class="meeting-list-item__meta">
              <span class="meeting-list-item__status ${m.status === 'recording' ? 'recording' : ''}">
                ${m.status === 'recording' ? t('sidebar.recording') : t('sidebar.paused')}
              </span>
            </div>
          </div>
        `).join('');
        
        activeList.innerHTML = activeHtml || `<div class="meeting-list-empty" style="padding: 12px;">${t('sidebar.noActiveMeetings')}</div>`;
      } else {
        activeList.innerHTML = `<div class="meeting-list-empty" style="padding: 12px;">${t('sidebar.noActiveMeetings')}</div>`;
      }
      
      // 渲染历史会议
      const untitledTextHistory = t('sidebar.untitledMeeting');
      if (completedMeetings.length > 0) {
        historyList.innerHTML = completedMeetings.slice(0, 20).map(m => `
          <div class="meeting-list-item ${m.id === state.currentMeetingId ? 'active' : ''}" 
               onclick="selectMeeting('${m.id}')">
            <div class="meeting-list-item__title">${escapeHtml(m.title || untitledTextHistory)}</div>
            <div class="meeting-list-item__meta">
              <span>${formatMeetingDate(m.created_at)}</span>
              <span class="meeting-list-item__status completed">${t('sidebar.completed')}</span>
            </div>
          </div>
        `).join('');
      } else {
        historyList.innerHTML = `
          <div class="meeting-list-empty">
            <div class="meeting-list-empty-icon">📂</div>
            <div>${t('sidebar.noHistoryMeetings')}</div>
          </div>
        `;
      }
    }

    async function selectMeeting(meetingId) {
      // 转换为数字以确保类型一致
      const numMeetingId = typeof meetingId === 'string' ? parseInt(meetingId, 10) : meetingId;
      
      // 如果选择的是当前正在录音的会议，只关闭侧边栏
      if (numMeetingId === state.meetingId && state.isRecording) {
        closeSidebar();
        return;
      }
      
      // 如果正在录音，提示用户
      if (state.isRecording) {
        if (!confirm(t('sidebar.switchMeetingConfirm'))) {
          return;
        }
        await stopRecording();
      }
      
      // 加载选中的会议
      await loadMeetingToView(meetingId);
      closeSidebar();
    }

    async function loadMeetingToView(meetingId) {
      try {
        const response = await fetch(`${state.apiBaseUrl}/users/me/meetings/${meetingId}`, {
          headers: { 'Authorization': `Bearer ${state.token}`, ...getNgrokHeaders() },
        });
        const data = await response.json();
        
        if (data.success && data.meeting) {
          const meeting = data.meeting;
          
          // 清空当前状态
          state.transcription = [];
          state.summaries = [];
          state.agentInsights = [];
          state.meetingId = meetingId;
          state.currentMeetingId = meetingId;
          
          // 先清空UI
          elements.summaryList.innerHTML = `
            <div class="empty-state" id="insightEmptyState">
              <div class="empty-state__icon">💡</div>
              <p class="empty-state__text">触发 AI 技能后，洞察将显示在这里</p>
            </div>
            <div id="visualizationList"></div>
          `;
          elements.visualizationList = $('visualizationList');
          elements.insightEmptyState = $('insightEmptyState');
          
          // 恢复转写内容 - 使用正确的字段名 startMs/endMs
          if (meeting.transcripts && meeting.transcripts.length > 0) {
            meeting.transcripts.forEach(t => {
              state.transcription.push({
                id: t.id || `transcript-${state.transcription.length}`,
                text: t.content,
                startMs: t.start_ms || 0,
                endMs: t.end_ms || 0,
              });
            });
            renderTranscriptionFromState();
          } else {
            renderTranscriptionFromState();
          }
          
          // 恢复洞察内容
          if (meeting.insights && meeting.insights.length > 0) {
            meeting.insights.forEach(i => {
              addInsightCard({
                type: i.type,
                title: getInsightTypeName(i.type),
                content: i.content,
                timestamp: new Date(i.created_at).getTime(),
              });
            });
          }
          
          // 恢复可视化
          if (meeting.visualizations && meeting.visualizations.length > 0) {
            meeting.visualizations.forEach(v => {
              if (v.image_path) {
                addVisualizationCard({
                  type: v.type,
                  chartType: v.chart_type,
                  imageUrl: `${state.apiBaseUrl}/uploads/${v.image_path}`,
                });
              }
            });
          }
          
          // 检查会议状态，如果是进行中的会议，可以继续
          if (meeting.status === 'recording' || meeting.status === 'paused') {
            showToast(t('sidebar.loadMeetingContinue'), 'info');
            // 可以在这里恢复会话
            state.sessionId = meeting.session_id;
          } else {
            showToast(t('sidebar.loadMeetingHistory'), 'success');
          }
          
          // 更新侧边栏高亮
          loadSidebarMeetings();
        }
      } catch (error) {
        console.error('Failed to load meeting:', error);
        showToast(t('sidebar.loadMeetingFailed'), 'error');
      }
    }

    // 添加洞察卡片到面板
    function addInsightCard(insight) {
      const typeInfo = INSIGHT_TYPES[insight.type] || INSIGHT_TYPES.auto_analysis;
      const time = insight.timestamp ? new Date(insight.timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }) : '';
      
      // 解析content（可能是JSON字符串）
      let content = insight.content;
      if (typeof content === 'string') {
        try {
          content = JSON.parse(content);
        } catch (e) {
          // 保持原样
        }
      }
      
      const formattedContent = formatInsightContent(content, insight.type);
      
      const card = document.createElement('article');
      card.className = 'insight-card';
      card.dataset.type = insight.type;
      card.innerHTML = `
        <header class="insight-card__header">
          <span class="insight-card__icon">${typeInfo.icon}</span>
          <h3 class="insight-card__title">${insight.title || typeInfo.title}</h3>
          <time class="insight-card__time">${time}</time>
        </header>
        <div class="insight-card__content">${formattedContent}</div>
      `;
      
      // 隐藏空状态
      if (elements.insightEmptyState) {
        elements.insightEmptyState.style.display = 'none';
      }
      
      // 添加到洞察列表（在 visualizationList 之前）
      const visList = document.getElementById('visualizationList');
      if (visList) {
        elements.summaryList.insertBefore(card, visList);
      } else {
        elements.summaryList.appendChild(card);
      }
      
      // 更新计数
      elements.insightCount.textContent = parseInt(elements.insightCount.textContent || '0') + 1;
    }

    // 添加可视化卡片到面板
    function addVisualizationCard(vis) {
      const typeLabels = { chart: '科研图表', creative: '创意图像', poster: '逻辑海报' };
      
      const card = document.createElement('div');
      card.className = 'insight-card';
      card.innerHTML = `
        <header class="insight-card__header">
          <span class="insight-card__icon">🎨</span>
          <h3 class="insight-card__title">${typeLabels[vis.type] || '思维显影'}</h3>
        </header>
        ${vis.imageUrl ? `<img src="${vis.imageUrl}" alt="视觉化" style="width:100%;border-radius:var(--radius-md);cursor:pointer;margin-top:12px;" onclick="showImageModal(this.src)" onerror="this.style.display='none'">` : ''}
      `;
      
      // 隐藏空状态
      if (elements.insightEmptyState) {
        elements.insightEmptyState.style.display = 'none';
      }
      
      // 添加到可视化列表
      if (elements.visualizationList) {
        elements.visualizationList.appendChild(card);
      } else {
        elements.summaryList.appendChild(card);
      }
    }

    function renderTranscriptionFromState() {
      if (state.transcription.length === 0) {
        elements.transcriptionList.innerHTML = `
          <div class="empty-state" id="transcriptEmptyState">
            <div class="empty-state__icon">🎤</div>
            <p class="empty-state__text">开始录音后，转写内容将实时显示</p>
          </div>
        `;
        elements.transcriptCount.textContent = '0';
        elements.downloadDropdown.style.display = 'none';
        return;
      }
      
      // 使用正确的字段名 startMs/endMs
      elements.transcriptionList.innerHTML = state.transcription.map(t => `
        <div class="transcript-item" data-id="${t.id || ''}">
          <div class="transcript-time">${formatTime(t.startMs)}${t.endMs !== t.startMs ? ' - ' + formatTime(t.endMs) : ''}</div>
          <div class="transcript-text">${escapeHtml(t.text)}</div>
        </div>
      `).join('');
      
      elements.transcriptCount.textContent = state.transcription.length;
      elements.downloadDropdown.style.display = 'block';
    }

    async function startNewMeeting() {
      // 如果正在录音，提示用户
      if (state.isRecording) {
        if (!confirm(t('sidebar.newMeetingConfirm'))) {
          return;
        }
        await stopRecording();
      }
      
      // 清空状态
      state.sessionId = null;
      state.meetingId = null;
      state.transcription = [];
      state.summaries = [];
      state.agentInsights = [];
      
      // 清空UI
      elements.transcriptionList.innerHTML = `
        <div class="empty-state" id="transcriptEmptyState">
          <div class="empty-state__icon">🎤</div>
          <p class="empty-state__text">开始录音后，转写内容将实时显示</p>
        </div>
      `;
      elements.summaryList.innerHTML = `
        <div class="empty-state" id="insightEmptyState">
          <div class="empty-state__icon">💡</div>
          <p class="empty-state__text">触发 AI 技能后，洞察将显示在这里</p>
        </div>
        <div id="visualizationList"></div>
      `;
      elements.transcriptCount.textContent = '0';
      elements.insightCount.textContent = '0';
      elements.downloadDropdown.style.display = 'none';
      
      closeSidebar();
      showToast('已创建新会议，点击录音按钮开始', 'info');
    }

    // ========== Auth Functions ==========
    function initAuth() {
      if (state.token && state.user) {
        updateUserUI();
        fetchQuota();
        loadSidebarMeetings(); // 登录状态下加载会议列表
      }
    }

    function updateUserUI() {
      if (state.user) {
        elements.userBtnText.textContent = state.user.username;
      } else {
        elements.userBtnText.textContent = t('nav.login');
      }
    }

    function handleUserClick() {
      if (state.user) {
        openProfileModal();
      } else {
        openAuthModal();
      }
    }

    function openAuthModal() {
      $('authModal').classList.add('show');
      state.authMode = 'login';
      switchAuthTab('login');
    }

    function closeAuthModal() {
      $('authModal').classList.remove('show');
    }

    // ========== 后端设置弹窗 ==========
    function openSettingsModal() {
      $('settingsModal').classList.add('show');
      $('currentApiUrl').textContent = state.apiBaseUrl;
      $('apiUrlInput').value = state.apiBaseUrl;
    }

    function closeSettingsModal() {
      $('settingsModal').classList.remove('show');
    }

    function saveApiUrl() {
      const newUrl = $('apiUrlInput').value.trim();
      if (!newUrl) {
        showToast('请输入后端地址', 'error');
        return;
      }
      // 移除末尾斜杠
      const cleanUrl = newUrl.replace(/\/+$/, '');
      state.apiBaseUrl = cleanUrl;
      localStorage.setItem('apiBaseUrl', cleanUrl);
      $('currentApiUrl').textContent = cleanUrl;
      showToast('后端地址已保存，正在测试连接...', 'info');
      closeSettingsModal();
      testConnection();
    }

    function resetApiUrl() {
      const defaultUrl = getDefaultApiUrl();
      $('apiUrlInput').value = defaultUrl;
      state.apiBaseUrl = defaultUrl;
      localStorage.removeItem('apiBaseUrl');
      $('currentApiUrl').textContent = defaultUrl;
      showToast('已重置为默认地址', 'info');
    }

    function openProfileModal() {
      $('profileModal').classList.add('show');
      $('profileUsername').textContent = state.user?.username || '-';
      updateQuotaDisplay();
      fetchMeetings();
    }

    function closeProfileModal() {
      $('profileModal').classList.remove('show');
    }

    function switchAuthTab(tab) {
      state.authMode = tab;
      document.querySelectorAll('.auth-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tab);
      });
      $('confirmPasswordGroup').style.display = tab === 'register' ? 'block' : 'none';
      $('authSubmitBtn').textContent = tab === 'login' ? t('auth.login') : t('auth.register');
    }

    async function handleAuth(e) {
      e.preventDefault();
      const username = $('authUsername').value.trim();
      const password = $('authPassword').value;
      
      console.log('handleAuth called, mode:', state.authMode, 'username:', username);
      
      if (state.authMode === 'register') {
        const confirmPassword = $('authConfirmPassword').value;
        if (password !== confirmPassword) {
          showToast('两次输入的密码不一致', 'error');
          return;
        }
      }

      try {
        const endpoint = state.authMode === 'login' ? '/auth/login' : '/auth/register';
        console.log('Sending request to:', state.apiBaseUrl + endpoint);
        
        const response = await fetch(`${state.apiBaseUrl}${endpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...getNgrokHeaders() },
          body: JSON.stringify({ username, password }),
        });
        
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
          state.user = data.user;
          state.token = data.token;
          localStorage.setItem('user', JSON.stringify(data.user));
          localStorage.setItem('token', data.token);
          updateUserUI();
          closeAuthModal();
          fetchQuota();
          loadSidebarMeetings(); // 登录后刷新会议列表
          showToast(state.authMode === 'login' ? t('auth.loginSuccess') : t('auth.registerSuccess'), 'success');
        } else {
          showToast(data.message || t('auth.operationFailed'), 'error');
        }
      } catch (error) {
        console.error('Auth error:', error);
        showToast(state.language === 'zh' ? '网络错误，请重试' : 'Network error, please retry', 'error');
      }
    }

    function logout() {
      state.user = null;
      state.token = null;
      state.quota = null;
      localStorage.removeItem('user');
      localStorage.removeItem('token');
      updateUserUI();
      closeProfileModal();
      showToast(t('auth.logoutSuccess'), 'info');
    }

    // ========== 语言切换 ==========
    function switchLanguage(lang) {
      if (lang === state.language) return;
      
      state.language = lang;
      localStorage.setItem('language', lang);
      
      // 更新语言按钮状态
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });
      
      // 更新整个UI
      updateAllI18nText();
      
      // 更新HTML lang属性
      document.documentElement.lang = lang === 'zh' ? 'zh-CN' : 'en';
      
      showToast(lang === 'zh' ? '已切换为中文' : 'Switched to English', 'success');
    }

    function updateAllI18nText() {
      // 更新所有带 data-i18n 属性的元素
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });
      
      // 更新所有带 data-i18n-placeholder 属性的输入框
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        el.placeholder = t(key);
      });
      
      // 更新特定的动态内容
      updateDynamicI18nContent();
    }

    function updateDynamicI18nContent() {
      // 更新导航栏连接状态
      const connectionText = $('connectionText');
      if (connectionText) {
        if (state.isConnected) {
          connectionText.textContent = t('nav.connected');
        } else if (connectionText.textContent.includes('检测') || connectionText.textContent.includes('Detecting')) {
          connectionText.textContent = t('nav.detecting');
        } else {
          connectionText.textContent = t('nav.disconnected');
        }
      }
      
      // 更新用户按钮
      if (!state.user && elements.userBtnText) {
        elements.userBtnText.textContent = t('nav.login');
      }
      
      // 更新录音状态
      updateRecordingUI();
      
      // 更新空状态
      const transcriptEmpty = document.querySelector('#transcriptEmptyState .empty-state__text');
      if (transcriptEmpty) {
        transcriptEmpty.textContent = t('panel.emptyTranscript');
      }
      
      const insightEmpty = document.querySelector('#insightEmptyState .empty-state__text');
      if (insightEmpty) {
        insightEmpty.textContent = t('panel.emptyInsight');
      }
      
      // 更新侧边栏
      const sidebarTitle = document.querySelector('.sidebar-title');
      if (sidebarTitle) sidebarTitle.textContent = t('sidebar.title');
      
      const newMeetingBtn = document.querySelector('#newMeetingBtn span:last-child');
      if (newMeetingBtn) newMeetingBtn.textContent = t('sidebar.newMeeting');
      
      const sectionTitles = document.querySelectorAll('.sidebar-section-title');
      if (sectionTitles[0]) sectionTitles[0].textContent = t('sidebar.inProgress');
      if (sectionTitles[1]) sectionTitles[1].textContent = t('sidebar.history');
      
      // 更新面板标题
      const panelTitles = document.querySelectorAll('.panel__title');
      panelTitles.forEach(title => {
        const icon = title.querySelector('.panel__title-icon');
        const count = title.querySelector('.panel__count');
        if (icon && icon.textContent === '📝') {
          title.childNodes.forEach(node => {
            if (node.nodeType === 3 && node.textContent.trim()) {
              node.textContent = '\n            ' + t('panel.transcript') + '\n            ';
            }
          });
        } else if (icon && (icon.textContent === '✨' || icon.textContent === '💡')) {
          title.childNodes.forEach(node => {
            if (node.nodeType === 3 && node.textContent.trim()) {
              node.textContent = '\n            ' + t('panel.insight') + '\n            ';
            }
          });
        }
      });
      
      // 更新上传按钮
      const uploadBtnText = document.querySelector('#uploadBtn span:last-child');
      if (uploadBtnText) uploadBtnText.textContent = t('recording.upload');
      
      // 更新下载菜单
      const downloadItems = document.querySelectorAll('.download-menu-item');
      if (downloadItems[0]) {
        const span = downloadItems[0].querySelector('span');
        if (span) downloadItems[0].innerHTML = `<span>📄</span> ${t('download.word')}`;
      }
      if (downloadItems[1]) {
        const span = downloadItems[1].querySelector('span');
        if (span) downloadItems[1].innerHTML = `<span>📑</span> ${t('download.pdf')}`;
      }
      
      // 更新Hero区域
      const heroBadge = document.querySelector('.hero-badge span');
      if (heroBadge) heroBadge.textContent = t('hero.badge');
      
      const heroTitle = document.querySelector('.hero-title');
      if (heroTitle) {
        heroTitle.innerHTML = `${t('hero.title')}<br><span class="hero-title-gradient">${t('hero.subtitle')}</span>`;
      }
      
      const heroSubtitle = document.querySelector('.hero-subtitle');
      if (heroSubtitle) heroSubtitle.textContent = t('hero.desc');
      
      // 更新登录弹窗
      const authTabs = document.querySelectorAll('.auth-tab');
      if (authTabs[0]) authTabs[0].textContent = t('auth.login');
      if (authTabs[1]) authTabs[1].textContent = t('auth.register');
      
      const authLabels = document.querySelectorAll('#authForm .form-group label');
      if (authLabels[0]) authLabels[0].textContent = t('auth.username');
      if (authLabels[1]) authLabels[1].textContent = t('auth.password');
      
      const authUsername = $('authUsername');
      if (authUsername) authUsername.placeholder = t('auth.usernamePlaceholder');
      
      const authPassword = $('authPassword');
      if (authPassword) authPassword.placeholder = t('auth.passwordPlaceholder');
      
      const authSubmitBtn = $('authSubmitBtn');
      if (authSubmitBtn) authSubmitBtn.textContent = state.authMode === 'login' ? t('auth.login') : t('auth.register');
      
      const authHint = document.querySelector('.auth-hint');
      if (authHint) authHint.textContent = t('auth.hint');
      
      // 更新会议详情弹窗
      const meetingDetailTitle = $('meetingDetailTitle');
      if (meetingDetailTitle && (meetingDetailTitle.textContent.includes('会议详情') || meetingDetailTitle.textContent.includes('Meeting Details'))) {
        meetingDetailTitle.textContent = t('meetingDetail.title');
      }
      
      const deleteMeetingBtn = $('deleteMeetingBtn');
      if (deleteMeetingBtn) deleteMeetingBtn.textContent = t('meetingDetail.delete');
      
      const meetingTabs = document.querySelectorAll('.meeting-detail-tab');
      if (meetingTabs[0]) meetingTabs[0].textContent = t('meetingDetail.transcripts');
      if (meetingTabs[1]) meetingTabs[1].textContent = t('meetingDetail.insights');
      if (meetingTabs[2]) meetingTabs[2].textContent = t('meetingDetail.visualizations');
      
      // 更新图表类型选择器
      const chartTypeSelect = $('chartTypeSelect');
      if (chartTypeSelect) {
        const options = chartTypeSelect.querySelectorAll('option');
        if (options[0]) options[0].textContent = t('toolbar.radarChart');
        if (options[1]) options[1].textContent = t('toolbar.flowChart');
        if (options[2]) options[2].textContent = t('toolbar.archChart');
        if (options[3]) options[3].textContent = t('toolbar.barChart');
      }
      
      // 更新问答输入框 placeholder
      const qaInput = $('qaInput');
      if (qaInput) qaInput.placeholder = t('toolbar.inputQuestion');
      
      // 更新问答欢迎消息
      const qaWelcome = document.querySelector('#qaMessages .qa-message.assistant');
      if (qaWelcome && !qaWelcome.classList.contains('user-asked')) {
        qaWelcome.textContent = t('toolbar.qaWelcome');
      }
    }

    function initLanguage() {
      // 设置语言按钮初始状态
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === state.language);
      });
      
      // 如果是英文，更新所有文本
      if (state.language === 'en') {
        updateAllI18nText();
        document.documentElement.lang = 'en';
      }
    }

    async function fetchQuota() {
      if (!state.token) return;
      
      try {
        const response = await fetch(`${state.apiBaseUrl}/quota/status`, {
          headers: { 'Authorization': `Bearer ${state.token}`, ...getNgrokHeaders() },
        });
        const data = await response.json();
        if (data.success) {
          state.quota = data.quota;
          updateQuotaDisplay();
        }
      } catch (error) {
        console.error('Failed to fetch quota:', error);
      }
    }

    function updateQuotaDisplay() {
      if (!state.quota) return;
      $('quotaInsight').textContent = `${state.quota.dailyInsight.used}/${state.quota.dailyInsight.limit}`;
      $('quotaQa').textContent = `${state.quota.dailyQa.used}/${state.quota.dailyQa.limit}`;
      $('quotaImage').textContent = `${state.quota.monthlyImage.used}/${state.quota.monthlyImage.limit}`;
    }

    async function fetchMeetings() {
      if (!state.token) return;
      
      try {
        const response = await fetch(`${state.apiBaseUrl}/users/me/meetings`, {
          headers: { 'Authorization': `Bearer ${state.token}`, ...getNgrokHeaders() },
        });
        const data = await response.json();
        if (data.success && data.meetings) {
          renderMeetingsList(data.meetings);
        }
      } catch (error) {
        console.error('Failed to fetch meetings:', error);
      }
    }

    function renderMeetingsList(meetings) {
      const container = $('meetingsList');
      if (!meetings || meetings.length === 0) {
        container.innerHTML = `<div class="meetings-empty">${t('profile.noMeetings')}</div>`;
        return;
      }
      
      const untitledText = state.language === 'zh' ? '未命名会议' : 'Untitled Meeting';
      container.innerHTML = meetings.slice(0, 10).map(m => `
        <div class="meeting-item" onclick="viewMeeting('${m.id}')">
          <span class="meeting-item-title">${escapeHtml(m.title || untitledText)}</span>
          <span class="meeting-item-date">${formatMeetingDate(m.created_at)}</span>
        </div>
      `).join('');
    }

    function formatMeetingDate(dateStr) {
      const d = new Date(dateStr);
      return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    function viewMeeting(meetingId) {
      openMeetingDetailModal(meetingId);
    }

    async function openMeetingDetailModal(meetingId) {
      state.currentMeetingId = meetingId;
      $('meetingDetailModal').classList.add('show');
      $('meetingDetailTitle').textContent = t('meetingDetail.loading');
      $('meetingDetailMeta').textContent = '';
      $('meetingTranscripts').innerHTML = `<div class="detail-loading">${t('meetingDetail.loading')}</div>`;
      $('meetingInsights').innerHTML = `<div class="detail-loading">${t('meetingDetail.loading')}</div>`;
      $('meetingVisualizations').innerHTML = `<div class="detail-loading">${t('meetingDetail.loading')}</div>`;
      
      // 重置tab状态
      document.querySelectorAll('.meeting-detail-tab').forEach(t => t.classList.remove('active'));
      document.querySelector('.meeting-detail-tab[data-tab="transcripts"]').classList.add('active');
      document.querySelectorAll('.meeting-detail-section').forEach(s => s.classList.remove('active'));
      $('meetingTranscripts').classList.add('active');
      
      try {
        const response = await fetch(`${state.apiBaseUrl}/users/me/meetings/${meetingId}`, {
          headers: { 'Authorization': `Bearer ${state.token}`, ...getNgrokHeaders() },
        });
        const data = await response.json();
        
        if (data.success && data.meeting) {
          renderMeetingDetail(data.meeting);
        } else {
          showToast(data.message || (state.language === 'zh' ? '加载失败' : 'Load failed'), 'error');
          closeMeetingDetailModal();
        }
      } catch (error) {
        console.error('Failed to load meeting detail:', error);
        showToast(state.language === 'zh' ? '加载会议详情失败' : 'Failed to load meeting details', 'error');
        closeMeetingDetailModal();
      }
    }

    function renderMeetingDetail(meeting) {
      // 标题和元信息
      $('meetingDetailTitle').textContent = meeting.title || t('sidebar.untitledMeeting');
      const date = new Date(meeting.created_at);
      const duration = meeting.duration_ms ? formatDuration(meeting.duration_ms) : (state.language === 'zh' ? '未知' : 'Unknown');
      const durationLabel = state.language === 'zh' ? '时长' : 'Duration';
      $('meetingDetailMeta').textContent = `${date.toLocaleString(state.language === 'zh' ? 'zh-CN' : 'en-US')} · ${durationLabel}: ${duration}`;
      
      // 转写内容
      if (meeting.transcripts && meeting.transcripts.length > 0) {
        $('meetingTranscripts').innerHTML = meeting.transcripts.map(t => `
          <div class="transcript-item-detail">
            <div class="time">${formatTime(t.start_ms)} - ${formatTime(t.end_ms)}</div>
            <div class="text">${escapeHtml(t.content)}</div>
          </div>
        `).join('');
      } else {
        $('meetingTranscripts').innerHTML = `<div class="detail-empty">${t('meetingDetail.noTranscripts')}</div>`;
      }
      
      // 认知同频
      if (meeting.insights && meeting.insights.length > 0) {
        $('meetingInsights').innerHTML = meeting.insights.map(i => `
          <div class="insight-item-detail">
            <div class="type">${getInsightTypeName(i.type)}</div>
            <div class="content">${escapeHtml(i.content)}</div>
          </div>
        `).join('');
      } else {
        $('meetingInsights').innerHTML = `<div class="detail-empty">${t('meetingDetail.noInsights')}</div>`;
      }
      
      // 可视化
      if (meeting.visualizations && meeting.visualizations.length > 0) {
        $('meetingVisualizations').innerHTML = meeting.visualizations.map(v => `
          <div class="vis-item-detail">
            ${v.image_path ? `<img src="${state.apiBaseUrl}/uploads/${v.image_path}" alt="${state.language === 'zh' ? '可视化图片' : 'Visualization'}" onerror="this.style.display='none'">` : ''}
            <div class="type">${getVisTypeName(v.type, v.chart_type)}</div>
          </div>
        `).join('');
      } else {
        $('meetingVisualizations').innerHTML = `<div class="detail-empty">${t('meetingDetail.noVisualizations')}</div>`;
      }
    }

    function closeMeetingDetailModal() {
      $('meetingDetailModal').classList.remove('show');
      state.currentMeetingId = null;
    }

    async function deleteMeeting() {
      if (!state.currentMeetingId) return;
      
      if (!confirm(t('meetingDetail.deleteConfirm'))) return;
      
      try {
        const response = await fetch(`${state.apiBaseUrl}/users/me/meetings/${state.currentMeetingId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${state.token}`, ...getNgrokHeaders() },
        });
        const data = await response.json();
        
        if (data.success) {
          showToast(t('meetingDetail.deleteSuccess'), 'success');
          closeMeetingDetailModal();
          fetchMeetings(); // 刷新会议列表
        } else {
          showToast(data.message || t('meetingDetail.deleteFailed'), 'error');
        }
      } catch (error) {
        console.error('Failed to delete meeting:', error);
        showToast(t('meetingDetail.deleteFailed'), 'error');
      }
    }

    function switchMeetingTab(tab) {
      document.querySelectorAll('.meeting-detail-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tab);
      });
      document.querySelectorAll('.meeting-detail-section').forEach(s => s.classList.remove('active'));
      
      if (tab === 'transcripts') $('meetingTranscripts').classList.add('active');
      else if (tab === 'insights') $('meetingInsights').classList.add('active');
      else if (tab === 'visualizations') $('meetingVisualizations').classList.add('active');
    }

    function formatTime(ms) {
      if (!ms && ms !== 0) return '--:--';
      const totalSec = Math.floor(ms / 1000);
      const min = Math.floor(totalSec / 60);
      const sec = totalSec % 60;
      return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
    }

    function formatDuration(ms) {
      if (!ms) return '0分钟';
      const totalMin = Math.floor(ms / 60000);
      if (state.language === 'zh') {
        if (totalMin < 60) return `${totalMin}分钟`;
        const hours = Math.floor(totalMin / 60);
        const mins = totalMin % 60;
        return `${hours}小时${mins}分钟`;
      } else {
        if (totalMin < 60) return `${totalMin} min`;
        const hours = Math.floor(totalMin / 60);
        const mins = totalMin % 60;
        return `${hours}h ${mins}m`;
      }
    }

    function getInsightTypeName(type) {
      const names = state.language === 'zh' ? {
        'inner_os': '认知转译',
        'brainstorm': '破局灵感',
        'stop_talking': '议程守护',
        'summary': '会议摘要',
        'action_items': '待办事项',
        'key_points': '关键要点'
      } : {
        'inner_os': 'Mind Reader',
        'brainstorm': 'Brainstorm',
        'stop_talking': 'Focus Guard',
        'summary': 'Summary',
        'action_items': 'Action Items',
        'key_points': 'Key Points'
      };
      return names[type] || type;
    }

    function getVisTypeName(type, chartType) {
      if (type === 'chart') {
        const chartNames = state.language === 'zh' ? {
          'radar': '雷达图',
          'flowchart': '流程图',
          'architecture': '架构图',
          'bar': '柱状图',
          'line': '折线图'
        } : {
          'radar': 'Radar Chart',
          'flowchart': 'Flowchart',
          'architecture': 'Architecture',
          'bar': 'Bar Chart',
          'line': 'Line Chart'
        };
        return chartNames[chartType] || (state.language === 'zh' ? '图表' : 'Chart');
      }
      if (type === 'creative') return state.language === 'zh' ? '创意图' : 'Creative';
      if (type === 'poster') return state.language === 'zh' ? '海报' : 'Poster';
      return type;
    }

    function setupNavScroll() {
      window.addEventListener('scroll', () => {
        elements.nav.classList.toggle('scrolled', window.scrollY > 50);
      });
    }

    // 设置滚动监听，显示/隐藏滚动到底部按钮
    function setupScrollListeners() {
      const panels = [
        { content: elements.transcriptionList, btn: $('transcriptScrollBtn') },
        { content: elements.summaryList, btn: $('insightScrollBtn') }
      ];

      panels.forEach(({ content, btn }) => {
        if (!content || !btn) return;
        
        content.addEventListener('scroll', () => {
          const isNearBottom = content.scrollHeight - content.scrollTop - content.clientHeight < 100;
          btn.classList.toggle('visible', !isNearBottom && content.scrollHeight > content.clientHeight);
        });
      });
    }

    // 滚动到底部
    function scrollToBottom(elementId) {
      const el = $(elementId);
      if (el) {
        el.scrollTo({ top: el.scrollHeight, behavior: 'smooth' });
      }
    }

    function setupUpload() {
      elements.uploadInput.addEventListener('change', () => {
        const file = elements.uploadInput.files?.[0];
        if (file) {
          showToast(`已选择: ${file.name.substring(0, 20)}${file.name.length > 20 ? '...' : ''}`, 'info');
          uploadAndTranscribe();
        }
      });
    }

    // ========== Waveform ==========
    function setupWaveform() {
      for (let i = 0; i < 35; i++) {
        const bar = document.createElement('div');
        bar.className = 'waveform-bar';
        bar.style.height = '20%';
        elements.waveform.appendChild(bar);
      }
    }

    let waveformInterval = null;
    function startWaveformAnimation() {
      if (waveformInterval) return;
      waveformInterval = setInterval(() => {
        elements.waveform.querySelectorAll('.waveform-bar').forEach((bar, i) => {
          const h = 15 + Math.sin(Date.now() / 150 + i * 0.4) * 25 + (state.isRecording ? 35 : 0) + Math.random() * 15;
          bar.style.height = `${h}%`;
        });
      }, 80);
    }

    function stopWaveformAnimation() {
      if (waveformInterval) { clearInterval(waveformInterval); waveformInterval = null; }
      elements.waveform.querySelectorAll('.waveform-bar').forEach(bar => bar.style.height = '20%');
    }

    // ========== Connection ==========
    // 获取 ngrok 所需的额外 headers
    function getNgrokHeaders() {
      if (state.apiBaseUrl && state.apiBaseUrl.includes('ngrok')) {
        return { 'ngrok-skip-browser-warning': 'true' };
      }
      return {};
    }

    async function testConnection() {
      const baseUrl = state.apiBaseUrl;
      if (!baseUrl) {
        updateConnectionStatus('error');
        enableControls(false);
        return;
      }
      updateConnectionStatus('testing');
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        const response = await fetch(`${baseUrl}/sessions/health`, { 
          method: 'GET', 
          signal: controller.signal,
          headers: getNgrokHeaders()
        });
        clearTimeout(timeoutId);
        
        if (response.ok) {
          state.isConnected = true;
          updateConnectionStatus('connected');
          hideAlert();
          enableControls(true);
          showToast(t('toast.connectionSuccess'), 'success');
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (error) {
        state.isConnected = false;
        updateConnectionStatus('error');
        enableControls(false);
        
        if (error.name === 'AbortError') {
          showAlert(t('toast.startBackend'), t('toast.connectionFailed'));
        } else {
          showAlert(t('toast.startBackend'), t('toast.startBackendHint') + '：<code>cd backend && npm run start:dev</code>');
        }
      }
    }

    function updateConnectionStatus(status) {
      const statusMap = {
        testing: { class: '', text: t('nav.detecting') },
        connected: { class: 'connected', text: t('nav.connected') },
        error: { class: 'error', text: t('nav.disconnected') }
      };
      const s = statusMap[status] || statusMap.error;
      elements.connectionStatus.className = `status-dot ${s.class}`;
      elements.connectionText.textContent = s.text;
    }

    function enableControls(enabled) {
      elements.recordBtn.disabled = !enabled;
      $('skillInnerOS').disabled = !enabled;
      $('skillBrainstorm').disabled = !enabled;
      $('skillStopTalking').disabled = !enabled;
      elements.qaSendBtn.disabled = !enabled;
      updateVisualizationButtonState();
    }

    function showAlert(title, content) {
      elements.alertTitle.textContent = title;
      elements.alertContent.innerHTML = content;
      elements.alertBanner.classList.add('show');
    }

    function hideAlert() {
      elements.alertBanner.classList.remove('show');
    }

    // ========== Recording ==========
    async function toggleRecording() {
      if (state.isRecording) {
        await stopRecording();
      } else {
        await startRecording();
      }
    }

    async function startRecording() {
      if (!state.isConnected) {
        showToast(t('toast.connectBackendFirst'), 'error');
        return;
      }

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showToast(t('toast.envNotSupportMic'), 'error');
        return;
      }

      try {
        showToast(t('toast.creatingSession'), 'info');
        
        // 完全重置所有状态 - 类似页面刷新
        resetAllState();

        const response = await apiCall('POST', '/sessions', { meetingId: `meeting-${Date.now()}` });
        state.sessionId = response.sessionId;
        state.taskId = response.taskId;
        state.meetingId = response.meetingId; // 保存会议ID

        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: { sampleRate: 16000, channelCount: 1, echoCancellation: true, noiseSuppression: true }
        });
        
        // 保存 stream 以便暂停后恢复
        state.mediaStream = stream;

        state.mediaRecorder = new MediaRecorder(stream, { 
          mimeType: MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : 'audio/webm' 
        });

        state.mediaRecorder.ondataavailable = async (event) => {
          if (event.data.size > 0 && state.sessionId && !state.isPaused) {
            try {
              const base64 = await blobToBase64(event.data);
              await apiCall('POST', `/sessions/${state.sessionId}/audio`, { chunk: base64 });
            } catch (e) { console.warn('Upload chunk failed:', e); }
          }
        };

        state.mediaRecorder.start(500); // 优化：500ms 发送一次，减少延迟
        state.isRecording = true;
        state.recordingStartTime = Date.now();
        
        updateRecordingUI();
        startWaveformAnimation();
        startTimerUpdate();
        startPolling();

        // V3: 如果 Agent 已开启，启动 Agent（智能分析）
        if (state.agentEnabled) {
          startAgent();
        }
        
        // 刷新侧边栏显示当前会议
        loadSidebarMeetings();
        
        showToast(t('toast.recordingStarted'), 'success');
      } catch (error) {
        console.error('Start recording failed:', error);
        if (error.name === 'NotAllowedError') {
          showToast(t('toast.micPermissionDenied'), 'error');
        } else {
          showToast(t('toast.recordingStartFailed') + ': ' + error.message, 'error');
        }
      }
    }

    async function stopRecording() {
      // 保存当前 sessionId，用于后续处理
      const currentSessionId = state.sessionId;
      
      if (state.mediaRecorder) {
        state.mediaRecorder.stop();
        state.mediaRecorder = null;
      }
      
      // 停止并清理 MediaStream
      if (state.mediaStream) {
        state.mediaStream.getTracks().forEach(track => track.stop());
        state.mediaStream = null;
      }

      state.isRecording = false;
      state.isPaused = false;
      
      // 清空暂停保存的内容（停止录音意味着会话结束）
      state.savedTranscriptionBeforePause = [];
      state.savedSummariesBeforePause = [];
      state.savedAgentInsightsBeforePause = [];
      
      stopWaveformAnimation();
      stopTimerUpdate();
      stopAutoPush(); // 停止自动推送
      stopAgent(); // V3: 停止 Agent
      // 停止录音时停止实时轮询，但保留 sessionId 以便后续获取结果
      stopPolling();
      updateRecordingUI();

      if (currentSessionId) {
        try {
          showToast(t('toast.processingAudio'), 'info');
          await apiCall('POST', `/sessions/${currentSessionId}/process`);
          
          let pollCount = 0;
          const pollForResults = async () => {
            // 检查是否已被取消（用户开始了新录音，sessionId 会变化）
            if (state.sessionId !== currentSessionId || state.isRecording) {
              console.log('录音后轮询被取消（新录音已开始）');
              return;
            }
            
            if (pollCount >= 30) { 
              // 轮询结束后显示下载按钮（如果有转写内容）
              if (state.transcription.length > 0) {
                elements.downloadDropdown.style.display = 'block';
              }
              return; 
            }
            pollCount++;
            await pollUpdates();
            
            // 每次轮询后检查是否有转写内容，有则显示下载按钮
            if (state.transcription.length > 0) {
              elements.downloadDropdown.style.display = 'block';
            }
            
            // 使用可取消的 timeout
            postRecordingPollTimeout = setTimeout(pollForResults, 1000);
          };
          pollForResults();
        } catch (e) { 
          showToast(t('toast.audioProcessFailed') + ': ' + e.message, 'error');
        }
        
        try {
          await apiCall('POST', `/sessions/${currentSessionId}/complete`);
          // 录音结束后刷新侧边栏
          loadSidebarMeetings();
        } catch (e) { console.warn('Complete session failed:', e); }
      }
    }

    async function togglePause() {
      if (!state.isRecording) return;
      state.isPaused = !state.isPaused;
      if (state.isPaused) {
        // 暂停时：停止当前 MediaRecorder 但保留 stream
        if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
          state.mediaRecorder.stop();
        }
        stopWaveformAnimation();
        pauseTimerUpdate(); // 暂停计时器
        
        // 保存当前的转写内容和洞察，以便恢复时合并
        state.savedTranscriptionBeforePause = [...state.transcription];
        state.savedSummariesBeforePause = [...state.summaries];
        state.savedAgentInsightsBeforePause = [...state.agentInsights];
        console.log('[Pause] Recording paused, saved transcription count:', state.savedTranscriptionBeforePause.length);
      } else {
        // 恢复时：创建新的后端会话（因为通义听悟会超时断开）
        try {
          showToast('正在恢复录音...', 'info');
          const res = await apiCall('POST', '/sessions', { meetingId: `meeting-${Date.now()}` });
          state.sessionId = res.sessionId;
          state.taskId = res.taskId;
          // 重置 lastInsightId，因为新 session 的洞察 ID 是独立的
          state.lastInsightId = null;
          console.log('[Resume] Created new session:', res.sessionId, 'preserved transcription count:', state.savedTranscriptionBeforePause.length);
        } catch (e) {
          console.error('[Resume] Failed to create new session:', e);
          showToast('恢复录音失败: ' + e.message, 'error');
          state.isPaused = true; // 恢复暂停状态
          updateRecordingUI();
          return;
        }
        
        // 创建新的 MediaRecorder（确保 WebM 流完整）
        if (state.mediaStream) {
          state.mediaRecorder = new MediaRecorder(state.mediaStream, { 
            mimeType: MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : 'audio/webm' 
          });
          
          state.mediaRecorder.ondataavailable = async (event) => {
            if (event.data.size > 0 && state.sessionId && !state.isPaused) {
              try {
                const base64 = await blobToBase64(event.data);
                await apiCall('POST', `/sessions/${state.sessionId}/audio`, { chunk: base64 });
              } catch (e) { console.warn('Upload chunk failed:', e); }
            }
          };
          
          state.mediaRecorder.start(500); // 优化：500ms 发送一次，减少延迟
          startWaveformAnimation();
          resumeTimerUpdate(); // 恢复计时器
          
          // 重新启动 Agent（如果已开启）
          if (state.agentEnabled) {
            startAgent();
          }
          
          showToast('录音已恢复', 'success');
          console.log('[Resume] Recording resumed, new MediaRecorder created');
        }
      }
      updateRecordingUI();
    }

    function updateRecordingUI() {
      const newMeetingBtn = $('newMeetingBtn');
      
      if (state.isRecording) {
        elements.recordingStatus.className = state.isPaused ? 'recording-bar__status paused' : 'recording-bar__status recording';
        elements.recordingStatusText.textContent = state.isPaused ? t('recording.paused') : t('recording.recording');
        elements.recordBtnText.textContent = t('recording.stop');
        elements.recordBtn.classList.add('recording');
        elements.pauseBtn.disabled = false;
        elements.pauseBtn.textContent = state.isPaused ? t('recording.resume') : t('recording.pause');
        // 录音时新建会议按钮显示警告样式
        if (newMeetingBtn) {
          newMeetingBtn.style.opacity = '0.7';
          newMeetingBtn.title = t('misc.clickToStop');
        }
      } else {
        elements.recordingStatus.className = 'recording-bar__status';
        elements.recordingStatusText.textContent = t('recording.ready');
        elements.recordBtnText.textContent = t('recording.start');
        elements.recordBtn.classList.remove('recording');
        elements.pauseBtn.disabled = true;
        elements.pauseBtn.textContent = t('recording.pause');
        // 恢复新建会议按钮正常样式
        if (newMeetingBtn) {
          newMeetingBtn.style.opacity = '1';
          newMeetingBtn.title = '';
        }
      }
    }

    // ========== Timer ==========
    let timerInterval = null;
    let pausedElapsedTime = 0; // 暂停时已经过的时间
    let timerStartTime = null; // 计时器开始时间（不含暂停时间）
    
    function startTimerUpdate() {
      if (timerInterval) return;
      timerStartTime = Date.now();
      timerInterval = setInterval(() => {
        if (!state.recordingStartTime) return;
        // 计算实际录音时间 = 暂停前累计时间 + 本次录音时间
        const currentElapsed = pausedElapsedTime + (Date.now() - timerStartTime);
        const m = Math.floor(currentElapsed / 60000).toString().padStart(2, '0');
        const s = Math.floor((currentElapsed % 60000) / 1000).toString().padStart(2, '0');
        elements.recordingTimer.textContent = `${m}:${s}`;
      }, 1000);
    }

    function pauseTimerUpdate() {
      if (timerInterval) {
        // 保存已经过的时间
        pausedElapsedTime += Date.now() - timerStartTime;
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }
    
    function resumeTimerUpdate() {
      if (timerInterval) return;
      timerStartTime = Date.now();
      timerInterval = setInterval(() => {
        if (!state.recordingStartTime) return;
        const currentElapsed = pausedElapsedTime + (Date.now() - timerStartTime);
        const m = Math.floor(currentElapsed / 60000).toString().padStart(2, '0');
        const s = Math.floor((currentElapsed % 60000) / 1000).toString().padStart(2, '0');
        elements.recordingTimer.textContent = `${m}:${s}`;
      }, 1000);
    }

    function stopTimerUpdate() {
      if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
      pausedElapsedTime = 0;
      timerStartTime = null;
    }

    // ========== Polling ==========
    let pollingInterval = null;
    let postRecordingPollTimeout = null; // 用于停止录音后的轮询

    function startPolling() {
      // 确保先停止之前的所有轮询
      stopPolling();
      
      console.log('开始轮询，sessionId:', state.sessionId);
      pollUpdates(); // 立即执行一次
      pollingInterval = setInterval(pollUpdates, 1000); // 优化：1秒轮询一次，提升实时性
    }

    function stopPolling() {
      if (pollingInterval) { 
        clearInterval(pollingInterval); 
        pollingInterval = null; 
        console.log('轮询已停止');
      }
      // 同时停止录音结束后的轮询
      if (postRecordingPollTimeout) {
        clearTimeout(postRecordingPollTimeout);
        postRecordingPollTimeout = null;
        console.log('录音后轮询已停止');
      }
    }

    async function pollUpdates() {
      if (!state.sessionId) {
        console.log('pollUpdates: 没有 sessionId，跳过');
        return;
      }
      try {
        const [transcripts, summaries] = await Promise.all([
          apiCall('GET', `/sessions/${state.sessionId}/transcripts`),
          apiCall('GET', `/sessions/${state.sessionId}/summaries`)
        ]);
        
        console.log('轮询结果:', { 
          transcriptsCount: transcripts.transcription?.length || 0, 
          summariesCount: summaries.summaries?.length || 0,
          savedCount: state.savedTranscriptionBeforePause.length
        });
        
        if (transcripts.transcription?.length > 0) { 
          // 如果有暂停前保存的转写内容，需要合并
          if (state.savedTranscriptionBeforePause.length > 0) {
            // 计算时间偏移：暂停前最后一条的结束时间
            const lastSavedItem = state.savedTranscriptionBeforePause[state.savedTranscriptionBeforePause.length - 1];
            const timeOffset = lastSavedItem ? (lastSavedItem.endMs || lastSavedItem.startMs || 0) : 0;
            
            // 为新的转写内容添加时间偏移
            const newTranscriptsWithOffset = transcripts.transcription.map(item => ({
              ...item,
              startMs: (item.startMs || 0) + timeOffset,
              endMs: (item.endMs || 0) + timeOffset
            }));
            
            // 合并保存的内容和新内容
            state.transcription = [...state.savedTranscriptionBeforePause, ...newTranscriptsWithOffset];
            console.log('[Poll] Merged transcription, total count:', state.transcription.length);
          } else {
            state.transcription = transcripts.transcription; 
          }
          renderTranscription(); 
          updateVisualizationButtonState();
        }
        if (summaries.summaries) { 
          // 同样合并洞察内容
          if (state.savedSummariesBeforePause.length > 0) {
            state.summaries = [...state.savedSummariesBeforePause, ...summaries.summaries];
          } else {
            state.summaries = summaries.summaries; 
          }
          renderSummaries(); 
        }
        
        try {
          const visResponse = await apiCall('GET', `/sessions/${state.sessionId}/visualizations`);
          if (visResponse.visualizations?.length > 0) {
            renderVisualizations(visResponse.visualizations);
          }
        } catch (e) { /* Visualization polling is optional */ }
      } catch (e) { console.warn('Poll failed:', e); }
    }

    // ========== Render ==========
    function renderTranscription() {
      elements.transcriptCount.textContent = state.transcription.length;
      
      if (state.transcription.length === 0) {
        // 清空转写列表，显示空状态
        elements.transcriptionList.innerHTML = `
          <div class="empty-state" id="transcriptEmptyState">
            <div class="empty-state__icon">🎤</div>
            <p class="empty-state__text">开始录音后，转写内容将实时显示</p>
          </div>
        `;
        return;
      }
      
      // 优化：合并相邻的短句（5秒内的句子合并为一个段落）
      const mergedTranscripts = mergeTranscripts(state.transcription);
      
      // V3: 为每个转写项添加唯一 ID，支持关联
      const html = mergedTranscripts.map((item, index) => {
        const transcriptId = `transcript-${index}`;
        const hasInsight = state.transcriptInsightMap[transcriptId];
        const insightClass = hasInsight ? 'has-insight' : '';
        const badge = hasInsight ? '<span class="transcript-link-badge" title="点击查看相关洞察">💡</span>' : '';
        
        return `
          <div class="transcript-item ${insightClass}" data-transcript-id="${transcriptId}" ${hasInsight ? `onclick="scrollToInsight('${state.transcriptInsightMap[transcriptId]}')"` : ''}>
            <div class="transcript-time">${formatTime(item.startMs)}${item.endMs !== item.startMs ? ' - ' + formatTime(item.endMs) : ''}</div>
            <div class="transcript-text">${escapeHtml(item.text)}</div>
            ${badge}
          </div>
        `;
      }).join('');
      
      // 检查是否已在底部
      const wasAtBottom = elements.transcriptionList.scrollHeight - elements.transcriptionList.scrollTop - elements.transcriptionList.clientHeight < 100;
      
      elements.transcriptionList.innerHTML = html;
      
      // 如果之前在底部，自动滚动到底部
      if (wasAtBottom) {
        elements.transcriptionList.scrollTop = elements.transcriptionList.scrollHeight;
      }
      
      // 更新滚动按钮状态
      updateScrollButtonVisibility('transcriptionList', 'transcriptScrollBtn');
    }

    // 合并相邻的转写段落（5秒内的句子合并）
    function mergeTranscripts(transcripts) {
      if (transcripts.length === 0) return [];
      
      const merged = [];
      let current = { ...transcripts[0] };
      
      for (let i = 1; i < transcripts.length; i++) {
        const item = transcripts[i];
        const timeDiff = item.startMs - current.endMs;
        
        // 如果时间间隔小于5秒，合并文本
        if (timeDiff < 15000) {
          current.text += ' ' + item.text;
          current.endMs = item.endMs;
        } else {
          merged.push(current);
          current = { ...item };
        }
      }
      merged.push(current);
      
      return merged;
    }

    // 洞察卡片类型配置
    const INSIGHT_TYPES = {
      inner_os: { title: '潜台词', icon: '🔮', color: 'var(--color-inner-os)' },
      brainstorm: { title: '灵感', icon: '⚡', color: 'var(--color-brainstorm)' },
      stop_talking: { title: '聚焦', icon: '🎯', color: 'var(--color-stop-talking)' },
      auto_analysis: { title: '洞察', icon: '✨', color: 'var(--color-auto-analysis)' }
    };

    function renderSummaries() {
      // 计算总数：手动技能洞察 + Agent 洞察
      const totalCount = state.summaries.length + state.agentInsights.length;
      elements.insightCount.textContent = totalCount;
      
      console.log('renderSummaries called:', { 
        summaries: state.summaries.length, 
        agentInsights: state.agentInsights.length,
        totalCount 
      });
      
      // 如果没有任何内容，显示空状态（但不清除已有的 Agent 洞察 DOM）
      if (state.summaries.length === 0 && state.agentInsights.length === 0) {
        // 检查 DOM 中是否有 Agent 洞察卡片
        const existingAgentCards = elements.summaryList.querySelectorAll('.auto-insight');
        if (existingAgentCards.length === 0) {
          // 清空洞察列表，显示空状态
          elements.summaryList.innerHTML = `
            <div class="empty-state" id="insightEmptyState">
              <div class="empty-state__icon">💡</div>
              <p class="empty-state__text">触发 AI 技能后，洞察将显示在这里</p>
            </div>
            <div id="visualizationList"></div>
          `;
          elements.visualizationList = $('visualizationList');
          elements.insightEmptyState = $('insightEmptyState');
        }
        return;
      }
      
      // 隐藏空状态
      const emptyState = document.getElementById('insightEmptyState');
      if (emptyState) {
        emptyState.style.display = 'none';
      }
      
      // 只更新手动技能洞察部分，不影响 Agent 洞察
      // 查找或创建手动洞察容器
      let manualInsightsContainer = document.getElementById('manualInsightsContainer');
      if (!manualInsightsContainer) {
        manualInsightsContainer = document.createElement('div');
        manualInsightsContainer.id = 'manualInsightsContainer';
        // 插入到 summaryList 的开头
        elements.summaryList.insertBefore(manualInsightsContainer, elements.summaryList.firstChild);
      }
      
      // 渲染手动技能洞察
      const html = state.summaries.map(card => {
        const typeInfo = INSIGHT_TYPES[card.type] || INSIGHT_TYPES.auto_analysis;
        const content = formatInsightContent(card.content, card.type);
        const time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        
        return `
          <article class="insight-card" data-type="${card.type}">
            <header class="insight-card__header">
              <span class="insight-card__icon">${typeInfo.icon}</span>
              <h3 class="insight-card__title">${typeInfo.title}</h3>
              <time class="insight-card__time">${time}</time>
            </header>
            <div class="insight-card__content">${content}</div>
          </article>
        `;
      }).join('');
      
      manualInsightsContainer.innerHTML = html;
      
      // 确保 visualizationList 存在
      if (!document.getElementById('visualizationList')) {
        const visList = document.createElement('div');
        visList.id = 'visualizationList';
        elements.summaryList.appendChild(visList);
        elements.visualizationList = visList;
      }
      
      // 更新滚动按钮状态
      updateScrollButtonVisibility('summaryList', 'insightScrollBtn');
    }

    // 更新滚动按钮可见性
    function updateScrollButtonVisibility(contentId, btnId) {
      const content = $(contentId);
      const btn = $(btnId);
      if (!content || !btn) return;
      
      const isNearBottom = content.scrollHeight - content.scrollTop - content.clientHeight < 100;
      btn.classList.toggle('visible', !isNearBottom && content.scrollHeight > content.clientHeight);
    }

    function formatInsightContent(content, type) {
      let text = '';
      
      if (typeof content === 'string') {
        text = escapeHtml(content);
      } else if (Array.isArray(content)) {
        // 处理对象数组（如inner_os返回的 [{quote, innerThought, emotion}]）
        text = content.map(item => {
          if (typeof item === 'object' && item !== null) {
            return formatInsightObject(item, type);
          }
          return escapeHtml(String(item));
        }).join('<div style="margin: 12px 0; border-top: 1px solid var(--border-subtle);"></div>');
      } else if (typeof content === 'object' && content !== null) {
        text = formatInsightObject(content, type);
      } else {
        text = String(content);
      }
      
      // 高亮关键词
      text = text.replace(/【(.+?)】/g, '<mark class="highlight">$1</mark>');
      text = text.replace(/\*\*(.+?)\*\*/g, '<mark class="highlight">$1</mark>');
      
      return text;
    }

    // 格式化洞察对象（处理 {quote, innerThought, emotion} 等结构）
    function formatInsightObject(obj, type) {
      // 字段名中英文映射
      const fieldLabels = {
        // 通用
        quote: '原话', innerThought: '认知转译', emotion: '情绪',
        idea: '想法', suggestion: '建议', advice: '建议',
        warning: '警告', issue: '问题',
        // stop_talking 议程守护
        isOffTopic: '跑题', mainTopic: '核心议题', deviation: '偏离原因', reminder: '温馨提示',
        // auto_analysis 自动分析
        phase: '阶段', keyPoints: '要点', blindSpots: '盲区', expertAdvice: '专家建议', innerOS: '认知转译'
      };

      if (type === 'inner_os') {
        // 认知转译特殊格式：引用 + 内心想法 + 情绪
        let html = '';
        if (obj.quote) {
          html += `<blockquote class="insight-card__quote">"${escapeHtml(obj.quote)}"</blockquote>`;
        }
        if (obj.innerThought) {
          html += `<p style="margin: 10px 0; color: var(--text-primary);">💭 ${escapeHtml(obj.innerThought)}</p>`;
        }
        if (obj.emotion) {
          html += `<span class="insight-emotion-tag">${escapeHtml(obj.emotion)}</span>`;
        }
        return html || formatDefaultObject(obj, fieldLabels);
      }
      
      if (type === 'brainstorm') {
        // 破局灵感：想法列表
        let html = '';
        if (obj.idea || obj.title) {
          html += `<strong style="color: var(--aurora-cyan);">💡 ${escapeHtml(obj.idea || obj.title)}</strong>`;
        }
        if (obj.description || obj.detail) {
          html += `<p style="margin-top: 6px; color: var(--text-secondary);">${escapeHtml(obj.description || obj.detail)}</p>`;
        }
        return html || formatDefaultObject(obj, fieldLabels);
      }
      
      if (type === 'stop_talking') {
        // 议程守护 - 精简卡片式显示
        let html = '<div class="insight-stop-talking">';
        
        // 跑题状态 - 用醒目标签
        if (obj.isOffTopic !== undefined) {
          const isOff = obj.isOffTopic === true || obj.isOffTopic === 'true';
          html += `<div class="insight-status-badge ${isOff ? 'warning' : 'success'}">${isOff ? '⚠️ 已跑题' : '✓ 未跑题'}</div>`;
        }
        
        // 核心议题 - 重点突出
        if (obj.mainTopic) {
          html += `<div class="insight-field"><span class="insight-field-icon">🎯</span><span class="insight-field-label">核心议题</span><p class="insight-field-value highlight-box">${escapeHtml(obj.mainTopic)}</p></div>`;
        }
        
        // 偏离原因 - 简洁显示
        if (obj.deviation) {
          html += `<div class="insight-field"><span class="insight-field-icon">📍</span><span class="insight-field-label">偏离原因</span><p class="insight-field-value">${escapeHtml(truncateText(obj.deviation, 100))}</p></div>`;
        }
        
        // 温馨提示 - 突出显示
        if (obj.reminder) {
          html += `<div class="insight-reminder"><span>💬</span><p>${escapeHtml(obj.reminder)}</p></div>`;
        }
        
        html += '</div>';
        return html;
      }
      
      if (type === 'auto_analysis') {
        // 自动分析 - 结构化卡片显示
        let html = '<div class="insight-auto-analysis">';
        
        // 阶段标签
        if (obj.phase) {
          html += `<div class="insight-phase-tag">📌 ${escapeHtml(obj.phase)}</div>`;
        }
        
        // 核心要点 - 最重要，放最前
        if (obj.keyPoints) {
          html += `<div class="insight-section"><div class="insight-section-title">🔑 核心要点</div><p class="insight-section-content">${escapeHtml(truncateText(obj.keyPoints, 120))}</p></div>`;
        }
        
        // 盲区提示
        if (obj.blindSpots) {
          html += `<div class="insight-section warning"><div class="insight-section-title">⚠️ 注意盲区</div><p class="insight-section-content">${escapeHtml(truncateText(obj.blindSpots, 100))}</p></div>`;
        }
        
        // 专家建议 - 可折叠或简化
        if (obj.expertAdvice) {
          html += `<div class="insight-section advice"><div class="insight-section-title">💡 建议</div><p class="insight-section-content">${escapeHtml(truncateText(obj.expertAdvice, 100))}</p></div>`;
        }
        
        // 认知转译 - 趣味展示
        if (obj.innerOS) {
          html += `<div class="insight-inner-os"><span>🧠</span><em>"${escapeHtml(truncateText(obj.innerOS, 60))}"</em></div>`;
        }
        
        html += '</div>';
        return html;
      }
      
      // 默认格式
      return formatDefaultObject(obj, fieldLabels);
    }

    // 默认对象格式化
    function formatDefaultObject(obj, labels) {
      return Object.entries(obj).map(([k, v]) => {
        const label = labels[k] || k;
        const value = typeof v === 'string' ? truncateText(v, 150) : String(v);
        return `<div class="insight-field-row"><span class="highlight">${escapeHtml(label)}</span>：${escapeHtml(value)}</div>`;
      }).join('');
    }

    // 截断文本
    function truncateText(text, maxLen) {
      if (!text || text.length <= maxLen) return text;
      return text.substring(0, maxLen) + '...';
    }

    function renderVisualizations(visualizations) {
      if (!elements.visualizationList) return;
      
      const typeLabels = { chart: '科研图表', creative: '创意图像', poster: '逻辑海报' };
      
      elements.visualizationList.innerHTML = visualizations.map(result => {
        const imageSrc = result.imageUrl || (result.imageBase64 ? `data:${result.metadata?.mimeType || 'image/png'};base64,${result.imageBase64}` : '');
        return `
          <div class="insight-card" data-vis-id="${result.id}">
            <header class="insight-card__header">
              <span class="insight-card__icon">🎨</span>
              <h3 class="insight-card__title">${typeLabels[result.type] || result.type}</h3>
            </header>
            ${imageSrc ? `<img src="${imageSrc}" alt="视觉化" style="width:100%;border-radius:var(--radius-md);cursor:pointer;margin-top:12px;" onclick="viewVisualization('${result.id}')">` : ''}
          </div>
        `;
      }).join('');
    }

    // ========== Skills ==========
    async function triggerSkill(skill) {
      if (!state.sessionId) { showToast(t('toast.startRecordFirst'), 'error'); return; }

      const names = { inner_os: 'InnerOS', brainstorm: 'Brainstorm', stop_talking: 'StopTalking' };
      const displayNames = { inner_os: '潜台词', brainstorm: '灵感', stop_talking: '聚焦' };
      const statusEl = $(`skill${names[skill]}Status`);
      const btnEl = $(`skill${names[skill]}`);
      
      // 技能按钮是一次性触发，不再加入自动推送列表
      
      btnEl.disabled = true;
      btnEl.classList.add('loading');
      statusEl.innerHTML = '<div class="spinner"></div>';

      try {
        const response = await apiCall('POST', `/sessions/${state.sessionId}/skills/${skill}`);
        if (response.cards?.length) {
          state.summaries = [...state.summaries, ...response.cards];
          renderSummaries();
        }
        statusEl.textContent = '✓';
        showToast(`${displayNames[skill]} ${t('toast.analysisDone')}`, 'success');
      } catch (error) {
        statusEl.textContent = '⚠️';
        showToast(`${displayNames[skill]} ${t('toast.analysisFailed')}: ${error.message}`, 'error');
      } finally {
        btnEl.disabled = false;
        btnEl.classList.remove('loading');
        setTimeout(() => { statusEl.textContent = ''; }, 2000);
      }
    }

    // ========== Auto Push (已废弃，由 Agent 替代) ==========
    // 保留函数以兼容旧代码，但不再执行实际操作
    function startAutoPush() {
      // 已由 Agent 智能分析替代，不再需要前端定时推送
      console.log('Auto push disabled, using Agent instead');
    }

    function stopAutoPush() {
      if (state.autoPushInterval) {
        clearInterval(state.autoPushInterval);
        state.autoPushInterval = null;
      }
    }

    // ========== V3 Agent 智能分析功能 ==========
    
    // 切换 Agent 开关
    async function toggleAgent() {
      state.agentEnabled = !state.agentEnabled;
      elements.agentToggle.classList.toggle('active', state.agentEnabled);

      if (state.agentEnabled) {
        if (state.isRecording && state.sessionId) {
          startAgent();
        }
        showToast(t('toast.agentOn') || '🤖 AI 智能分析已开启', 'success');
      } else {
        stopAgent();
        showToast(t('toast.agentOff') || 'AI 智能分析已关闭', 'info');
      }
    }

    // 启动 Agent
    async function startAgent() {
      if (!state.sessionId || !state.agentEnabled) return;

      try {
        await apiCall('POST', `/sessions/${state.sessionId}/agent/start`);
        console.log('Agent started');
        
        // 开始轮询 Agent 洞察
        startAgentPolling();
      } catch (error) {
        console.warn('启动 Agent 失败:', error);
      }
    }

    // 停止 Agent
    async function stopAgent() {
      if (!state.sessionId) return;

      try {
        await apiCall('POST', `/sessions/${state.sessionId}/agent/stop`);
        console.log('Agent stopped');
      } catch (error) {
        console.warn('停止 Agent 失败:', error);
      }

      stopAgentPolling();
    }

    // 开始轮询 Agent 洞察
    function startAgentPolling() {
      if (state.agentPollingInterval) return;

      console.log('Starting Agent polling...');
      
      // 立即执行一次
      pollAgentInsights();

      state.agentPollingInterval = setInterval(async () => {
        await pollAgentInsights();
      }, 5000); // 每 5 秒轮询一次
    }
    
    // 轮询 Agent 洞察
    async function pollAgentInsights() {
      if (!state.sessionId || !state.agentEnabled) return;

      try {
        const url = state.lastInsightId 
          ? `/sessions/${state.sessionId}/agent/insights?afterId=${state.lastInsightId}`
          : `/sessions/${state.sessionId}/agent/insights`;
        
        console.log('Polling Agent insights:', url);
        const response = await apiCall('GET', url);
        console.log('Agent insights response:', response);
        
        if (response.insights && response.insights.length > 0) {
          console.log(`Received ${response.insights.length} new insights`);
          response.insights.forEach(insight => {
            addAgentInsight(insight);
          });
          // 更新最后的洞察 ID
          state.lastInsightId = response.insights[response.insights.length - 1].id;
        }
      } catch (error) {
        console.warn('获取 Agent 洞察失败:', error);
      }
    }

    // 停止轮询 Agent 洞察
    function stopAgentPolling() {
      if (state.agentPollingInterval) {
        clearInterval(state.agentPollingInterval);
        state.agentPollingInterval = null;
      }
    }

    // 添加 Agent 洞察到右侧面板
    function addAgentInsight(insight) {
      // 检查是否已存在（避免重复）
      if (state.agentInsights.some(i => i.id === insight.id)) {
        return;
      }
      
      state.agentInsights.push(insight);
      
      // 如果有关联的转写段落，建立映射
      // 后端返回的是 triggerSegmentIds，格式为 "seg-{sessionId}-{index}"
      if (insight.triggerSegmentIds && insight.triggerSegmentIds.length > 0) {
        insight.triggerSegmentIds.forEach(segId => {
          // 从后端的 segment ID 提取索引，转换为前端的 transcript ID
          const match = segId.match(/seg-[^-]+-(\d+)/);
          if (match) {
            const frontendId = `transcript-${match[1]}`;
            state.transcriptInsightMap[frontendId] = insight.id;
          }
        });
        // 更新转写列表中的关联标记
        updateTranscriptLinks();
      }

      // 直接渲染洞察卡片到 DOM（不依赖 renderSummaries）
      renderAgentInsightCard(insight);
      
      console.log('Agent insight added:', insight.type, insight.id);
    }

    // 渲染 Agent 洞察卡片
    function renderAgentInsightCard(insight) {
      const card = document.createElement('div');
      card.className = 'insight-card auto-insight';
      card.dataset.type = insight.type;
      card.dataset.insightId = insight.id;

      const typeIcons = {
        'data_chart': '📊',
        'chart_generated': '📊',
        'skill_result': '🎭',
        'visualization_generated': '🎨',
        'focus_reminder': '🎯',
        'redundancy_hint': '🔄',
        'decision_record': '✅',
        'periodic_summary': '📋'
      };

      const typeLabels = {
        'data_chart': '数据洞察',
        'chart_generated': '数据图表',
        'skill_result': 'AI技能',
        'visualization_generated': '视觉化',
        'focus_reminder': '聚焦提醒',
        'redundancy_hint': '冗余提示',
        'decision_record': '决策记录',
        'periodic_summary': '阶段总结'
      };

      const icon = typeIcons[insight.type] || '💡';
      const label = typeLabels[insight.type] || '智能洞察';

      // 处理 content 对象
      const content = insight.content || {};
      const title = content.title || label;
      const summary = content.summary || content.hint || '';
      const dataPoints = content.dataPoints || [];
      const suggestion = content.suggestion || '';
      const decision = content.decision || '';
      const nextSteps = content.nextSteps || [];
      const reason = content.reason || '';

      // 来源文本（从触发段落获取）
      let sourceHtml = '';
      if (insight.triggerSegmentIds && insight.triggerSegmentIds.length > 0) {
        // 通过 ID 匹配查找对应的转写段落
        let sourceSegment = null;
        let sourceArrayIndex = -1;
        
        for (const segId of insight.triggerSegmentIds) {
          const foundIndex = state.transcription.findIndex(t => t.id === segId);
          if (foundIndex >= 0) {
            sourceSegment = state.transcription[foundIndex];
            sourceArrayIndex = foundIndex;
            break;
          }
        }
        
        // 如果直接匹配失败，取最新的转写段落
        if (!sourceSegment && state.transcription.length > 0) {
          sourceArrayIndex = state.transcription.length - 1;
          sourceSegment = state.transcription[sourceArrayIndex];
        }
        
        if (sourceSegment) {
          sourceHtml = `
            <div class="insight-card__source" onclick="scrollToTranscript('transcript-${sourceArrayIndex}')">
              <span class="source-label">📌 来源</span>
              <div class="source-text">"${sourceSegment.text.substring(0, 100)}${sourceSegment.text.length > 100 ? '...' : ''}"</div>
            </div>
          `;
        }
      }

      // 数据点
      let dataPointsHtml = '';
      if (dataPoints.length > 0) {
        dataPointsHtml = `<div class="data-points">📈 关键数据: ${dataPoints.join(', ')}</div>`;
      }

      // 建议
      let suggestionHtml = '';
      if (suggestion) {
        suggestionHtml = `<div class="suggestion">💡 ${suggestion}</div>`;
      }

      // 原因
      let reasonHtml = '';
      if (reason) {
        reasonHtml = `<div class="suggestion" style="color: var(--text-secondary);">📝 ${reason}</div>`;
      }

      // 决策和后续步骤
      let decisionHtml = '';
      if (decision) {
        decisionHtml = `<div class="data-points" style="background: rgba(0, 255, 200, 0.1); color: var(--color-success);">📋 决策: ${decision}</div>`;
        if (nextSteps.length > 0) {
          decisionHtml += `<div class="suggestion">📌 后续: ${nextSteps.join('; ')}</div>`;
        }
      }

      // 技能结果特殊处理（认知转译、破局灵感等）
      let skillContentHtml = '';
      if (insight.type === 'skill_result') {
        const skillType = content.skillType;
        if (skillType === 'inner_os' && content.quote) {
          skillContentHtml = `
            <div class="skill-content" style="margin-top: 8px; padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
              <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">💬 原话</div>
              <div style="font-style: italic; margin-bottom: 8px;">"${content.quote}"</div>
              <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">🎭 认知转译</div>
              <div style="color: var(--aurora-purple);">${content.innerThought || ''}</div>
              ${content.emotion ? `<div style="margin-top: 4px; font-size: 12px; color: var(--text-muted);">情绪: ${content.emotion}</div>` : ''}
            </div>
          `;
        } else if (skillType === 'brainstorm' && content.idea) {
          skillContentHtml = `
            <div class="skill-content" style="margin-top: 8px; padding: 12px; background: rgba(251, 191, 36, 0.1); border-radius: 8px;">
              <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">💡 破局灵感</div>
              <div style="color: var(--color-warning); font-weight: 500; margin-bottom: 8px;">${content.idea}</div>
              ${content.rationale ? `<div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">📖 ${content.rationale}</div>` : ''}
              ${content.challenge ? `<div style="font-size: 12px; color: var(--text-muted);">🎯 挑战: ${content.challenge}</div>` : ''}
            </div>
          `;
        } else if (skillType === 'stop_talking') {
          skillContentHtml = `
            <div class="skill-content" style="margin-top: 8px; padding: 12px; background: rgba(255, 107, 157, 0.1); border-radius: 8px;">
              ${content.mainTopic ? `<div style="margin-bottom: 4px;"><span style="color: var(--text-secondary);">主题:</span> ${content.mainTopic}</div>` : ''}
              ${content.deviation ? `<div style="margin-bottom: 4px; color: var(--color-warning);"><span style="color: var(--text-secondary);">偏离:</span> ${content.deviation}</div>` : ''}
              ${content.reminder ? `<div style="color: var(--aurora-pink);">💬 ${content.reminder}</div>` : ''}
            </div>
          `;
        }
      }

      // 可视化图片
      let visualizationHtml = '';
      if (insight.visualization && (insight.visualization.imageUrl || insight.visualization.imageBase64)) {
        const imgSrc = insight.visualization.imageUrl || `data:image/png;base64,${insight.visualization.imageBase64}`;
        visualizationHtml = `
          <div class="insight-card__visualization">
            <img src="${imgSrc}" 
                 alt="数据图表" 
                 onclick="showImageModal(this.src)" />
          </div>
        `;
      }

      // 时间戳
      const timestamp = insight.createdAt ? new Date(insight.createdAt) : new Date();

      card.innerHTML = `
        <div class="insight-card__header">
          <span class="insight-card__icon">${icon}</span>
          <span class="insight-card__title">${title}</span>
          <span class="insight-card__badge auto">自动</span>
          <span class="insight-card__time">${timestamp.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}</span>
        </div>
        ${sourceHtml}
        <div class="insight-card__content">
          ${summary}
        </div>
        ${dataPointsHtml}
        ${reasonHtml}
        ${suggestionHtml}
        ${decisionHtml}
        ${skillContentHtml}
        ${visualizationHtml}
      `;

      // 添加到洞察列表（在 visualizationList 之前）
      const visList = document.getElementById('visualizationList');
      if (visList) {
        elements.summaryList.insertBefore(card, visList);
      } else {
        elements.summaryList.appendChild(card);
      }
      
      // 滚动到底部
      elements.summaryList.scrollTop = elements.summaryList.scrollHeight;

      // 隐藏空状态（重新获取元素，因为可能被 renderSummaries 重建）
      const emptyState = document.getElementById('insightEmptyState');
      if (emptyState) {
        emptyState.style.display = 'none';
      }
      elements.insightEmptyState = emptyState;

      // 更新计数
      updateInsightCount();
      
      console.log('Agent insight card rendered:', insight.type, 'to summaryList');
    }

    // 更新转写列表中的关联标记
    function updateTranscriptLinks() {
      document.querySelectorAll('.transcript-item').forEach(item => {
        const transcriptId = item.dataset.transcriptId;
        if (state.transcriptInsightMap[transcriptId]) {
          item.classList.add('has-insight');
          
          // 添加关联徽章（如果还没有）
          if (!item.querySelector('.transcript-link-badge')) {
            const badge = document.createElement('span');
            badge.className = 'transcript-link-badge';
            badge.textContent = '💡';
            badge.title = '点击查看相关洞察';
            item.appendChild(badge);
          }

          // 添加点击事件
          item.onclick = () => scrollToInsight(state.transcriptInsightMap[transcriptId]);
        }
      });
    }

    // 滚动到指定洞察卡片
    function scrollToInsight(insightId) {
      const card = document.querySelector(`.insight-card[data-insight-id="${insightId}"]`);
      if (card) {
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        card.classList.add('highlight-pulse');
        setTimeout(() => card.classList.remove('highlight-pulse'), 2000);
      }
    }

    // 滚动到指定转写段落
    function scrollToTranscript(transcriptId) {
      if (!transcriptId) return;
      const item = document.querySelector(`.transcript-item[data-transcript-id="${transcriptId}"]`);
      if (item) {
        item.scrollIntoView({ behavior: 'smooth', block: 'center' });
        item.classList.add('highlight-pulse');
        setTimeout(() => item.classList.remove('highlight-pulse'), 2000);
      }
    }

    // 更新洞察计数
    function updateInsightCount() {
      const count = state.summaries.length + state.agentInsights.length;
      if (elements.insightCount) {
        elements.insightCount.textContent = count;
      }
    }

    // 显示图片模态框
    function showImageModal(src) {
      // 创建模态框
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        cursor: pointer;
      `;
      
      const img = document.createElement('img');
      img.src = src;
      img.style.cssText = `
        max-width: 90%;
        max-height: 90%;
        border-radius: 8px;
        box-shadow: 0 0 40px rgba(0, 212, 255, 0.3);
      `;
      
      modal.appendChild(img);
      modal.onclick = () => modal.remove();
      document.body.appendChild(modal);
    }

    // ========== File Upload ==========
    async function uploadAndTranscribe() {
      if (!state.isConnected) { showToast(t('toast.connectBackendFirst'), 'error'); return; }
      const file = elements.uploadInput.files?.[0];
      if (!file) return;

      showToast(t('toast.uploadingFile'), 'info');

      try {
        const form = new FormData();
        form.append('file', file);

        const response = await fetch(`${state.apiBaseUrl}/sessions/upload`, {
          method: 'POST',
          body: form,
          headers: getNgrokHeaders(),
        });

        if (!response.ok) throw new Error(await response.text() || `HTTP ${response.status}`);

        const data = await response.json();
        state.sessionId = data.sessionId;
        state.taskId = data.taskId;
        state.transcription = [];
        state.summaries = [];
        renderTranscription();
        renderSummaries();
        stopPolling();
        startPolling();
        showToast(t('toast.fileUploadSuccess'), 'success');
      } catch (error) {
        showToast(t('toast.uploadFailed') + ': ' + error.message, 'error');
      }
    }

    // ========== QA ==========
    function handleQAKeypress(event) { if (event.key === 'Enter') askQuestion(); }

    async function askQuestion() {
      const question = elements.qaInput.value.trim();
      if (!question) return;
      if (!state.sessionId) { showToast(t('toast.startRecordFirst'), 'error'); return; }

      addQAMessage(question, 'user');
      elements.qaInput.value = '';
      elements.qaSendBtn.disabled = true;

      try {
        const response = await apiCall('POST', `/sessions/${state.sessionId}/qa`, { question });
        addQAMessage(response.answer, 'assistant');
      } catch (error) {
        addQAMessage('抱歉，出错了: ' + error.message, 'assistant');
      } finally {
        elements.qaSendBtn.disabled = false;
      }
    }

    function addQAMessage(content, role) {
      const el = document.createElement('div');
      el.className = `qa-message ${role}`;
      el.textContent = content;
      elements.qaMessages.appendChild(el);
      elements.qaMessages.scrollTop = elements.qaMessages.scrollHeight;
    }

    // ========== Visualization ==========
    function selectVisualizationType(type) {
      state.currentVisualizationType = type;
      document.querySelectorAll('.vis-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
      });
      elements.chartTypeSelect.style.display = type === 'chart' ? 'block' : 'none';
      updateVisualizationButtonState();
    }

    function updateVisualizationButtonState() {
      elements.visGenerateBtn.disabled = !state.sessionId || !state.transcription?.length;
    }

    async function generateVisualization() {
      if (!state.sessionId) { showToast(t('toast.startRecordFirst'), 'error'); return; }
      
      const type = state.currentVisualizationType;
      const chartType = type === 'chart' ? elements.chartTypeSelect.value : undefined;
      
      const generatingText = state.language === 'zh' ? '⏳ 生成中...' : '⏳ Generating...';
      const genStatusText = state.language === 'zh' ? '正在生成...' : 'Generating...';
      const genBtnText = state.language === 'zh' ? '✨ 生成视觉化' : '✨ Generate';
      
      elements.visGenerateBtn.disabled = true;
      elements.visGenerateBtn.textContent = generatingText;
      elements.visStatus.style.display = 'block';
      elements.visStatus.textContent = genStatusText;
      elements.visStatus.className = 'vis-status';
      
      try {
        const response = await apiCall('POST', `/sessions/${state.sessionId}/visualization`, { type, chartType });
        displayVisualization(response);
        elements.visStatus.style.display = 'none';
        showToast(t('toast.visualGenSuccess'), 'success');
      } catch (error) {
        elements.visStatus.textContent = t('toast.visualGenFailed');
        elements.visStatus.className = 'vis-status error';
        showToast(t('toast.visualGenFailed') + ': ' + error.message, 'error');
      } finally {
        elements.visGenerateBtn.disabled = false;
        elements.visGenerateBtn.textContent = genBtnText;
      }
    }

    function displayVisualization(result) {
      const imageSrc = result.imageUrl || (result.imageBase64 ? `data:${result.metadata?.mimeType || 'image/png'};base64,${result.imageBase64}` : '');
      
      if (imageSrc) {
        const preview = $('visPreview');
        const img = $('visPreviewImage');
        img.src = imageSrc;
        img.dataset.visId = result.id;
        preview.style.display = 'block';
      }
      
      // 添加到洞察面板
      const typeLabels = { chart: '科研图表', creative: '创意图像', poster: '逻辑海报' };
      const card = document.createElement('div');
      card.className = 'insight-card';
      card.dataset.visId = result.id;
      card.innerHTML = `
        <header class="insight-card__header">
          <span class="insight-card__icon">🎨</span>
          <h3 class="insight-card__title">${typeLabels[result.type] || result.type}</h3>
        </header>
        ${imageSrc ? `<img src="${imageSrc}" alt="视觉化" style="width:100%;border-radius:var(--radius-md);cursor:pointer;margin-top:12px;" onclick="viewVisualization('${result.id}')">` : ''}
      `;
      
      if (elements.visualizationList) {
        elements.visualizationList.insertBefore(card, elements.visualizationList.firstChild);
      }
      
      if (elements.insightEmptyState) {
        elements.insightEmptyState.style.display = 'none';
      }
    }

    function viewVisualizationFromPreview() {
      const img = $('visPreviewImage');
      if (!img?.src) return;
      openModal(img.src);
    }

    function viewVisualization(visId) {
      const card = document.querySelector(`[data-vis-id="${visId}"]`);
      const img = card?.querySelector('img');
      if (img?.src) openModal(img.src);
    }

    function openModal(src) {
      let modal = $('visModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'visModal';
        modal.className = 'vis-modal';
        modal.innerHTML = `
          <div class="vis-modal-content">
            <button class="vis-modal-close" onclick="closeModal()">关闭</button>
            <img class="vis-modal-image" id="visModalImage" src="">
          </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
      }
      $('visModalImage').src = src;
      modal.classList.add('show');
    }

    function closeModal() {
      $('visModal')?.classList.remove('show');
    }

    // ========== API ==========
    async function apiCall(method, path, body = null) {
      const headers = { 'Content-Type': 'application/json' };
      // 自动添加认证 token
      if (state.token) {
        headers['Authorization'] = `Bearer ${state.token}`;
      }
      // ngrok 免费版需要这个 header 来跳过警告页面
      if (state.apiBaseUrl.includes('ngrok')) {
        headers['ngrok-skip-browser-warning'] = 'true';
      }
      const options = { method, headers };
      if (body) options.body = JSON.stringify(body);
      
      const response = await fetch(`${state.apiBaseUrl}${path}`, options);
      
      // 处理配额不足错误
      if (response.status === 403) {
        const error = await response.json().catch(() => ({}));
        if (error.message?.includes('配额')) {
          showToast(error.message, 'warning');
          fetchQuota(); // 刷新配额显示
          throw new Error(error.message);
        }
      }
      
      if (!response.ok) throw new Error(await response.text() || `HTTP ${response.status}`);
      return response.json();
    }

    // ========== Utilities ==========
    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========== 重置所有状态（开始新录音时调用）==========
    function resetAllState() {
      // 停止之前的轮询和定时器
      stopPolling();
      stopAutoPush();
      stopAgentPolling(); // V3: 停止 Agent 轮询
      stopTimerUpdate();
      
      // 重置核心状态
      state.sessionId = null;
      state.taskId = null;
      state.transcription = [];
      state.summaries = [];
      state.recordingStartTime = null;
      
      // 重置暂停保存的内容
      state.savedTranscriptionBeforePause = [];
      state.savedSummariesBeforePause = [];
      state.savedAgentInsightsBeforePause = [];
      
      // V3: 重置 Agent 状态
      state.agentInsights = [];
      state.lastInsightId = null;
      state.transcriptInsightMap = {};
      
      // 重置计时器显示
      elements.recordingTimer.textContent = '00:00';
      
      // 隐藏下载按钮
      elements.downloadDropdown.style.display = 'none';
      
      // 清空转写列表
      renderTranscription();
      
      // 清空会议洞察列表
      renderSummaries();
      
      // 清空可视化列表
      if (elements.visualizationList) {
        elements.visualizationList.innerHTML = '';
      }
      
      // 隐藏可视化预览
      const visPreview = $('visPreview');
      if (visPreview) {
        visPreview.style.display = 'none';
      }
      const visPreviewImage = $('visPreviewImage');
      if (visPreviewImage) {
        visPreviewImage.src = '';
      }
      
      // 重置可视化状态
      const visStatus = $('visStatus');
      if (visStatus) {
        visStatus.style.display = 'none';
        visStatus.textContent = '';
      }
      
      // 清空问答消息历史（保留初始欢迎消息）
      elements.qaMessages.innerHTML = '<div class="qa-message assistant">👋 有问题随时问我，我会基于会议内容为你解答</div>';
      
      // 清空问答输入框
      elements.qaInput.value = '';
      
      // 重置技能按钮状态
      ['InnerOS', 'Brainstorm', 'StopTalking'].forEach(name => {
        const statusEl = $(`skill${name}Status`);
        if (statusEl) statusEl.textContent = '';
      });
      
      console.log('所有状态已重置，准备开始新会议');
    }

    // ========== 下载转写内容 ==========
    function toggleDownloadMenu() {
      const menu = $('downloadMenu');
      menu.classList.toggle('show');
      
      // 点击外部关闭菜单
      if (menu.classList.contains('show')) {
        setTimeout(() => {
          document.addEventListener('click', closeDownloadMenuOnClickOutside);
        }, 0);
      }
    }

    function closeDownloadMenuOnClickOutside(e) {
      const dropdown = $('downloadDropdown');
      if (!dropdown.contains(e.target)) {
        $('downloadMenu').classList.remove('show');
        document.removeEventListener('click', closeDownloadMenuOnClickOutside);
      }
    }

    function downloadTranscript(format) {
      $('downloadMenu').classList.remove('show');
      
      if (state.transcription.length === 0) {
        showToast(t('toast.noTranscriptToDownload'), 'warning');
        return;
      }

      const now = new Date();
      const dateStr = now.toLocaleDateString('zh-CN').replace(/\//g, '-');
      const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }).replace(':', '-');
      const filename = `会议转写_${dateStr}_${timeStr}`;

      if (format === 'word') {
        downloadAsWord(filename);
      } else if (format === 'pdf') {
        downloadAsPDF(filename);
      }
    }

    function downloadAsWord(filename) {
      // 构建 Word 文档内容（使用 HTML 格式，Word 可以识别）
      let content = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" 
              xmlns:w="urn:schemas-microsoft-com:office:word" 
              xmlns="http://www.w3.org/TR/REC-html40">
        <head>
          <meta charset="utf-8">
          <title>会议转写记录</title>
          <style>
            body { font-family: "Microsoft YaHei", sans-serif; line-height: 1.8; padding: 20px; }
            h1 { color: #333; border-bottom: 2px solid #00d4ff; padding-bottom: 10px; }
            .meta { color: #666; font-size: 14px; margin-bottom: 20px; }
            .item { margin-bottom: 16px; padding: 12px; background: #f8f9fa; border-left: 3px solid #00d4ff; }
            .time { color: #00d4ff; font-size: 12px; font-weight: bold; margin-bottom: 4px; }
            .text { color: #333; font-size: 14px; }
          </style>
        </head>
        <body>
          <h1>📝 会议转写记录</h1>
          <div class="meta">
            <p>生成时间：${new Date().toLocaleString('zh-CN')}</p>
            <p>转写条数：${state.transcription.length} 条</p>
          </div>
      `;

      state.transcription.forEach(item => {
        content += `
          <div class="item">
            <div class="time">${formatTime(item.startMs)}</div>
            <div class="text">${escapeHtml(item.text)}</div>
          </div>
        `;
      });

      content += '</body></html>';

      const blob = new Blob([content], { type: 'application/msword;charset=utf-8' });
      downloadBlob(blob, `${filename}.doc`);
      showToast(t('toast.wordDownloadSuccess'), 'success');
    }

    function downloadAsPDF(filename) {
      // 创建一个隐藏的 iframe 用于打印
      const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>会议转写记录</title>
          <style>
            @media print {
              body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            }
            body { 
              font-family: "Microsoft YaHei", "PingFang SC", sans-serif; 
              line-height: 1.8; 
              padding: 40px; 
              max-width: 800px; 
              margin: 0 auto;
              color: #333;
            }
            h1 { 
              color: #1a1a2e; 
              border-bottom: 3px solid #00d4ff; 
              padding-bottom: 12px; 
              margin-bottom: 8px;
            }
            .meta { 
              color: #666; 
              font-size: 13px; 
              margin-bottom: 24px; 
              padding-bottom: 16px;
              border-bottom: 1px solid #eee;
            }
            .meta p { margin: 4px 0; }
            .item { 
              margin-bottom: 14px; 
              padding: 14px 16px; 
              background: #f8f9fa; 
              border-left: 4px solid #00d4ff; 
              border-radius: 0 8px 8px 0;
              page-break-inside: avoid;
            }
            .time { 
              color: #0099cc; 
              font-size: 12px; 
              font-weight: 600; 
              margin-bottom: 6px; 
            }
            .text { 
              color: #333; 
              font-size: 14px; 
              line-height: 1.7;
            }
          </style>
        </head>
        <body>
          <h1>📝 会议转写记录</h1>
          <div class="meta">
            <p><strong>生成时间：</strong>${new Date().toLocaleString('zh-CN')}</p>
            <p><strong>转写条数：</strong>${state.transcription.length} 条</p>
          </div>
          ${state.transcription.map(item => `
            <div class="item">
              <div class="time">${formatTime(item.startMs)}</div>
              <div class="text">${escapeHtml(item.text)}</div>
            </div>
          `).join('')}
        </body>
        </html>
      `;

      // 创建新窗口进行打印（用户可选择保存为 PDF）
      const printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();
      
      // 等待内容加载完成后触发打印
      printWindow.onload = function() {
        setTimeout(() => {
          printWindow.print();
          showToast(t('toast.selectPdfSave'), 'info');
        }, 300);
      };
    }

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function showToast(message, type = 'info') {
      const icons = { success: '✓', error: '✕', info: 'ℹ', warning: '⚠' };
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<span>${icons[type] || 'ℹ'}</span><span>${escapeHtml(message)}</span>`;
      elements.toastContainer.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(50px)';
        setTimeout(() => toast.remove(), 300);
      }, 3500);
    }

    // Event bindings
    elements.recordBtn.addEventListener('click', toggleRecording);
    elements.pauseBtn.addEventListener('click', togglePause);
    elements.chartTypeSelect.addEventListener('change', function() {
      state.currentChartType = this.value;
    });

    // Initialize
    init();
  </script>
</body>
</html>
