# 后端代码结构说明文档

本文档详细说明了后端项目中红线框选部分的代码结构和各文件的作用。

## 📁 目录结构概览

```
backend/
├── src/
│   ├── main.ts                    # 应用入口文件
│   ├── modules/
│   │   ├── app.module.ts          # 根模块，整合所有子模块
│   │   ├── session/               # 会话管理模块
│   │   ├── context/               # 上下文存储模块
│   │   ├── llm/                   # LLM适配器模块
│   │   ├── auto-push/             # 自动推送分析模块
│   │   ├── skill/                 # 技能触发模块
│   │   ├── task-poller/           # 任务轮询模块
│   │   └── tingwu/                 # 通义听悟集成模块
│   └── shared/
│       └── configuration.ts       # 配置管理
└── .env                           # 环境变量配置文件
```

---

## 📄 核心文件说明

### 1. `src/main.ts` - 应用入口文件

**作用：** NestJS 应用的启动入口，负责初始化应用、配置中间件和启动服务器。

**主要功能：**
- 加载环境变量（`.env` 文件）
- 创建 NestJS 应用实例
- 配置 CORS（跨域资源共享）
- 配置请求体大小限制（15MB）
- 配置全局验证管道（ValidationPipe）
- 启动 HTTP 服务器（默认端口 4000）

**关键代码：**
```typescript
- 启用 CORS，允许所有来源
- 设置 JSON 和 URL 编码请求体大小限制为 15MB
- 配置全局验证管道，自动过滤和转换请求数据
```

---

### 2. `src/modules/app.module.ts` - 根模块

**作用：** NestJS 的根模块，负责导入和整合所有功能模块。

**主要功能：**
- 配置全局配置模块（ConfigModule）
- 导入所有业务模块：
  - `ContextModule` - 上下文存储
  - `LLMModule` - LLM 适配器
  - `AutoPushModule` - 自动推送
  - `SessionModule` - 会话管理

**模块依赖关系：**
```
AppModule
├── ConfigModule (全局配置)
├── ContextModule (上下文存储)
├── LLMModule (LLM 服务)
├── AutoPushModule (自动分析)
└── SessionModule (会话管理)
    ├── TingwuModule (通义听悟)
    ├── PollerModule (任务轮询)
    ├── SkillModule (技能触发)
    ├── AutoPushModule
    ├── ContextModule
    └── LLMModule
```

---

### 3. `src/shared/configuration.ts` - 配置管理

**作用：** 统一管理应用配置，从环境变量读取并组织配置项。

**配置项说明：**

| 配置项 | 环境变量 | 默认值 | 说明 |
|--------|---------|--------|------|
| `tingwu.region` | `TINGWU_REGION` | `cn-beijing` | 通义听悟服务区域 |
| `tingwu.endpoint` | `TINGWU_ENDPOINT` | `tingwu.{region}.aliyuncs.com` | 通义听悟服务端点 |
| `tingwu.accessKeyId` | `TINGWU_ACCESS_KEY_ID` | `""` | 阿里云访问密钥ID |
| `tingwu.accessKeySecret` | `TINGWU_ACCESS_KEY_SECRET` | `""` | 阿里云访问密钥Secret |
| `tingwu.appKey` | `TINGWU_APP_KEY` | `""` | 通义听悟应用密钥 |
| `pollingIntervalMs` | `POLLING_INTERVAL_MS` | `5000` | 任务轮询间隔（毫秒） |
| `llm.apiKey` | `DASHSCOPE_API_KEY` | `""` | 阿里云 DashScope API Key |
| `llm.model` | `LLM_MODEL` | `qwen3-max` | LLM 模型名称 |
| `llm.baseUrl` | `LLM_BASE_URL` | DashScope 兼容端点 | LLM API 基础URL |
| `llm.temperature` | `LLM_TEMPERATURE` | `0.7` | LLM 温度参数 |
| `llm.maxTokens` | `LLM_MAX_TOKENS` | `2000` | LLM 最大输出token数 |
| `autoPush.intervalMs` | `AUTO_PUSH_INTERVAL_MS` | `60000` | 自动推送间隔（毫秒） |
| `autoPush.enabled` | `AUTO_PUSH_ENABLED` | `true` | 是否启用自动推送 |

---

## 📦 模块详细说明

### 4. `src/modules/session/` - 会话管理模块

**作用：** 管理会议会话的完整生命周期，包括创建、音频处理、转写获取、技能触发等。

#### 4.1 `session.module.ts`
- 定义 Session 模块，导入所有依赖模块
- 导出 `SessionService` 供其他模块使用

#### 4.2 `session.service.ts`
**核心服务类，提供以下功能：**

| 方法 | 功能说明 |
|------|---------|
| `createRealtimeSession()` | 创建实时转写会话，初始化通义听悟任务 |
| `ingestAudioChunk()` | 接收并处理音频数据块（Base64编码） |
| `processAudio()` | 处理音频文件，刷新任务连接 |
| `completeSession()` | 完成会话，停止所有相关服务 |
| `getTranscripts()` | 获取会话的转写文本（优先从ContextStore获取） |
| `getSummaries()` | 获取会话的摘要信息 |
| `triggerSkill()` | 触发技能（内心OS、头脑风暴、别再说了） |
| `uploadAudioFile()` | 上传音频文件进行处理 |
| `startAutoPush()` | 启动自动推送分析 |
| `stopAutoPush()` | 停止自动推送分析 |
| `getAutoPushStatus()` | 获取自动推送状态 |
| `askQuestion()` | 自由问答功能，基于会议内容回答问题 |
| `getMessages()` | 获取会话的所有消息（包括问答、技能结果等） |

**数据存储：**
- `sessions` Map：存储会话基本信息（taskId, meetingJoinUrl）
- `transcripts` Map：存储转写文本
- `summaries` Map：存储摘要卡片
- `taskStatuses` Map：存储任务状态

#### 4.3 `session.controller.ts`
**RESTful API 控制器，提供以下接口：**

| 路由 | 方法 | 功能 |
|------|------|------|
| `/sessions/health` | GET | 健康检查 |
| `/sessions` | POST | 创建会话 |
| `/sessions/:id/transcripts` | GET | 获取转写文本 |
| `/sessions/:id/summaries` | GET | 获取摘要 |
| `/sessions/:id/skills/:skillType` | POST | 触发技能 |
| `/sessions/:id/audio` | POST | 上传音频块 |
| `/sessions/upload` | POST | 上传音频文件 |
| `/sessions/:id/process` | POST | 处理音频 |
| `/sessions/:id/complete` | POST | 完成会话 |
| `/sessions/:id/auto-push/start` | POST | 启动自动推送 |
| `/sessions/:id/auto-push/stop` | POST | 停止自动推送 |
| `/sessions/:id/auto-push/status` | GET | 获取自动推送状态 |
| `/sessions/:id/qa` | POST | 自由问答 |
| `/sessions/:id/messages` | GET | 获取消息列表 |

#### 4.4 `session.dto.ts`
**数据传输对象（DTO），定义请求参数验证规则：**

- `CreateSessionDto`：创建会话的请求参数
  - `meetingId`：会议ID（必填）
  - `topic`：会议主题（可选）
- `UploadAudioChunkDto`：上传音频块的请求参数
  - `chunk`：Base64编码的音频数据（必填）
- `AskQuestionDto`：问答请求参数
  - `question`：用户问题（必填）

---

### 5. `src/modules/context/` - 上下文存储模块

**作用：** 管理会话的上下文信息，包括转写文本、消息流、会议阶段等。

#### 5.1 `context.module.ts`
- 全局模块，所有模块都可以使用 `ContextStoreService`
- 导出 `ContextStoreService`

#### 5.2 `context-store.service.ts`
**上下文存储服务，提供以下功能：**

**数据结构：**
```typescript
interface SessionContext {
  sessionId: string;
  segments: ContextSegment[];      // 转写文本段落
  messages: ChatMessage[];         // 消息流（问答、技能结果等）
  meetingPhase: string;            // 会议阶段（开场/讨论/决策等）
  lastAutoAnalysis: Date | null;   // 上次自动分析时间
}
```

**主要方法：**

| 方法 | 功能说明 |
|------|---------|
| `initialize()` | 初始化会话上下文 |
| `appendFromTingwu()` | 从通义听悟WebSocket消息追加转写文本 |
| `getFullText()` | 获取完整文本（所有段落拼接） |
| `getRecentText()` | 获取最近N分钟的文本 |
| `getSegments()` | 获取所有转写段落 |
| `appendMessage()` | 追加对话消息（用户问题、AI回答等） |
| `getMessages()` | 获取所有消息 |
| `setMeetingPhase()` | 设置会议阶段 |
| `getMeetingPhase()` | 获取会议阶段 |
| `setLastAutoAnalysis()` | 设置上次自动分析时间 |
| `getLastAutoAnalysis()` | 获取上次自动分析时间 |
| `clear()` | 清理会话上下文 |
| `getStats()` | 获取上下文统计信息 |

**特点：**
- 实时更新：从通义听悟WebSocket实时接收转写结果
- 去重合并：相同index的段落会更新而非重复添加
- 时间排序：段落按时间顺序排列

---

### 6. `src/modules/llm/` - LLM适配器模块

**作用：** 封装与LLM（大语言模型）的交互，支持多种调用方式。

#### 6.1 `llm.module.ts`
- 全局模块，导出 `LLMAdapterService`

#### 6.2 `llm-adapter.service.ts`
**LLM适配器服务，基于 OpenAI 兼容接口（实际使用阿里云 DashScope）：**

**主要方法：**

| 方法 | 功能说明 |
|------|---------|
| `chat()` | 多轮对话，支持消息历史 |
| `chatWithPrompt()` | 单轮对话，使用系统提示词 |
| `chatStream()` | 流式输出，支持实时返回 |
| `chatForJson()` | 解析JSON响应，自动提取JSON内容 |
| `isAvailable()` | 检查LLM是否可用（API Key是否配置） |

**配置：**
- 默认模型：`qwen3-max`（通义千问3-Max）
- 默认温度：`0.7`
- 默认最大token：`2000`
- API端点：阿里云 DashScope 兼容模式

**使用场景：**
- 技能触发（内心OS、头脑风暴、别再说了）
- 自动推送分析
- 自由问答

---

### 7. `src/modules/auto-push/` - 自动推送分析模块

**作用：** 定时自动分析会议内容，提供多维度洞察。

#### 7.1 `auto-push.module.ts`
- 导出 `AutoPushService`

#### 7.2 `auto-push.service.ts`
**自动推送服务，提供以下功能：**

**分析维度：**
- **会议阶段**：开场/讨论/争论/决策/总结
- **关键点**：3个核心关键点
- **盲点**：潜在的逻辑漏洞或盲点
- **专家建议**：是否需要专家介入的建议
- **内心OS**（可选）：一句话内心OS洞察

**主要方法：**

| 方法 | 功能说明 |
|------|---------|
| `startAutoAnalysis()` | 启动自动分析（定时执行） |
| `stopAutoAnalysis()` | 停止自动分析 |
| `pauseAutoAnalysis()` | 暂停自动分析 |
| `resumeAutoAnalysis()` | 恢复自动分析 |
| `isRunning()` | 检查是否正在运行 |
| `analyze()` | 执行一次分析 |
| `toSummaryCard()` | 转换为摘要卡片格式 |

**工作流程：**
1. 启动后，每隔 `intervalMs`（默认60秒）执行一次分析
2. 从 `ContextStore` 获取完整会议文本
3. 调用 LLM 进行分析
4. 解析 JSON 响应
5. 更新会议阶段和自动分析时间
6. 保存到消息流
7. 通过回调函数通知调用方

---

### 8. `src/modules/skill/` - 技能触发模块

**作用：** 提供多种会议分析技能，基于LLM实现。

#### 8.1 `skill.module.ts`
- 导出 `SkillService`

#### 8.2 `skill.service.ts`
**技能服务，支持以下技能类型：**

**技能类型：**

1. **`inner_os`（内心OS）**
   - 分析会议对话中的潜台词和未说出口的想法
   - 风格：犀利但不失幽默
   - 输出：3-5个内心OS，包含原话引用、真实想法、情绪

2. **`brainstorm`（头脑风暴）**
   - 基于当前讨论提供突破性创意建议
   - 风格：史蒂夫·乔布斯式的颠覆性思维
   - 输出：3-5个创意，包含创意、乔布斯式解释、挑战的假设

3. **`stop_talking`（别再说了）**
   - 分析讨论是否偏离主题
   - 输出：是否跑题、主线、偏离点、提醒话术

**主要方法：**

| 方法 | 功能说明 |
|------|---------|
| `triggerSkill()` | 触发指定技能 |
| `toSummaryCards()` | 转换为前端卡片格式 |

**工作流程：**
1. 根据技能类型获取相应的上下文（最近5分钟或全部文本）
2. 使用对应的Prompt模板调用LLM
3. 解析JSON响应
4. 保存到消息流
5. 返回结果并转换为卡片格式

**回退机制：**
- 如果LLM不可用，`stop_talking` 技能会直接失败
- `inner_os` 和 `brainstorm` 会回退到通义听悟的 CustomPrompt（旧实现）

---

### 9. `src/modules/task-poller/` - 任务轮询模块

**作用：** 定时轮询通义听悟任务状态，获取转写和摘要结果。

#### 9.1 `poller.module.ts`
- 导入 `TingwuModule`（循环依赖，使用 `forwardRef`）
- 导出 `PollerService`

#### 9.2 `poller.service.ts`
**轮询服务，提供以下功能：**

**主要方法：**

| 方法 | 功能说明 |
|------|---------|
| `registerTask()` | 注册任务，开始定时轮询 |
| `unregisterTask()` | 取消注册任务，停止轮询 |

**工作流程：**
1. 注册任务时，创建定时器（默认每5秒轮询一次）
2. 每次轮询调用 `TingwuService.getTaskSnapshot()` 获取任务快照
3. 通过回调函数将结果传递给调用方
4. 调用方可以处理转写文本、摘要、任务状态等

**轮询数据：**
- `transcription`：转写文本段落数组
- `summaries`：摘要信息数组
- `taskStatus`：任务状态（NEW/ONGOING/COMPLETED等）

---

### 10. `src/modules/tingwu/` - 通义听悟集成模块

**作用：** 封装与阿里云通义听悟服务的交互。

#### 10.1 `tingwu.module.ts`
- 导入 `ContextModule`
- 导出 `TingwuService` 和 `AudioRelayService`

#### 10.2 `tingwu.service.ts`
**通义听悟服务，提供以下功能：**

**主要方法：**

| 方法 | 功能说明 |
|------|---------|
| `createRealtimeTask()` | 创建实时转写任务 |
| `triggerCustomPrompt()` | 触发自定义提示词（旧实现，用于回退） |
| `getTaskSnapshot()` | 获取任务快照（转写、摘要、状态） |
| `stopRealtimeTask()` | 停止实时转写任务 |

**任务配置：**
- 输入格式：PCM，16kHz，单声道
- 转写输出级别：2（段落级别）
- 启用摘要：段落摘要、对话摘要
- 启用会议助手：关键词、待办事项、重要信息
- 启用自动章节

**特点：**
- 自动提取 `meetingJoinUrl`（WebSocket连接地址）
- 如果初始响应缺少URL，会轮询等待
- 支持多种响应格式的兼容处理

#### 10.3 `audio-relay.service.ts`
**音频中继服务，负责音频数据的处理和转发：**

**主要功能：**
1. **WebSocket连接管理**
   - 连接到通义听悟的WebSocket服务器
   - 发送 `StartTranscription` 命令
   - 接收转写结果并更新到 `ContextStore`

2. **音频格式转换**
   - 使用 FFmpeg 将 WebM 格式转换为 PCM
   - 支持实时流式转换和文件转换
   - 输出格式：PCM S16LE，16kHz，单声道

3. **音频数据发送**
   - 将PCM数据分块发送到WebSocket（每块100ms）
   - 支持实时流式发送和批量发送

**主要方法：**

| 方法 | 功能说明 |
|------|---------|
| `create()` | 创建音频中继会话，建立WebSocket连接 |
| `updateUrl()` | 更新WebSocket连接地址 |
| `ingestWebmChunk()` | 接收WebM音频块，实时转码并发送 |
| `ingestPcmBuffer()` | 接收PCM音频数据，直接发送 |
| `ingestAudioFile()` | 处理上传的音频文件 |
| `processAndSend()` | 处理并发送音频（兼容方法） |
| `stop()` | 停止中继，关闭连接和FFmpeg进程 |

**工作流程：**
1. 创建会话时，立即建立WebSocket连接
2. 连接成功后，发送 `StartTranscription` 命令
3. 接收音频数据（WebM格式）
4. 使用FFmpeg实时转换为PCM格式
5. 分块发送PCM数据到WebSocket
6. 接收转写结果，更新到 `ContextStore`
7. 会话结束时，发送 `StopTranscription` 命令并关闭连接

---

## 🔧 环境变量配置（.env文件）

**作用：** 存储应用配置信息，包括API密钥、服务端点等。

**必需配置项：**

```env
# 通义听悟配置
TINGWU_REGION=cn-beijing
TINGWU_ACCESS_KEY_ID=your_access_key_id
TINGWU_ACCESS_KEY_SECRET=your_access_key_secret
TINGWU_APP_KEY=your_app_key

# LLM配置（阿里云DashScope）
DASHSCOPE_API_KEY=your_dashscope_api_key
LLM_MODEL=qwen3-max
LLM_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1

# 可选配置
PORT=4000
POLLING_INTERVAL_MS=5000
AUTO_PUSH_INTERVAL_MS=60000
AUTO_PUSH_ENABLED=true
LLM_TEMPERATURE=0.7
LLM_MAX_TOKENS=2000
```

---

## 🔄 数据流转图

```
客户端
  ↓
SessionController (REST API)
  ↓
SessionService
  ├──→ TingwuService (创建任务)
  ├──→ AudioRelayService (音频处理)
  │     ├──→ FFmpeg (格式转换)
  │     └──→ WebSocket (发送音频)
  │           └──→ ContextStore (实时转写)
  ├──→ PollerService (轮询任务状态)
  │     └──→ TingwuService (获取快照)
  ├──→ SkillService (触发技能)
  │     └──→ LLMAdapterService (调用LLM)
  ├──→ AutoPushService (自动分析)
  │     ├──→ ContextStore (获取文本)
  │     └──→ LLMAdapterService (调用LLM)
  └──→ ContextStore (存储上下文)
```

---

## 📝 总结

这是一个基于 NestJS 的会议实时转写和分析系统，主要特点：

1. **模块化设计**：各模块职责清晰，易于维护和扩展
2. **实时处理**：支持实时音频转写和上下文更新
3. **智能分析**：集成LLM提供多种分析技能
4. **自动推送**：定时自动分析会议内容
5. **灵活问答**：支持基于会议内容的自由问答

**核心依赖：**
- **通义听悟**：提供实时语音转写服务
- **阿里云DashScope（Qwen3-Max）**：提供LLM能力
- **FFmpeg**：音频格式转换
- **WebSocket**：实时通信

---

*文档生成时间：2024年*
*项目路径：D:\code\discussion_new\backend*

