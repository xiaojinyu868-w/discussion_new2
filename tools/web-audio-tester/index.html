<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>会议快照后端音频测试工具</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
      }
      body {
        margin: 0;
        padding: 32px;
        background: #f6f7fb;
        color: #102542;
      }
      h1 {
        margin-top: 0;
      }
      section {
        background: #ffffff;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 12px 32px rgba(16, 37, 66, 0.08);
      }
      label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
      }
      input,
      button,
      select,
      textarea {
        font-size: 15px;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #cfd7e6;
        width: 100%;
        box-sizing: border-box;
      }
      input:focus,
      button:focus,
      select:focus,
      textarea:focus {
        outline: 2px solid #2f80ed;
        border-color: #2f80ed;
      }
      button {
        cursor: pointer;
        font-weight: 600;
        color: #ffffff;
        border: none;
        background: linear-gradient(135deg, #2f80ed, #6c5ce7);
        transition: transform 0.12s ease, box-shadow 0.12s ease;
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 16px rgba(47, 128, 237, 0.25);
      }
      button.secondary {
        background: transparent;
        color: #2f80ed;
        border: 1px solid #2f80ed;
      }
      .inline {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .inline > * {
        flex: 1;
      }
      .inline button {
        flex: 0 0 auto;
      }
      .stack {
        display: grid;
        gap: 18px;
      }
      .log {
        min-height: 160px;
        max-height: 280px;
        resize: vertical;
        font-family: "Fira Code", Consolas, monospace;
        white-space: pre-wrap;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 0 10px;
        height: 28px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        background: rgba(47, 128, 237, 0.12);
        color: #2f80ed;
      }
      .grid {
        display: grid;
        gap: 20px;
      }
      @media (max-width: 720px) {
        body {
          padding: 20px;
        }
        .inline {
          flex-direction: column;
          align-items: stretch;
        }
        .inline button {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <h1>会议快照后端音频测试工具</h1>
    <p>
      通过浏览器手动上传音频文件，验证后端联通阿里通义听悟的效果，排查移动端采集问题。
      <span class="badge">仅供本地测试</span>
    </p>

    <section>
      <div class="stack">
        <div>
          <label for="baseUrl">后端地址</label>
          <input
            id="baseUrl"
            type="text"
            value="http://localhost:4000"
            placeholder="http://localhost:4000"
          />
        </div>

        <div class="inline">
          <div>
            <label for="meetingId">自定义 Meeting ID（可选）</label>
            <input
              id="meetingId"
              type="text"
              placeholder="留空则自动生成 meeting- 时间戳"
            />
          </div>
          <button id="createSessionBtn">创建实时任务</button>
        </div>

        <div>
          <label>当前会话</label>
          <div id="sessionInfo">尚未创建任务</div>
        </div>

        <div class="inline">
          <button id="processAudioBtn" class="secondary">
            处理音频
          </button>
          <button id="completeSessionBtn" class="secondary">
            停止任务
          </button>
          <button id="fetchTranscriptsBtn" class="secondary">
            获取转写 / 摘要
          </button>
        </div>
      </div>
    </section>

    <section>
      <div class="stack">
        <div>
          <label for="audioFile">选择音频文件</label>
          <input id="audioFile" type="file" accept="audio/*,.m4a,.aac,.wav" />
        </div>

        <div class="inline">
          <div>
            <label for="chunkSize">每次推送字节数</label>
            <input
              id="chunkSize"
              type="number"
              min="1024"
              step="1024"
              value="32768"
            />
          </div>
          <div>
            <label for="chunkInterval">每个分片间隔（毫秒）</label>
            <input id="chunkInterval" type="number" min="0" value="150" />
          </div>
          <button id="uploadBtn">开始推流</button>
        </div>

        <div>
          <label>转写结果</label>
          <textarea id="transcriptOutput" rows="8" readonly></textarea>
        </div>
      </div>
    </section>

    <section>
      <div class="stack">
        <div class="inline">
          <span>调试输出</span>
          <button id="clearLogBtn" class="secondary">清空</button>
        </div>
        <textarea id="log" class="log" readonly></textarea>
      </div>
    </section>

    <script>
      const elements = {
        baseUrl: document.getElementById("baseUrl"),
        meetingId: document.getElementById("meetingId"),
        createSessionBtn: document.getElementById("createSessionBtn"),
        completeSessionBtn: document.getElementById("completeSessionBtn"),
        processAudioBtn: document.getElementById("processAudioBtn"),
        fetchTranscriptsBtn: document.getElementById("fetchTranscriptsBtn"),
        sessionInfo: document.getElementById("sessionInfo"),
        audioFile: document.getElementById("audioFile"),
        chunkSize: document.getElementById("chunkSize"),
        chunkInterval: document.getElementById("chunkInterval"),
        uploadBtn: document.getElementById("uploadBtn"),
        transcriptOutput: document.getElementById("transcriptOutput"),
        log: document.getElementById("log"),
        clearLogBtn: document.getElementById("clearLogBtn"),
      };

      const state = {
        sessionId: null,
        taskId: null,
        meetingJoinUrl: null,
        isUploading: false,
      };

      function log(message, data) {
        const time = new Date().toLocaleTimeString();
        if (data !== undefined) {
          elements.log.value = `[${time}] ${message}\n${JSON.stringify(
            data,
            null,
            2
          )}\n\n` + elements.log.value;
        } else {
          elements.log.value = `[${time}] ${message}\n` + elements.log.value;
        }
      }

      function arrayBufferToBase64(buffer) {
        const bytes = new Uint8Array(buffer);
        const chunkSize = 0x8000;
        let value = "";
        for (let i = 0; i < bytes.length; i += chunkSize) {
          const chunk = bytes.subarray(i, i + chunkSize);
          let chunkString = "";
          for (let j = 0; j < chunk.length; j += 1) {
            chunkString += String.fromCharCode(chunk[j]);
          }
          value += chunkString;
        }
        return btoa(value);
      }

      async function createSession() {
        const meetingId =
          elements.meetingId.value.trim() || `meeting-${Date.now()}`;
        const url = `${elements.baseUrl.value.trim().replace(/\/$/, "")}/sessions`;
        log("正在创建实时任务…", { url, meetingId });
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ meetingId }),
        });
        if (!response.ok) {
          const body = await response.text();
          throw new Error(`创建任务失败: ${response.status} ${body}`);
        }
        const payload = await response.json();
        state.sessionId = payload.sessionId;
        state.taskId = payload.taskId;
        state.meetingJoinUrl = payload.meetingJoinUrl;
        elements.sessionInfo.textContent = `Session ID: ${state.sessionId} ｜ Task ID: ${state.taskId}`;
        log("任务创建成功", payload);
      }

      async function completeSession() {
        if (!state.sessionId) {
          log("尚未创建任务，无需停止。");
          return;
        }
        const url = `${elements.baseUrl.value
          .trim()
          .replace(/\/$/, "")}/sessions/${state.sessionId}/complete`;
        log("正在停止实时任务…", { url });
        await fetch(url, { method: "POST" });
        log("停止请求已发送。");
      }

      async function processAudio() {
        if (!state.sessionId) {
          log("请先创建任务。");
          return;
        }
        const url = `${elements.baseUrl.value
          .trim()
          .replace(/\/$/, "")}/sessions/${state.sessionId}/process`;
        log("正在处理音频并发送到通义听悟…", { url });
        try {
          const response = await fetch(url, { method: "POST" });
          if (response.ok) {
            log("✅ 音频处理完成！请等待几秒后获取转写结果。");
          } else {
            const text = await response.text();
            log(`❌ 处理失败: ${response.status} ${text}`);
          }
        } catch (error) {
          log("处理音频失败", error);
        }
      }

      async function fetchTranscripts() {
        if (!state.sessionId) {
          log("请先创建任务。");
          return;
        }
        const responses = await Promise.all([
          fetch(
            `${elements.baseUrl.value
              .trim()
              .replace(/\/$/, "")}/sessions/${state.sessionId}/transcripts`
          ),
          fetch(
            `${elements.baseUrl.value
              .trim()
              .replace(/\/$/, "")}/sessions/${state.sessionId}/summaries`
          ),
        ]);
        const [transcripts, summaries] = await Promise.all(
          responses.map((resp) => resp.json())
        );
        elements.transcriptOutput.value = JSON.stringify(
          {
            transcription: transcripts.transcription,
            summaries: summaries.summaries,
            taskStatus: transcripts.taskStatus,
          },
          null,
          2
        );
        log("已获取转写与摘要。");
      }

      async function uploadAudio() {
        if (state.isUploading) {
          log("正在推流中，请稍候…");
          return;
        }
        if (!state.sessionId) {
          log("请先创建实时任务。");
          return;
        }
        const file = elements.audioFile.files[0];
        if (!file) {
          log("请先选择音频文件。");
          return;
        }

        const chunkSize = Math.max(1024, Number(elements.chunkSize.value) || 32768);
        const interval = Math.max(0, Number(elements.chunkInterval.value) || 0);
        const baseUrl = elements.baseUrl.value.trim().replace(/\/$/, "");
        const endpoint = `${baseUrl}/sessions/${state.sessionId}/audio`;

        log("读取音频文件…", { name: file.name, size: file.size });
        const buffer = await file.arrayBuffer();

        let offset = 0;
        let chunkIndex = 0;
        state.isUploading = true;
        elements.uploadBtn.disabled = true;

        while (offset < buffer.byteLength && state.isUploading) {
          const end = Math.min(offset + chunkSize, buffer.byteLength);
          const slice = buffer.slice(offset, end);
          const base64 = arrayBufferToBase64(slice);
          chunkIndex += 1;

          try {
            const response = await fetch(endpoint, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ chunk: base64 }),
            });
            if (!response.ok) {
              const text = await response.text();
              throw new Error(`${response.status} ${text}`);
            }
          } catch (error) {
            log(`上传第 ${chunkIndex} 个分片失败`, error);
            state.isUploading = false;
            elements.uploadBtn.disabled = false;
            throw error;
          }

          log(`已发送分片 ${chunkIndex}`, {
            bytes: end - offset,
            progress: ((end / buffer.byteLength) * 100).toFixed(1) + "%",
          });

          offset = end;
          if (interval > 0) {
            await new Promise((resolve) => setTimeout(resolve, interval));
          }
        }

        state.isUploading = false;
        elements.uploadBtn.disabled = false;
        log("音频推流完成！");
      }

      elements.createSessionBtn.addEventListener("click", async () => {
        try {
          await createSession();
        } catch (error) {
          log("创建任务失败", error);
        }
      });

      elements.completeSessionBtn.addEventListener("click", async () => {
        try {
          await completeSession();
        } catch (error) {
          log("停止任务失败", error);
        }
      });

      elements.processAudioBtn.addEventListener("click", async () => {
        try {
          await processAudio();
        } catch (error) {
          log("处理音频失败", error);
        }
      });

      elements.fetchTranscriptsBtn.addEventListener("click", async () => {
        try {
          await fetchTranscripts();
        } catch (error) {
          log("获取转写失败", error);
        }
      });

      elements.uploadBtn.addEventListener("click", async () => {
        try {
          await uploadAudio();
        } catch (error) {
          log("推流过程中出现异常，请检查日志。", error);
        }
      });

      elements.clearLogBtn.addEventListener("click", () => {
        elements.log.value = "";
      });
    </script>
  </body>
</html>
