# 需求文档: 会议快照 V3 - Agent-Flow 智能联动系统

## 1. 背景与动机

### 1.1 现状问题

当前系统（V1/V2）存在明显的"左右分离"问题：

| 问题 | 描述 |
|------|------|
| **缺乏联动** | 左侧转写面板和右侧洞察面板各自独立工作，像两个互不交流的同事 |
| **被动触发** | 洞察需要用户手动点击技能按钮才能生成，缺乏主动性 |
| **无上下文关联** | 洞察卡片不知道是基于哪段对话生成的，用户无法追溯 |
| **时机不当** | 用户可能错过最佳的洞察时机（如关键数据出现时） |

### 1.2 用户痛点

> "左边是速记员，右边是另一个坐在旁边的分析师，他们在各干各的。"

用户期望的体验：
- 当有人说到关键数据时，右边**自动浮现出图表**
- 当有人在胡扯时，右边**悄悄提醒"他在兜圈子"**
- 转写和洞察之间有**流动感（Flow）**，而不是割裂的

### 1.3 核心理念：Agent-Flow

将系统设计为一个**智能 Agent**，能够：
- **自动感知**：实时监听转写内容
- **智能决策**：判断何时触发什么动作
- **自动执行**：调用现有功能生成洞察

## 2. 现有功能清单（复用）

根据 `demo_show/index.html` 分析，以下功能已实现，Agent 将直接调用：

### 2.1 AI 技能（左下角三个按钮）

| 技能 | 图标 | 功能 | 后端接口 |
|------|------|------|---------|
| **潜台词** | 🔮 | 分析发言者的潜在意图 | `POST /sessions/:id/skills/inner_os` |
| **灵感** | ⚡ | 基于讨论内容激发创意 | `POST /sessions/:id/skills/brainstorm` |
| **聚焦** | 🎯 | 检测跑题并提醒聚焦 | `POST /sessions/:id/skills/stop_talking` |

### 2.2 视觉化共识

| 类型 | 图标 | 功能 | 后端接口 |
|------|------|------|---------|
| **数据图表** | 📊 | 生成雷达图/柱状图/流程图等 | `POST /sessions/:id/visualization` |
| **创意图像** | 🎨 | 生成创意图像 | `POST /sessions/:id/visualization` |
| **逻辑海报** | 📋 | 生成逻辑海报 | `POST /sessions/:id/visualization` |

### 2.3 其他功能

| 功能 | 说明 |
|------|------|
| 自动推送分析 | 每30秒自动触发分析（已有开关） |
| 会议问答 | 基于会议内容的问答 |
| 转写下载 | Word/PDF 导出 |

## 3. V3 新增功能需求

### 3.1 核心功能：Agent 智能联动

#### F1: Agent 控制器

**描述**：新增 Agent 模块，作为智能联动的核心控制器

**功能点**：
- 启动/停止 Agent 监控
- 每10秒运行一次检测循环
- 管理检测状态和冷却时间

**验收标准**：
- [ ] Agent 可正常启动/停止
- [ ] 循环间隔准确（10秒）
- [ ] 不影响现有功能

#### F2: 内容分析器

**描述**：分析转写内容，识别触发条件

| 检测类型 | 触发条件 | 检测方式 | 优先级 |
|---------|---------|---------|--------|
| **关键数据** | 数字、百分比、金额、趋势词 | 正则 + 关键词 | P0 |
| **决策时刻** | 决策关键词（确定、定了、同意等） | 关键词 | P0 |
| **周期性总结** | 每30秒定时触发 | 定时器 | P0 |
| **跑题检测** | 话题偏离主线 | LLM | P1 |
| **冗余检测** | 重复表述、兜圈子 | LLM | P1 |

**验收标准**：
- [ ] 数据检测准确率 > 80%
- [ ] 决策检测准确率 > 75%
- [ ] 检测延迟 < 3秒

#### F3: 动作分发器（关键：复用现有功能）

**描述**：根据检测结果，自动调用现有功能

| 检测类型 | 触发动作 | 调用的现有功能 |
|---------|---------|---------------|
| 关键数据 | 自动生成图表 | `VisualizationService.generateVisualization()` |
| 跑题检测 | 自动聚焦提醒 | `SkillService.triggerSkill('stop_talking')` |
| 周期性总结 | 生成阶段小结 | `LLMAdapter.chatWithPrompt()` |
| 决策时刻 | 生成决策记录 | `LLMAdapter.chatForJson()` |
| 冗余检测 | 生成精简建议 | 直接生成文字洞察 |

**验收标准**：
- [ ] 成功复用现有 SkillService
- [ ] 成功复用现有 VisualizationService
- [ ] 洞察生成延迟 < 5秒（不含图表）
- [ ] 图表生成延迟 < 15秒

#### F4: 转写-洞察关联

**描述**：建立转写段落与洞察卡片的双向关联

**功能点**：
- 转写侧：被关联的段落显示高亮标记 💡
- 洞察侧：显示"来源"引用，点击可跳转
- 双向跳转：点击任一侧可跳转到对应内容

**验收标准**：
- [ ] 关联标记清晰可见
- [ ] 点击跳转流畅（< 200ms）
- [ ] 双向跳转功能正常

#### F5: Agent 开关

**描述**：用户可以开启/关闭 Agent 自动联动功能

**功能点**：
- 默认开启
- 关闭后仍可手动触发技能
- 与现有"自动推送分析"开关独立

**验收标准**：
- [ ] 开关状态切换即时生效
- [ ] 关闭后不再自动生成洞察
- [ ] 手动触发功能不受影响

### 3.2 前端页面需求

#### F6: 新建 test.html

**描述**：在 `demo_show/test.html` 创建 Agent 联动测试页面

**要求**：
- 样式完全参照 `demo_show/index.html`
- 保留所有现有功能
- 新增 Agent 相关功能

**新增 UI 元素**：

| 元素 | 位置 | 功能 |
|------|------|------|
| Agent 开关 | AI 技能区域下方 | 开启/关闭 Agent |
| 转写关联标记 | 转写项右侧 | 显示 💡 图标 |
| 洞察来源引用 | 洞察卡片头部下方 | 显示来源文本 |
| 自动洞察徽章 | 洞察卡片头部 | 显示"自动"标签 |

**验收标准**：
- [ ] 样式与 index.html 一致
- [ ] 现有功能全部正常
- [ ] 新增功能正常工作

### 3.3 兼容性需求

#### C1: 现有功能兼容

| 功能 | 要求 |
|------|------|
| 手动技能触发（潜台词、灵感、聚焦） | 保持不变 |
| 视觉化生成功能 | 保持不变 |
| 问答功能 | 保持不变 |
| 自动推送开关 | 保持不变（与 Agent 开关独立） |
| 转写下载 | 保持不变 |

#### C2: 性能要求

| 指标 | 要求 |
|------|------|
| Agent 循环间隔 | 10秒 |
| 周期性总结间隔 | 30秒 |
| 检测延迟 | < 3秒 |
| 洞察生成延迟 | < 5秒 |
| 图表生成延迟 | < 15秒 |
| 前端渲染延迟 | < 100ms |

## 4. 用户故事

### US1: 数据自动图表化

**作为** 项目经理
**我希望** 当有人提到关键数据时，系统自动生成图表
**以便** 我能直观地理解数据，不用手动点击生成

**场景**：
1. 小明在会议中说："Q3的转化率是15%，比Q2提升了3个百分点"
2. Agent 检测到数据，自动调用**现有的"数据图表"功能**
3. 图表出现在右侧洞察面板，并标记关联的转写段落
4. 转写段落显示 💡 图标，点击可跳转到图表

### US2: 跑题自动提醒

**作为** 会议主持人
**我希望** 当讨论跑题时，系统自动提醒
**以便** 我能及时引导讨论回到正轨

**场景**：
1. 团队在讨论产品需求时，话题逐渐偏向技术实现细节
2. Agent 检测到跑题，自动调用**现有的"聚焦"技能**
3. 聚焦提醒卡片出现在右侧，显示"来源"引用
4. 我看到提醒后，引导团队回到需求讨论

### US3: 周期性进度总结

**作为** 团队成员
**我希望** 每隔30秒看到会议进度总结
**以便** 我能快速了解讨论进展

**场景**：
1. 会议进行了5分钟
2. Agent 自动生成阶段小结："目前已讨论完登录模块需求，正在讨论支付流程"
3. 小结卡片显示"自动"标签，表明是 Agent 生成的

### US4: 关联追溯

**作为** 产品经理
**我希望** 能从洞察追溯到原始对话
**以便** 我能验证洞察的准确性

**场景**：
1. 我看到一条自动生成的"数据洞察"
2. 洞察卡片显示"📌 来源：转化率是15%，比Q2..."
3. 我点击来源引用，页面自动滚动到对应的转写段落
4. 转写段落高亮显示

### US5: 手动功能不受影响

**作为** 用户
**我希望** 即使关闭 Agent，仍能手动使用所有功能
**以便** 我能按自己的节奏使用系统

**场景**：
1. 我关闭 Agent 开关
2. 系统不再自动生成洞察
3. 我仍然可以手动点击"潜台词"、"灵感"、"聚焦"按钮
4. 我仍然可以手动生成"数据图表"、"创意图像"、"逻辑海报"

## 5. 界面原型

### 5.1 AI 技能区域（新增 Agent 开关）

```
┌─────────────────────────────────────────┐
│ AI 技能                                 │
├─────────────────────────────────────────┤
│ [🔮 潜台词] [⚡ 灵感] [🎯 聚焦]         │
│                                         │
│ ─────────────────────────────────────── │
│ 自动推送分析    [========●] 开启        │  ← 现有开关
│ ─────────────────────────────────────── │
│ 🤖 Agent 智能联动 [========●] 开启      │  ← V3 新增
│ 自动检测数据/跑题，联动生成洞察         │
└─────────────────────────────────────────┘
```

### 5.2 转写面板（带关联标记）

```
┌─────────────────────────────────────────┐
│ 📝 实时转写                        [12] │
├─────────────────────────────────────────┤
│ ┌─────────────────────────────────────┐ │
│ │ 00:15                               │ │
│ │ 我们来看一下Q3的数据...            │ │
│ └─────────────────────────────────────┘ │
│ ┌─────────────────────────────────────┐ │
│ │ 00:32                          💡   │ │ ← 有关联洞察
│ │ 转化率是15%，比Q2提升了3个百分点   │ │
│ │ ▌ 紫色高亮边框                      │ │
│ └─────────────────────────────────────┘ │
│ ┌─────────────────────────────────────┐ │
│ │ 00:45                               │ │
│ │ 这个增长主要来自于...              │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

### 5.3 洞察面板（带来源引用）

```
┌─────────────────────────────────────────┐
│ ✨ 会议洞察                         [5] │
├─────────────────────────────────────────┤
│ ┌─────────────────────────────────────┐ │
│ │ 📊 数据洞察        [自动] 刚刚      │ │ ← 自动标签
│ │ ─────────────────────────────────── │ │
│ │ 📌 来源："转化率是15%，比Q2..."    │ │ ← 点击跳转
│ │ ─────────────────────────────────── │ │
│ │ 检测到Q3转化率数据：                │ │
│ │ • 转化率: 15%                       │ │
│ │ • 环比增长: 3%                      │ │
│ │                                     │ │
│ │ ┌─────────────────────────────────┐ │ │
│ │ │      [自动生成的柱状图]         │ │ │ ← 调用现有功能
│ │ │       Q2: 12%  Q3: 15%          │ │ │
│ │ └─────────────────────────────────┘ │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 📝 阶段小结        [自动] 30秒前    │ │
│ │ ─────────────────────────────────── │ │
│ │ 目前正在讨论Q3业绩数据，重点关注   │ │
│ │ 转化率提升的原因分析。              │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 🎯 聚焦提醒        [自动] 1分钟前   │ │
│ │ ─────────────────────────────────── │ │
│ │ 📌 来源："我们聊聊技术实现..."     │ │
│ │ ─────────────────────────────────── │ │
│ │ 检测到话题偏离，建议聚焦核心议题   │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

## 6. 优先级排序

### P0 - 必须实现（MVP）

| 功能 | 说明 |
|------|------|
| Agent 控制器 | 启动/停止/循环 |
| 数据检测 | 正则 + 关键词检测 |
| 自动生成图表 | 复用现有 VisualizationService |
| 周期性总结 | 每30秒生成阶段小结 |
| 转写-洞察关联 | 双向关联和跳转 |
| Agent 开关 | 用户可控制开关 |
| test.html 页面 | 新建测试页面 |

### P1 - 重要功能

| 功能 | 说明 |
|------|------|
| 跑题检测 | LLM 检测 |
| 自动聚焦提醒 | 复用现有 stop_talking 技能 |
| 决策检测 | 关键词检测 |
| 冗余检测 | LLM 检测 |

### P2 - 增强功能

| 功能 | 说明 |
|------|------|
| 洞察类型筛选 | 按类型筛选洞察 |
| 洞察通知 | 声音/浏览器通知 |
| 联动动画 | 高亮闪烁效果 |

## 7. 成功指标

| 指标 | 目标值 | 测量方式 |
|------|--------|---------| 
| 数据检测准确率 | > 80% | 人工抽样验证 |
| 图表自动生成成功率 | > 90% | 系统监控 |
| 洞察生成延迟 | < 5秒 | 系统监控 |
| 用户满意度 | > 4/5 | 用户反馈问卷 |
| 现有功能正常率 | 100% | 回归测试 |

## 8. 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|---------| 
| LLM 响应延迟 | 洞察生成慢 | 优先使用规则检测，LLM 检测设置超时 |
| 检测误报 | 用户体验差 | 设置置信度阈值，提供反馈机制 |
| 图表生成失败 | 功能不完整 | 降级为纯文字洞察 |
| 与现有功能冲突 | 功能异常 | 充分测试，保持独立 |

## 9. 文件规划

| 类型 | 路径 | 说明 |
|------|------|------|
| 新建 | `demo_show/test.html` | Agent 联动测试页面 |
| 新建 | `backend/src/modules/agent/` | Agent 模块 |
| 不变 | `demo_show/index.html` | 现有功能保持不变 |
| 不变 | `backend/src/modules/skill/` | 现有技能服务 |
| 不变 | `backend/src/modules/visualization/` | 现有视觉化服务 |

---

**请确认以上需求是否符合预期，确认后可以开始实施。**
